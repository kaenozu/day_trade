# 会社名が表示されていない銘柄の修正

## 問題の概要
システム実行時に、一部銘柄で会社名が表示されずに銘柄コードのみが表示される問題が発生している。

## 現在の状況

### 影響範囲
- **設定済み銘柄**: 76銘柄全て（`config/settings.json`に会社名が登録済み）
- **表示対象**: 7銘柄のみ会社名表示（ハードコード）
- **未表示銘柄**: 69銘柄で会社名が表示されない

### 現在の出力例
```
│  🚀 BUY推奨 (11銘柄)                                         │
│     • 7203 トヨタ自動車     信頼度: ███████▌▌▌ 75%     │  ✅ 正常
│     • 8001 8001           信頼度: ███████▌▌▌ 75%     │  ❌ 会社名なし
│     • 7267 7267           信頼度: ███████▌▌▌ 75%     │  ❌ 会社名なし
│     • 6861 6861           信頼度: ███████▌▌▌ 75%     │  ❌ 会社名なし
```

### 期待される出力
```
│  🚀 BUY推奨 (11銘柄)                                         │
│     • 7203 トヨタ自動車     信頼度: ███████▌▌▌ 75%     │
│     • 8001 伊藤忠商事       信頼度: ███████▌▌▌ 75%     │
│     • 7267 ホンダ          信頼度: ███████▌▌▌ 75%     │
│     • 6861 キーエンス       信頼度: ███████▌▌▌ 75%     │
```

## 根本原因の分析

### 1. 二重実装問題
- **`application.py`**: 完全な会社名取得機能実装済み（設定ファイルベース）
- **`display_formatter.py`**: 限定的なハードコード実装（7銘柄のみ）

### 2. 優先順位問題
現在のフロー:
```
1. application.py の _display_results() 
2. → display_formatter.py の print_analysis_results()
3. → display_formatter.py の _get_company_name_safe() ← ここで7銘柄のみ対応
```

### 3. ハードコードされた銘柄マッピング
```python
# display_formatter.py:150-158
company_map = {
    '7203': 'トヨタ自動車',      # ✅
    '8306': '三菱UFJ銀行',       # ✅  
    '9984': 'ソフトバンクグループ', # ✅
    '6758': 'ソニー',           # ✅
    '7974': '任天堂',           # ✅
    '4689': 'ヤフー',           # ✅ (実際は Z Holdings)
    '9434': 'ソフトバンク'       # ✅
}
# 残り69銘柄は未対応 → symbol をそのまま返す
```

## 利用可能なリソース

### 設定ファイル（config/settings.json）
76銘柄全ての詳細な会社名データが既に存在:
```json
{
  "code": "8001",
  "name": "伊藤忠商事",
  "group": "商社", 
  "priority": "high"
},
{
  "code": "7267", 
  "name": "ホンダ",
  "group": "自動車",
  "priority": "high"
}
```

### 既存機能（application.py）
```python
def _get_company_name(self, symbol: str) -> str:
    """設定ファイルから会社名を取得"""
    # 完全な実装済み - 76銘柄全対応
```

## 技術的解決方法

### Option A: display_formatter を設定ファイルベースに変更 ⭐ **推奨**
- **pros**: 一元管理、76銘柄全対応、保守性向上
- **cons**: display_formatter.py の修正が必要

### Option B: application.py の _display_results_compact を使用
- **pros**: 既に実装済み
- **cons**: 美しい表示フォーマットが使えない

### Option C: 会社名データを display_formatter に渡す
- **pros**: 最小限の変更
- **cons**: データフロー複雑化

## 実装計画（Option A採用）

### 1. display_formatter.py の修正
```python
def __init__(self):
    self.start_time = time.time()
    self.config = None  # 追加

def _load_config(self):
    """設定ファイルを読み込み"""
    # application.py の _load_config() と同様の実装

def _get_company_name_safe(self, result: Dict[str, Any]) -> str:
    """設定ファイルから会社名を安全に取得"""
    # ハードコードマップ削除
    # 設定ファイルベースの実装に変更
```

### 2. エラーハンドリング強化
- 設定ファイル読み込み失敗時のフォールバック
- 未登録銘柄の適切な処理
- デバッグモード対応

### 3. テスト確認項目
- [ ] 全76銘柄で会社名表示
- [ ] 上場廃止銘柄（9437, 4485）の適切な処理
- [ ] 設定ファイルエラー時のフォールバック
- [ ] 美しい表示フォーマットの維持

## 実装優先度
**高** - ユーザーから明示的に報告された問題

## 影響範囲
- ✅ システム機能: 影響なし（表示のみの問題）
- ✅ パフォーマンス: 影響なし
- ✅ 既存機能: 影響なし
- ⚠️ 表示品質: 大幅改善

## 完了条件
1. 76銘柄全てで「銘柄コード + 会社名」が表示される
2. 美しい表示フォーマットが維持される  
3. エラーハンドリングが適切に動作する
4. 実際のシステム実行で確認済み