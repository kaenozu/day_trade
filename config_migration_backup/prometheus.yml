#==============================================================================
# Prometheus è¨­å®š - Issue #442 Phase 3
# ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ãƒ»ä¿å­˜ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆçµ±åˆè¨­å®š
#==============================================================================

# ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š
global:
  scrape_interval: 15s        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–“éš”
  evaluation_interval: 15s    # ãƒ«ãƒ¼ãƒ«è©•ä¾¡é–“éš”
  external_labels:
    cluster: 'day-trade-prod'
    environment: 'production'

# ã‚¢ãƒ©ãƒ¼ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼è¨­å®š
alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093
      timeout: 10s
      api_version: v2

# ãƒ«ãƒ¼ãƒ«è¨­å®š
rule_files:
  - "alert.rules"
  - "/etc/prometheus/rules/*.yml"

# ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°è¨­å®š
scrape_configs:
  # === Day Trade ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ===
  - job_name: 'day-trade-app'
    static_configs:
      - targets: ['app:8000', 'app:8080']
    scrape_interval: 5s       # HFTç”¨é«˜é »åº¦åé›†
    scrape_timeout: 3s
    metrics_path: /metrics
    honor_labels: true
    params:
      'format': ['prometheus']
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
      - source_labels: [__address__]
        regex: '([^:]+):(.*)'
        target_label: '__address__'
        replacement: '${1}:${2}'
      - target_label: service
        replacement: 'day-trade-app'

  # === OpenTelemetry Collector ===
  - job_name: 'otel-collector'
    static_configs:
      - targets: ['otel-collector:8888', 'otel-collector:8889']
    scrape_interval: 10s
    metrics_path: /metrics
    relabel_configs:
      - target_label: service
        replacement: 'otel-collector'

  # === ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹ ===
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
    scrape_interval: 30s
    relabel_configs:
      - source_labels: [__address__]
        target_label: node
      - target_label: service
        replacement: 'system'

  # === ã‚³ãƒ³ãƒ†ãƒŠãƒ¡ãƒˆãƒªã‚¯ã‚¹ ===
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']
    scrape_interval: 30s
    metrics_path: /metrics
    relabel_configs:
      - target_label: service
        replacement: 'containers'

  # === ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ ===
  - job_name: 'postgres-exporter'
    static_configs:
      - targets: ['postgres-exporter:9187']
    scrape_interval: 30s
    relabel_configs:
      - target_label: service
        replacement: 'database'

  # === Redis ãƒ¡ãƒˆãƒªã‚¯ã‚¹ ===
  - job_name: 'redis-exporter'
    static_configs:
      - targets: ['redis-exporter:9121']
    scrape_interval: 15s
    relabel_configs:
      - target_label: service
        replacement: 'cache'

  # === Elasticsearch ãƒ¡ãƒˆãƒªã‚¯ã‚¹ ===
  - job_name: 'elasticsearch'
    static_configs:
      - targets: ['elasticsearch:9200']
    scrape_interval: 30s
    metrics_path: /_prometheus/metrics
    relabel_configs:
      - target_label: service
        replacement: 'elasticsearch'

  # === Jaeger ãƒ¡ãƒˆãƒªã‚¯ã‚¹ ===
  - job_name: 'jaeger'
    static_configs:
      - targets: ['jaeger-all-in-one:14269']
    scrape_interval: 30s
    metrics_path: /metrics
    relabel_configs:
      - target_label: service
        replacement: 'jaeger'

  # === Grafana ãƒ¡ãƒˆãƒªã‚¯ã‚¹ ===
  - job_name: 'grafana'
    static_configs:
      - targets: ['grafana-apm:3000']
    scrape_interval: 60s
    metrics_path: /metrics
    relabel_configs:
      - target_label: service
        replacement: 'grafana'

  # === Prometheus è‡ªä½“ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ ===
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
    scrape_interval: 30s

  # === Kubernetes ãƒ¡ãƒˆãƒªã‚¯ã‚¹ (Kubernetesç’°å¢ƒã®å ´åˆ) ===
  - job_name: 'kubernetes-apiservers'
    kubernetes_sd_configs:
      - role: endpoints
        namespaces:
          names:
            - default
            - day-trade
    scheme: https
    tls_config:
      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    relabel_configs:
      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
        action: keep
        regex: default;kubernetes;https
      - target_label: service
        replacement: 'kubernetes-api'

  # === HFT ç‰¹åŒ–ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›† ===
  - job_name: 'hft-metrics'
    static_configs:
      - targets: ['app:8001']  # HFTå°‚ç”¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
    scrape_interval: 1s       # 1ç§’é–“éš”ã®è¶…é«˜é »åº¦åé›†
    scrape_timeout: 500ms
    metrics_path: /hft-metrics
    honor_labels: true
    relabel_configs:
      - target_label: service
        replacement: 'hft-trading'
      - target_label: priority
        replacement: 'critical'

  # === ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›† ===
  - job_name: 'business-metrics'
    static_configs:
      - targets: ['app:8002']
    scrape_interval: 10s
    metrics_path: /business-metrics
    relabel_configs:
      - target_label: service
        replacement: 'business'

# === ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­å®š (ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒªãƒ†ã‚£ç”¨) ===
# remote_write:
#   - url: "https://prometheus-remote-storage.example.com/api/v1/write"
#     queue_config:
#       max_samples_per_send: 10000
#       max_shards: 200
#       capacity: 500000

# === ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­å®š ===
storage:
  tsdb:
    # 30æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ä¿æŒ
    retention.time: 30d
    # æœ€å¤§ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚µã‚¤ã‚º
    retention.size: 50GB
    # åœ§ç¸®ãƒ¬ãƒ™ãƒ«
    wal-compression: true

#==============================================================================
# Prometheus ç‰¹åŒ–æ©Ÿèƒ½:
#
# ğŸš€ HFTå¯¾å¿œé«˜é »åº¦åé›†:
#   - 1ç§’é–“éš”ã§ã®é‡è¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†
#   - 500ms ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§ã®ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·
#   - å„ªå…ˆåº¦ãƒ™ãƒ¼ã‚¹ã®ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç®¡ç†
#
# ğŸ“Š åŒ…æ‹¬çš„ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç¯„å›²:
#   - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒˆãƒªã‚¯ã‚¹
#   - ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹
#   - ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ãƒ¡ãƒˆãƒªã‚¯ã‚¹
#   - ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹
#
# ğŸ” æ™ºçš„ãƒ©ãƒ™ãƒªãƒ³ã‚°:
#   - ã‚µãƒ¼ãƒ“ã‚¹åˆ¥ãƒ¡ãƒˆãƒªã‚¯ã‚¹åˆ†é¡
#   - ç’°å¢ƒãƒ»ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æƒ…å ±ä»˜ä¸
#   - å‹•çš„ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ¤œå‡º
#
# âš¡ é«˜æ€§èƒ½è¨­å®š:
#   - WALåœ§ç¸®æœ‰åŠ¹
#   - æœ€é©åŒ–ã•ã‚ŒãŸã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–“éš”
#   - åŠ¹ç‡çš„ãªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç®¡ç†
#
# ğŸš¨ çµ±åˆã‚¢ãƒ©ãƒ¼ãƒˆ:
#   - AlertManageré€£æº
#   - ã‚«ã‚¹ã‚¿ãƒ ãƒ«ãƒ¼ãƒ«é©ç”¨
#   - éšå±¤åŒ–ã‚¢ãƒ©ãƒ¼ãƒˆç®¡ç†
#==============================================================================