# ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè‡ªå‹•è§£æ±ºæ”¯æ´ã‚·ã‚¹ãƒ†ãƒ 
# Issue #883æ‹¡å¼µ: è‡ªå‹•è§£æ±ºå¯èƒ½ãªã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã®æ¤œçŸ¥ã¨æ”¯æ´
name: Conflict Auto Resolver

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-resolve-support:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/resolve-conflicts')
    name: "ğŸ¤– ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè‡ªå‹•è§£æ±ºæ”¯æ´"

    steps:
      - name: Check comment author permissions
        id: check-permissions
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const username = context.payload.comment.user.login;

            try {
              const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner,
                repo,
                username
              });

              const hasPermission = ['admin', 'write'].includes(permission.permission);
              console.log(`User ${username} has permission: ${permission.permission}`);

              return hasPermission;
            } catch (error) {
              console.log(`Error checking permissions: ${error.message}`);
              return false;
            }

      - name: Get PR details
        if: steps.check-permissions.outputs.result == 'true'
        id: pr-details
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.issue.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            return {
              head_ref: pr.head.ref,
              head_sha: pr.head.sha,
              base_ref: pr.base.ref,
              base_sha: pr.base.sha,
              html_url: pr.html_url
            };

      - name: Checkout repository
        if: steps.check-permissions.outputs.result == 'true'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        if: steps.check-permissions.outputs.result == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Analyze conflicts for auto-resolution
        if: steps.check-permissions.outputs.result == 'true'
        id: analyze-conflicts
        run: |
          echo "ğŸ” ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã®è‡ªå‹•è§£æ±ºå¯èƒ½æ€§ã‚’åˆ†æä¸­..."

          PR_DATA='${{ steps.pr-details.outputs.result }}'
          HEAD_REF=$(echo "$PR_DATA" | jq -r '.head_ref')
          BASE_REF=$(echo "$PR_DATA" | jq -r '.base_ref')

          # ãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
          git fetch origin $HEAD_REF:$HEAD_REF
          git fetch origin $BASE_REF:$BASE_REF

          # ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç‰¹å®š
          git checkout $BASE_REF

          AUTO_RESOLVABLE=false
          CONFLICT_FILES=""
          RESOLUTION_STRATEGY=""

          if ! git merge --no-commit --no-ff $HEAD_REF 2>/dev/null; then
            CONFLICT_FILES=$(git diff --name-only --diff-filter=U)
            echo "ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: $CONFLICT_FILES"

            # è‡ªå‹•è§£æ±ºå¯èƒ½æ€§ã®åˆ†æ
            for file in $CONFLICT_FILES; do
              echo "ãƒ•ã‚¡ã‚¤ãƒ«åˆ†æ: $file"

              # ç‰¹å®šã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§è‡ªå‹•è§£æ±ºå¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
              if [[ "$file" == "requirements.txt" ]] || [[ "$file" == "pyproject.toml" ]]; then
                # ä¾å­˜é–¢ä¿‚ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
                if grep -E "^<<<<<<< |^=======$|^>>>>>>> " "$file" | wc -l | grep -q "^[0-9][0-9]*$"; then
                  echo "ä¾å­˜é–¢ä¿‚ãƒ•ã‚¡ã‚¤ãƒ«ã§ã®è‡ªå‹•è§£æ±ºã‚’è©¦è¡Œ"
                  RESOLUTION_STRATEGY="dependencies"
                  AUTO_RESOLVABLE=true
                fi
              elif [[ "$file" == *.py ]]; then
                # Pythonãƒ•ã‚¡ã‚¤ãƒ«ã§ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆé‡è¤‡ãƒã‚§ãƒƒã‚¯
                if grep -A5 -B5 "^<<<<<<< " "$file" | grep -q "^import\|^from.*import"; then
                  echo "ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡ã®ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’æ¤œå‡º"
                  RESOLUTION_STRATEGY="imports"
                  AUTO_RESOLVABLE=true
                fi
              elif [[ "$file" == *.md ]]; then
                # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
                echo "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§ã®è‡ªå‹•è§£æ±ºã‚’è©¦è¡Œ"
                RESOLUTION_STRATEGY="documentation"
                AUTO_RESOLVABLE=true
              fi
            done

            git merge --abort
          else
            echo "ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            git reset --hard HEAD
          fi

          echo "auto_resolvable=$AUTO_RESOLVABLE" >> $GITHUB_OUTPUT
          echo "conflict_files=$CONFLICT_FILES" >> $GITHUB_OUTPUT
          echo "resolution_strategy=$RESOLUTION_STRATEGY" >> $GITHUB_OUTPUT

      - name: Attempt automatic conflict resolution
        if: steps.check-permissions.outputs.result == 'true' && steps.analyze-conflicts.outputs.auto_resolvable == 'true'
        id: auto-resolve
        run: |
          echo "ğŸ¤– è‡ªå‹•ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºã‚’è©¦è¡Œä¸­..."

          PR_DATA='${{ steps.pr-details.outputs.result }}'
          HEAD_REF=$(echo "$PR_DATA" | jq -r '.head_ref')
          BASE_REF=$(echo "$PR_DATA" | jq -r '.base_ref')
          STRATEGY="${{ steps.analyze-conflicts.outputs.resolution_strategy }}"

          git checkout $HEAD_REF

          RESOLUTION_SUCCESS=false
          RESOLUTION_LOG=""

          # ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒãƒ¼ã‚¸
          if ! git merge origin/$BASE_REF --no-commit 2>&1 | tee merge_output.log; then
            # ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒç™ºç”Ÿã—ãŸå ´åˆã®è‡ªå‹•è§£æ±º
            CONFLICT_FILES="${{ steps.analyze-conflicts.outputs.conflict_files }}"

            case "$STRATEGY" in
              "dependencies")
                echo "ä¾å­˜é–¢ä¿‚ãƒ•ã‚¡ã‚¤ãƒ«ã®è‡ªå‹•è§£æ±ºã‚’å®Ÿè¡Œä¸­..."
                for file in $CONFLICT_FILES; do
                  if [[ "$file" == "requirements.txt" ]] || [[ "$file" == "pyproject.toml" ]]; then
                    # ä¸¡æ–¹ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒãƒ¼ã‚¸ã—ã¦é‡è¤‡ã‚’é™¤å»
                    git show :2:"$file" > base_version.tmp 2>/dev/null || touch base_version.tmp
                    git show :3:"$file" > head_version.tmp 2>/dev/null || touch head_version.tmp

                    # ä¾å­˜é–¢ä¿‚ã‚’ãƒãƒ¼ã‚¸ï¼ˆé‡è¤‡é™¤å»ï¼‰
                    cat base_version.tmp head_version.tmp | sort | uniq > "$file"
                    git add "$file"

                    RESOLUTION_LOG="$RESOLUTION_LOG\n- $file: ä¾å­˜é–¢ä¿‚ã‚’ãƒãƒ¼ã‚¸ã—ã¾ã—ãŸ"
                  fi
                done
                RESOLUTION_SUCCESS=true
                ;;

              "imports")
                echo "ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡ã®è‡ªå‹•è§£æ±ºã‚’å®Ÿè¡Œä¸­..."
                for file in $CONFLICT_FILES; do
                  if [[ "$file" == *.py ]]; then
                    # ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡ã®é‡è¤‡ã‚’è§£æ±ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
                    # ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒãƒ¼ã‚«ãƒ¼ã‚’é™¤å»ã—ã€ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡ã‚’çµ±åˆ
                    grep -v "^<<<<<<<\|^=======$\|^>>>>>>>" "$file" | sort | uniq > "${file}.resolved"
                    mv "${file}.resolved" "$file"
                    git add "$file"
                    RESOLUTION_LOG="$RESOLUTION_LOG\n- $file: ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡ã‚’çµ±åˆã—ã¾ã—ãŸ"
                  fi
                done
                RESOLUTION_SUCCESS=true
                ;;

              "documentation")
                echo "ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®è‡ªå‹•è§£æ±ºã‚’å®Ÿè¡Œä¸­..."
                for file in $CONFLICT_FILES; do
                  if [[ "$file" == *.md ]]; then
                    # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å ´åˆã¯ä¸¡æ–¹ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¿æŒ
                    git show :2:"$file" > base_doc.tmp 2>/dev/null || touch base_doc.tmp
                    git show :3:"$file" > head_doc.tmp 2>/dev/null || touch head_doc.tmp

                    # ä¸¡æ–¹ã®å†…å®¹ã‚’ãƒãƒ¼ã‚¸
                    {
                      echo "<!-- ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®å†…å®¹ -->"
                      cat base_doc.tmp
                      echo ""
                      echo "<!-- PRãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®å†…å®¹ -->"
                      cat head_doc.tmp
                    } > "$file"

                    git add "$file"
                    RESOLUTION_LOG="$RESOLUTION_LOG\n- $file: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’çµ±åˆã—ã¾ã—ãŸï¼ˆæ‰‹å‹•ç¢ºèªæ¨å¥¨ï¼‰"
                  fi
                done
                RESOLUTION_SUCCESS=true
                ;;
            esac

            # è§£æ±ºã§ããŸå ´åˆã¯ã‚³ãƒŸãƒƒãƒˆ
            if [ "$RESOLUTION_SUCCESS" = true ]; then
              git commit -m "Auto-resolve merge conflicts

              $RESOLUTION_LOG

              ğŸ¤– è‡ªå‹•è§£æ±º by GitHub Actions"

              # ãƒ—ãƒƒã‚·ãƒ¥
              git push origin $HEAD_REF
            fi
          else
            echo "ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“ã§ã—ãŸ"
            git reset --hard HEAD
          fi

          echo "resolution_success=$RESOLUTION_SUCCESS" >> $GITHUB_OUTPUT
          echo "resolution_log<<EOF" >> $GITHUB_OUTPUT
          echo -e "$RESOLUTION_LOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment resolution result
        if: steps.check-permissions.outputs.result == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const autoResolvable = '${{ steps.analyze-conflicts.outputs.auto_resolvable }}' === 'true';
            const resolutionSuccess = '${{ steps.auto-resolve.outputs.resolution_success }}' === 'true';
            const resolutionLog = `${{ steps.auto-resolve.outputs.resolution_log }}`;
            const conflictFiles = '${{ steps.analyze-conflicts.outputs.conflict_files }}';
            const strategy = '${{ steps.analyze-conflicts.outputs.resolution_strategy }}';

            let body = '';

            if (!autoResolvable) {
              body = `## ğŸ¤– è‡ªå‹•è§£æ±ºåˆ†æçµæœ

              ã“ã®PRã®ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã¯è‡ªå‹•è§£æ±ºã«é©ã—ã¦ã„ã¾ã›ã‚“ã€‚

              **ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«:**
              \`\`\`
              ${conflictFiles}
              \`\`\`

              **æ¨å¥¨å¯¾å¿œ:**
              - æ‰‹å‹•ã§ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’è§£æ±ºã—ã¦ãã ã•ã„
              - è¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯å¤‰æ›´ã‚„è¨­è¨ˆå¤‰æ›´ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™

              **æ‰‹å‹•è§£æ±ºæ‰‹é †:**
              1. \`git checkout ${context.payload.issue.title || 'your-branch'}\`
              2. \`git merge origin/main\` (ã¾ãŸã¯é©åˆ‡ãªãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒ)
              3. ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ‰‹å‹•ç·¨é›†
              4. \`git add .\` && \`git commit\` && \`git push\`
              `;
            } else if (resolutionSuccess) {
              body = `## âœ… è‡ªå‹•ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºå®Œäº†

              ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã®è‡ªå‹•è§£æ±ºãŒæˆåŠŸã—ã¾ã—ãŸï¼

              **è§£æ±ºæˆ¦ç•¥:** ${strategy}
              **è§£æ±ºå†…å®¹:**
              ${resolutionLog}

              **æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:**
              - è‡ªå‹•è§£æ±ºã•ã‚ŒãŸå†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„
              - å¿…è¦ã«å¿œã˜ã¦è¿½åŠ ã®èª¿æ•´ã‚’è¡Œã£ã¦ãã ã•ã„
              - CIãƒã‚§ãƒƒã‚¯ãŒé€šéã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„

              ğŸ¤– *è‡ªå‹•è§£æ±ºæ©Ÿèƒ½ã«ã‚ˆã‚Šå‡¦ç†ã•ã‚Œã¾ã—ãŸ*
              `;
            } else {
              body = `## âš ï¸ è‡ªå‹•è§£æ±ºè©¦è¡Œçµæœ

              è‡ªå‹•è§£æ±ºã‚’è©¦è¡Œã—ã¾ã—ãŸãŒã€å®Œå…¨ã«ã¯è§£æ±ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚

              **æ¤œå‡ºã•ã‚ŒãŸè§£æ±ºæˆ¦ç•¥:** ${strategy}
              **ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«:** ${conflictFiles}

              **æ¨å¥¨å¯¾å¿œ:**
              - ä¸€éƒ¨ãŒè‡ªå‹•è§£æ±ºã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
              - æ®‹ã‚Šã®ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’æ‰‹å‹•ã§è§£æ±ºã—ã¦ãã ã•ã„
              - è‡ªå‹•è§£æ±ºã•ã‚ŒãŸéƒ¨åˆ†ã®å†…å®¹ã‚‚ç¢ºèªã—ã¦ãã ã•ã„
              `;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Unauthorized access response
        if: steps.check-permissions.outputs.result != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ğŸ”’ æ¨©é™ã‚¨ãƒ©ãƒ¼

            ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ãŒã€ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè‡ªå‹•è§£æ±ºæ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

            ã“ã®æ©Ÿèƒ½ã¯ä»¥ä¸‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ä½¿ç”¨ã§ãã¾ã™ï¼š
            - ãƒªãƒã‚¸ãƒˆãƒªã®ç®¡ç†è€… (admin)
            - æ›¸ãè¾¼ã¿æ¨©é™ã‚’æŒã¤ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚¿ãƒ¼ (write)

            æ¨©é™ãŒå¿…è¦ãªå ´åˆã¯ã€ãƒªãƒã‚¸ãƒˆãƒªç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });