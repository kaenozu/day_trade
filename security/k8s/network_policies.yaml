# Issue #800 Phase 5: Kubernetes ネットワークポリシー
# Day Trade ML System マイクロサービス間通信制御

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: day-trade-ml-service-network-policy
  namespace: day-trade
  labels:
    app: day-trade-ml
    service: ml-service
spec:
  podSelector:
    matchLabels:
      app: day-trade-ml
      service: ml-service
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # MLサービスへのアクセス制限
    - from:
        # データサービスからのアクセス許可
        - podSelector:
            matchLabels:
              app: day-trade-ml
              service: data-service
        # スケジューラサービスからのアクセス許可
        - podSelector:
            matchLabels:
              app: day-trade-ml
              service: scheduler-service
        # APIゲートウェイからのアクセス許可
        - podSelector:
            matchLabels:
              app: day-trade-ml
              service: api-gateway
        # 監視サービスからのアクセス許可
        - namespaceSelector:
            matchLabels:
              name: monitoring
      ports:
        - protocol: TCP
          port: 8000
        - protocol: TCP
          port: 8080  # Health check
  egress:
    # MLサービスからの外部アクセス制限
    - to:
        # データベースアクセス
        - podSelector:
            matchLabels:
              app: postgresql
      ports:
        - protocol: TCP
          port: 5432
    - to:
        # Redisキャッシュアクセス
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379
    - to:
        # データサービスへのアクセス
        - podSelector:
            matchLabels:
              app: day-trade-ml
              service: data-service
      ports:
        - protocol: TCP
          port: 8001
    - to:
        # 外部APIアクセス（市場データ等）
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443  # HTTPS
        - protocol: TCP
          port: 80   # HTTP
    - to: []  # DNS解決
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: day-trade-data-service-network-policy
  namespace: day-trade
  labels:
    app: day-trade-ml
    service: data-service
spec:
  podSelector:
    matchLabels:
      app: day-trade-ml
      service: data-service
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # データサービスへのアクセス制限
    - from:
        # MLサービスからのアクセス許可
        - podSelector:
            matchLabels:
              app: day-trade-ml
              service: ml-service
        # スケジューラサービスからのアクセス許可
        - podSelector:
            matchLabels:
              app: day-trade-ml
              service: scheduler-service
        # 監視サービスからのアクセス許可
        - namespaceSelector:
            matchLabels:
              name: monitoring
      ports:
        - protocol: TCP
          port: 8001
        - protocol: TCP
          port: 8080  # Health check
  egress:
    # データサービスからの外部アクセス
    - to:
        # データベースアクセス
        - podSelector:
            matchLabels:
              app: postgresql
      ports:
        - protocol: TCP
          port: 5432
    - to:
        # Redisキャッシュアクセス
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379
    - to:
        # 外部市場データAPIアクセス
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443  # HTTPS
        - protocol: TCP
          port: 80   # HTTP
    - to: []  # DNS解決
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: day-trade-scheduler-service-network-policy
  namespace: day-trade
  labels:
    app: day-trade-ml
    service: scheduler-service
spec:
  podSelector:
    matchLabels:
      app: day-trade-ml
      service: scheduler-service
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # スケジューラサービスへのアクセス制限
    - from:
        # 管理インターフェースからのアクセス許可
        - podSelector:
            matchLabels:
              app: day-trade-ml
              service: admin-interface
        # 監視サービスからのアクセス許可
        - namespaceSelector:
            matchLabels:
              name: monitoring
      ports:
        - protocol: TCP
          port: 8002
        - protocol: TCP
          port: 8080  # Health check
  egress:
    # スケジューラサービスからの外部アクセス
    - to:
        # MLサービスへのタスク実行要求
        - podSelector:
            matchLabels:
              app: day-trade-ml
              service: ml-service
      ports:
        - protocol: TCP
          port: 8000
    - to:
        # データサービスへのアクセス
        - podSelector:
            matchLabels:
              app: day-trade-ml
              service: data-service
      ports:
        - protocol: TCP
          port: 8001
    - to:
        # Redisキャッシュアクセス（タスクキュー）
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379
    - to: []  # DNS解決
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: day-trade-database-network-policy
  namespace: day-trade
  labels:
    app: postgresql
    component: database
spec:
  podSelector:
    matchLabels:
      app: postgresql
  policyTypes:
    - Ingress
  ingress:
    # データベースへのアクセス制限
    - from:
        # MLサービスからのアクセス許可
        - podSelector:
            matchLabels:
              app: day-trade-ml
              service: ml-service
        # データサービスからのアクセス許可
        - podSelector:
            matchLabels:
              app: day-trade-ml
              service: data-service
        # バックアップサービスからのアクセス許可
        - podSelector:
            matchLabels:
              app: day-trade-ml
              service: backup-service
        # 管理ツールからのアクセス許可
        - namespaceSelector:
            matchLabels:
              name: admin
      ports:
        - protocol: TCP
          port: 5432

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: day-trade-redis-network-policy
  namespace: day-trade
  labels:
    app: redis
    component: cache
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
    - Ingress
  ingress:
    # Redisへのアクセス制限
    - from:
        # MLサービスからのアクセス許可
        - podSelector:
            matchLabels:
              app: day-trade-ml
              service: ml-service
        # データサービスからのアクセス許可
        - podSelector:
            matchLabels:
              app: day-trade-ml
              service: data-service
        # スケジューラサービスからのアクセス許可
        - podSelector:
            matchLabels:
              app: day-trade-ml
              service: scheduler-service
        # 認証サービスからのアクセス許可
        - podSelector:
            matchLabels:
              app: day-trade-ml
              service: auth-service
      ports:
        - protocol: TCP
          port: 6379

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: day-trade-monitoring-network-policy
  namespace: day-trade
  labels:
    app: monitoring
    component: observability
spec:
  podSelector:
    matchLabels:
      app: monitoring
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # 監視サービスへのアクセス
    - from:
        # 管理ネットワークからのアクセス許可
        - namespaceSelector:
            matchLabels:
              name: admin
        # アラートマネージャーからのアクセス許可
        - podSelector:
            matchLabels:
              app: alertmanager
      ports:
        - protocol: TCP
          port: 9090  # Prometheus
        - protocol: TCP
          port: 3000  # Grafana
        - protocol: TCP
          port: 9093  # AlertManager
  egress:
    # 監視サービスからの外部アクセス
    - to:
        # 全サービスのメトリクス収集
        - namespaceSelector:
            matchLabels:
              name: day-trade
      ports:
        - protocol: TCP
          port: 8080  # メトリクスエンドポイント
    - to:
        # Slack通知
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443  # HTTPS
    - to: []  # DNS解決
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: day-trade-logging-network-policy
  namespace: day-trade
  labels:
    app: logging
    component: observability
spec:
  podSelector:
    matchLabels:
      app: logging
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # ログ収集サービスへのアクセス
    - from:
        # 全サービスからのログ送信許可
        - namespaceSelector:
            matchLabels:
              name: day-trade
        # 管理ネットワークからのアクセス許可
        - namespaceSelector:
            matchLabels:
              name: admin
      ports:
        - protocol: TCP
          port: 9200  # Elasticsearch
        - protocol: TCP
          port: 5601  # Kibana
        - protocol: TCP
          port: 5044  # Logstash
  egress:
    # ログサービスからの外部アクセス
    - to: []  # DNS解決
      ports:
        - protocol: UDP
          port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: day-trade-external-access-deny
  namespace: day-trade
  labels:
    app: day-trade-ml
    policy: deny-all-external
spec:
  podSelector: {}  # 全Pod対象
  policyTypes:
    - Ingress
    - Egress
  # デフォルト拒否（他のポリシーで明示的に許可されたもの以外）

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: day-trade-ingress-controller-policy
  namespace: day-trade
  labels:
    app: ingress-controller
spec:
  podSelector:
    matchLabels:
      app: ingress-controller
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # 外部からのWebアクセス許可
    - from: []  # 任意のソース
      ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 443
  egress:
    # バックエンドサービスへのプロキシ
    - to:
        - podSelector:
            matchLabels:
              app: day-trade-ml
      ports:
        - protocol: TCP
          port: 8000
        - protocol: TCP
          port: 8001
        - protocol: TCP
          port: 8002
    - to: []  # DNS解決
      ports:
        - protocol: UDP
          port: 53

---
# セキュリティ強化用追加ポリシー
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: day-trade-production-security-policy
  namespace: day-trade
  labels:
    app: day-trade-ml
    security: production
spec:
  podSelector:
    matchLabels:
      environment: production
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # 本番環境では厳格な制限
    - from:
        # 認証済みサービスのみ
        - podSelector:
            matchLabels:
              authenticated: "true"
        # セキュアネームスペースのみ
        - namespaceSelector:
            matchLabels:
              security-level: "high"
      ports:
        - protocol: TCP
          port: 8000
        - protocol: TCP
          port: 8001
        - protocol: TCP
          port: 8002
  egress:
    # 必要最小限の外部アクセス
    - to:
        # 内部サービスのみ
        - namespaceSelector:
            matchLabels:
              name: day-trade
      ports:
        - protocol: TCP
          port: 5432  # PostgreSQL
        - protocol: TCP
          port: 6379  # Redis
    - to:
        # 承認された外部APIのみ
        - namespaceSelector:
            matchLabels:
              name: external-apis
      ports:
        - protocol: TCP
          port: 443  # HTTPS only

---
# DDoS保護ポリシー
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: day-trade-ddos-protection-policy
  namespace: day-trade
  labels:
    app: day-trade-ml
    protection: ddos
spec:
  podSelector:
    matchLabels:
      app: day-trade-ml
      public-facing: "true"
  policyTypes:
    - Ingress
  ingress:
    # レート制限（実装はIngress Controllerで）
    - from:
        # CDN/Load Balancerからのみ
        - namespaceSelector:
            matchLabels:
              name: load-balancer
      ports:
        - protocol: TCP
          port: 80
        - protocol: TCP
          port: 443