"""
APM„Éª„Ç™„Éñ„Ç∂„Éº„Éê„Éì„É™„ÉÜ„Ç£Áµ±ÂêàÂü∫Áõ§ - Issue #442 Phase 3
ÂãïÁöÑ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁîüÊàê„ÉªSLOÂèØË¶ñÂåñ„Éª„Ç§„É≥„ÉÜ„É™„Ç∏„Çß„É≥„Éà„Ç¢„É©„Éº„Éà

„Åì„ÅÆ„É¢„Ç∏„É•„Éº„É´„ÅØ‰ª•‰∏ã„ÇíÊèê‰æõ„Åó„Åæ„Åô:
- Grafana„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÂãïÁöÑÁîüÊàê
- SLO/SLIÂèØË¶ñÂåñ
- HFTÂ∞ÇÁî®„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ
- „Ç´„Çπ„Çø„É†„É°„Éà„É™„ÇØ„ÇπË°®Á§∫
"""

import json
import os
from dataclasses import dataclass, field
from datetime import datetime, timezone
from enum import Enum
from typing import Any, Dict, List, Optional, Tuple


class DashboardType(Enum):
    """„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Çø„Ç§„Éó"""

    HFT_TRADING = "hft_trading"
    SYSTEM_OVERVIEW = "system_overview"
    SLO_MONITORING = "slo_monitoring"
    SECURITY_MONITORING = "security_monitoring"
    BUSINESS_METRICS = "business_metrics"
    ERROR_ANALYSIS = "error_analysis"


class PanelType(Enum):
    """„Éë„Éç„É´„Çø„Ç§„Éó"""

    GRAPH = "graph"
    STAT = "stat"
    TABLE = "table"
    HEATMAP = "heatmap"
    GAUGE = "gauge"
    BAR_GAUGE = "bargauge"
    PIE_CHART = "piechart"
    ALERT_LIST = "alertlist"
    TEXT = "text"
    LOGS = "logs"
    NODE_GRAPH = "nodeGraph"


@dataclass
class PanelConfig:
    """„Éë„Éç„É´Ë®≠ÂÆö"""

    title: str
    panel_type: PanelType
    targets: List[Dict[str, Any]]
    x: int = 0
    y: int = 0
    width: int = 12
    height: int = 8
    datasource: str = "Prometheus"
    options: Dict[str, Any] = field(default_factory=dict)
    field_config: Dict[str, Any] = field(default_factory=dict)
    transformations: List[Dict[str, Any]] = field(default_factory=list)


class DashboardGenerator:
    """
    ÂãïÁöÑ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁîüÊàê„ÇØ„É©„Çπ

    Features:
    - „ÉÜ„É≥„Éó„É¨„Éº„Éà„Éô„Éº„ÇπÁîüÊàê
    - SLO/SLIÂ∞ÇÁî®„Éë„Éç„É´
    - HFTÊúÄÈÅ©ÂåñË°®Á§∫
    - „É™„Ç¢„É´„Çø„Ç§„É†„Ç¢„É©„Éº„ÉàÁµ±Âêà
    """

    def __init__(self, base_path: str = "/var/lib/grafana/dashboards"):
        self.base_path = base_path
        self.panel_id_counter = 1

    def _get_next_panel_id(self) -> int:
        """Ê¨°„ÅÆ„Éë„Éç„É´IDÂèñÂæó"""
        panel_id = self.panel_id_counter
        self.panel_id_counter += 1
        return panel_id

    def _create_base_dashboard(
        self,
        title: str,
        dashboard_type: DashboardType,
        tags: List[str] = None,
        refresh: str = "5s",
    ) -> Dict[str, Any]:
        """Âü∫Êú¨„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÊßãÈÄ†‰ΩúÊàê"""
        return {
            "dashboard": {
                "id": None,
                "title": title,
                "tags": tags or [dashboard_type.value],
                "style": "dark",
                "timezone": "UTC",
                "refresh": refresh,
                "schemaVersion": 39,
                "version": 1,
                "time": {"from": "now-1h", "to": "now"},
                "timepicker": {
                    "refresh_intervals": [
                        "5s",
                        "10s",
                        "30s",
                        "1m",
                        "5m",
                        "15m",
                        "30m",
                        "1h",
                        "2h",
                        "1d",
                    ],
                    "time_options": [
                        "5m",
                        "15m",
                        "1h",
                        "6h",
                        "12h",
                        "24h",
                        "2d",
                        "7d",
                        "30d",
                    ],
                },
                "templating": {"list": self._create_template_variables()},
                "annotations": {"list": self._create_annotations()},
                "panels": [],
                "editable": True,
                "fiscalYearStartMonth": 0,
                "graphTooltip": 1,
                "links": [],
                "liveNow": True,  # HFTÁî®„É™„Ç¢„É´„Çø„Ç§„É†Ë°®Á§∫
                "weekStart": "",
            },
            "overwrite": True,
        }

    def _create_template_variables(self) -> List[Dict[str, Any]]:
        """„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂ§âÊï∞‰ΩúÊàê"""
        return [
            {
                "name": "service",
                "type": "query",
                "datasource": "Prometheus",
                "query": "label_values(up, job)",
                "refresh": 1,
                "regex": "",
                "sort": 1,
                "multi": True,
                "includeAll": True,
                "allValue": ".*",
            },
            {
                "name": "instance",
                "type": "query",
                "datasource": "Prometheus",
                "query": 'label_values(up{job=~"$service"}, instance)',
                "refresh": 1,
                "regex": "",
                "sort": 1,
                "multi": True,
                "includeAll": True,
                "allValue": ".*",
            },
            {
                "name": "symbol",
                "type": "query",
                "datasource": "Prometheus",
                "query": "label_values(day_trade_trades_total, symbol)",
                "refresh": 1,
                "regex": "",
                "sort": 1,
                "multi": True,
                "includeAll": True,
                "allValue": ".*",
            },
            {
                "name": "timerange",
                "type": "interval",
                "query": "5s,10s,30s,1m,5m,15m,30m,1h",
                "current": {"text": "30s", "value": "30s"},
            },
        ]

    def _create_annotations(self) -> List[Dict[str, Any]]:
        """„Ç¢„Éé„ÉÜ„Éº„Ç∑„Éß„É≥Ë®≠ÂÆö‰ΩúÊàê"""
        return [
            {
                "name": "Alerts",
                "datasource": "AlertManager",
                "enable": True,
                "iconColor": "red",
                "query": "",
                "showIn": 0,
                "tags": [],
                "type": "dashboard",
            },
            {
                "name": "Deployments",
                "datasource": "Prometheus",
                "enable": True,
                "expr": "changes(up[5m]) > 0",
                "iconColor": "green",
                "showIn": 0,
                "step": "1m",
                "tags": ["deployment"],
                "titleFormat": "Deployment",
                "type": "prometheus",
            },
        ]

    def _create_panel(self, config: PanelConfig) -> Dict[str, Any]:
        """„Éë„Éç„É´‰ΩúÊàê"""
        panel = {
            "id": self._get_next_panel_id(),
            "title": config.title,
            "type": config.panel_type.value,
            "datasource": {
                "type": (
                    "prometheus"
                    if config.datasource == "Prometheus"
                    else config.datasource.lower()
                ),
                "uid": config.datasource.lower(),
            },
            "gridPos": {
                "h": config.height,
                "w": config.width,
                "x": config.x,
                "y": config.y,
            },
            "targets": config.targets,
            "options": config.options,
            "fieldConfig": config.field_config,
            "transformations": config.transformations,
        }

        return panel

    # === HFT„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁîüÊàê ===

    def create_hft_dashboard(self) -> Dict[str, Any]:
        """HFTÂ∞ÇÁî®„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ‰ΩúÊàê"""
        dashboard = self._create_base_dashboard(
            "üöÄ HFT Trading Performance",
            DashboardType.HFT_TRADING,
            ["hft", "trading", "performance"],
            "1s",  # 1ÁßíÊõ¥Êñ∞
        )

        panels = []
        y_pos = 0

        # === „Éà„ÉÉ„ÉóÁµ±Ë®à„Éë„Éç„É´ ===
        stats_panels = [
            # ÂèñÂºï„É¨„Ç§„ÉÜ„É≥„Ç∑ (P99)
            PanelConfig(
                title="Trade Latency P99",
                panel_type=PanelType.STAT,
                targets=[
                    {
                        "expr": "histogram_quantile(0.99, rate(day_trade_trade_latency_microseconds_bucket[30s]))",
                        "legendFormat": "P99 Latency",
                        "refId": "A",
                    }
                ],
                x=0,
                y=y_pos,
                width=6,
                height=4,
                options={
                    "reduceOptions": {"values": False, "calcs": ["lastNotNull"]},
                    "orientation": "auto",
                    "textMode": "auto",
                    "colorMode": "background",
                    "graphMode": "area",
                    "justifyMode": "auto",
                },
                field_config={
                    "defaults": {
                        "unit": "¬µs",
                        "min": 0,
                        "max": 100,
                        "thresholds": {
                            "steps": [
                                {"color": "green", "value": None},
                                {"color": "yellow", "value": 20},
                                {"color": "red", "value": 50},
                            ]
                        },
                    }
                },
            ),
            # ÂèñÂºïÊàêÂäüÁéá
            PanelConfig(
                title="Trade Success Rate",
                panel_type=PanelType.STAT,
                targets=[
                    {
                        "expr": '(rate(day_trade_trades_total{status="success"}[1m]) / rate(day_trade_trades_total[1m])) * 100',
                        "legendFormat": "Success Rate",
                        "refId": "A",
                    }
                ],
                x=6,
                y=y_pos,
                width=6,
                height=4,
                options={
                    "reduceOptions": {"values": False, "calcs": ["lastNotNull"]},
                    "colorMode": "background",
                },
                field_config={
                    "defaults": {
                        "unit": "percent",
                        "min": 95,
                        "max": 100,
                        "thresholds": {
                            "steps": [
                                {"color": "red", "value": None},
                                {"color": "yellow", "value": 99.9},
                                {"color": "green", "value": 99.95},
                            ]
                        },
                    }
                },
            ),
            # „Çπ„É´„Éº„Éó„ÉÉ„Éà
            PanelConfig(
                title="Trading Throughput",
                panel_type=PanelType.STAT,
                targets=[
                    {
                        "expr": "rate(day_trade_trades_total[30s])",
                        "legendFormat": "Trades/sec",
                        "refId": "A",
                    }
                ],
                x=12,
                y=y_pos,
                width=6,
                height=4,
                options={"colorMode": "background"},
                field_config={
                    "defaults": {
                        "unit": "ops",
                        "thresholds": {
                            "steps": [
                                {"color": "red", "value": None},
                                {"color": "yellow", "value": 100},
                                {"color": "green", "value": 1000},
                            ]
                        },
                    }
                },
            ),
            # P&L
            PanelConfig(
                title="Current P&L",
                panel_type=PanelType.STAT,
                targets=[
                    {
                        "expr": "increase(day_trade_pnl_dollars_sum[5m])",
                        "legendFormat": "P&L (5m)",
                        "refId": "A",
                    }
                ],
                x=18,
                y=y_pos,
                width=6,
                height=4,
                options={"colorMode": "background"},
                field_config={
                    "defaults": {
                        "unit": "currencyUSD",
                        "thresholds": {
                            "steps": [
                                {"color": "red", "value": -1000},
                                {"color": "yellow", "value": 0},
                                {"color": "green", "value": 1000},
                            ]
                        },
                    }
                },
            ),
        ]

        panels.extend([self._create_panel(panel) for panel in stats_panels])
        y_pos += 4

        # === „É¨„Ç§„ÉÜ„É≥„Ç∑Ë©≥Á¥∞ÂàÜÊûê ===
        latency_panels = [
            PanelConfig(
                title="Trade Execution Latency Distribution",
                panel_type=PanelType.HEATMAP,
                targets=[
                    {
                        "expr": "rate(day_trade_trade_latency_microseconds_bucket[1m])",
                        "format": "heatmap",
                        "legendFormat": "{{le}}",
                        "refId": "A",
                    }
                ],
                x=0,
                y=y_pos,
                width=12,
                height=8,
                options={
                    "yAxis": {"unit": "¬µs"},
                    "color": {"mode": "spectrum"},
                    "calculate": True,
                },
            ),
            PanelConfig(
                title="Latency Percentiles",
                panel_type=PanelType.GRAPH,
                targets=[
                    {
                        "expr": "histogram_quantile(0.50, rate(day_trade_trade_latency_microseconds_bucket[30s]))",
                        "legendFormat": "P50",
                        "refId": "A",
                    },
                    {
                        "expr": "histogram_quantile(0.95, rate(day_trade_trade_latency_microseconds_bucket[30s]))",
                        "legendFormat": "P95",
                        "refId": "B",
                    },
                    {
                        "expr": "histogram_quantile(0.99, rate(day_trade_trade_latency_microseconds_bucket[30s]))",
                        "legendFormat": "P99",
                        "refId": "C",
                    },
                    {
                        "expr": "histogram_quantile(0.999, rate(day_trade_trade_latency_microseconds_bucket[30s]))",
                        "legendFormat": "P99.9",
                        "refId": "D",
                    },
                ],
                x=12,
                y=y_pos,
                width=12,
                height=8,
                field_config={
                    "defaults": {
                        "unit": "¬µs",
                        "custom": {
                            "drawStyle": "line",
                            "lineWidth": 2,
                            "fillOpacity": 10,
                        },
                    }
                },
            ),
        ]

        panels.extend([self._create_panel(panel) for panel in latency_panels])
        y_pos += 8

        # === „Ç∑„Çπ„ÉÜ„É†„É™„ÇΩ„Éº„ÇπÁõ£Ë¶ñ ===
        system_panels = [
            PanelConfig(
                title="CPU Usage",
                panel_type=PanelType.GRAPH,
                targets=[
                    {
                        "expr": '100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle", instance=~"$instance"}[5m])) * 100)',
                        "legendFormat": "CPU {{instance}}",
                        "refId": "A",
                    }
                ],
                x=0,
                y=y_pos,
                width=8,
                height=6,
                field_config={"defaults": {"unit": "percent", "min": 0, "max": 100}},
            ),
            PanelConfig(
                title="Memory Usage",
                panel_type=PanelType.GRAPH,
                targets=[
                    {
                        "expr": "((node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes) * 100",
                        "legendFormat": "Memory {{instance}}",
                        "refId": "A",
                    }
                ],
                x=8,
                y=y_pos,
                width=8,
                height=6,
                field_config={"defaults": {"unit": "percent", "min": 0, "max": 100}},
            ),
            PanelConfig(
                title="Network I/O",
                panel_type=PanelType.GRAPH,
                targets=[
                    {
                        "expr": 'rate(node_network_receive_bytes_total{instance=~"$instance"}[5m])',
                        "legendFormat": "RX {{device}}",
                        "refId": "A",
                    },
                    {
                        "expr": '-rate(node_network_transmit_bytes_total{instance=~"$instance"}[5m])',
                        "legendFormat": "TX {{device}}",
                        "refId": "B",
                    },
                ],
                x=16,
                y=y_pos,
                width=8,
                height=6,
                field_config={"defaults": {"unit": "Bps"}},
            ),
        ]

        panels.extend([self._create_panel(panel) for panel in system_panels])

        dashboard["dashboard"]["panels"] = panels
        return dashboard

    # === SLO„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁîüÊàê ===

    def create_slo_dashboard(self) -> Dict[str, Any]:
        """SLO/SLIÁõ£Ë¶ñ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ‰ΩúÊàê"""
        dashboard = self._create_base_dashboard(
            "üìä SLO/SLI Monitoring",
            DashboardType.SLO_MONITORING,
            ["slo", "sli", "monitoring"],
            "30s",
        )

        panels = []
        y_pos = 0

        # SLOÊ¶ÇË¶ÅÁµ±Ë®à
        slo_stats = [
            PanelConfig(
                title="Trade Latency SLO",
                panel_type=PanelType.GAUGE,
                targets=[
                    {
                        "expr": '(rate(day_trade_trades_total{latency_bucket="le_50"}[5m]) / rate(day_trade_trades_total[5m])) * 100',
                        "refId": "A",
                    }
                ],
                x=0,
                y=y_pos,
                width=6,
                height=6,
                options={
                    "reduceOptions": {"calcs": ["lastNotNull"]},
                    "orientation": "auto",
                    "displayMode": "basic",
                },
                field_config={
                    "defaults": {
                        "unit": "percent",
                        "min": 99,
                        "max": 100,
                        "thresholds": {
                            "steps": [
                                {"color": "red", "value": None},
                                {"color": "yellow", "value": 99.9},
                                {"color": "green", "value": 99.95},
                            ]
                        },
                    }
                },
            )
        ]

        panels.extend([self._create_panel(panel) for panel in slo_stats])

        dashboard["dashboard"]["panels"] = panels
        return dashboard

    # === „Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁîüÊàê ===

    def create_security_dashboard(self) -> Dict[str, Any]:
        """„Çª„Ç≠„É•„É™„ÉÜ„Ç£Áõ£Ë¶ñ„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ‰ΩúÊàê"""
        dashboard = self._create_base_dashboard(
            "üõ°Ô∏è Security Monitoring",
            DashboardType.SECURITY_MONITORING,
            ["security", "monitoring"],
            "15s",
        )

        panels = []
        y_pos = 0

        # „Çª„Ç≠„É•„É™„ÉÜ„Ç£„É°„Éà„É™„ÇØ„Çπ
        security_panels = [
            PanelConfig(
                title="Authentication Failures",
                panel_type=PanelType.GRAPH,
                targets=[
                    {
                        "expr": "rate(day_trade_auth_failures_total[5m])",
                        "legendFormat": "Auth failures/sec",
                        "refId": "A",
                    }
                ],
                x=0,
                y=y_pos,
                width=12,
                height=6,
                field_config={"defaults": {"unit": "ops"}},
            ),
            PanelConfig(
                title="Suspicious Activities",
                panel_type=PanelType.TABLE,
                targets=[
                    {
                        "expr": 'topk(10, rate(day_trade_requests_total{status=~"4.."}[5m]))',
                        "format": "table",
                        "instant": True,
                        "refId": "A",
                    }
                ],
                x=12,
                y=y_pos,
                width=12,
                height=6,
            ),
        ]

        panels.extend([self._create_panel(panel) for panel in security_panels])

        dashboard["dashboard"]["panels"] = panels
        return dashboard

    # === „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ‰øùÂ≠ò ===

    def save_dashboard(self, dashboard: Dict[str, Any], filename: str) -> str:
        """„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ‰øùÂ≠ò"""
        filepath = os.path.join(self.base_path, f"{filename}.json")

        # „Éá„Ç£„É¨„ÇØ„Éà„É™‰ΩúÊàê
        os.makedirs(os.path.dirname(filepath), exist_ok=True)

        # „É°„Çø„Éá„Éº„ÇøËøΩÂä†
        dashboard["dashboard"]["meta"] = {
            "type": "db",
            "canSave": True,
            "canEdit": True,
            "canAdmin": True,
            "canStar": True,
            "slug": filename.replace("_", "-"),
            "expires": "0001-01-01T00:00:00Z",
            "created": datetime.now(timezone.utc).isoformat(),
            "updated": datetime.now(timezone.utc).isoformat(),
            "updatedBy": "admin",
            "createdBy": "dashboard-generator",
            "version": 1,
        }

        # JSON‰øùÂ≠ò
        with open(filepath, "w", encoding="utf-8") as f:
            json.dump(dashboard, f, indent=2, ensure_ascii=False)

        return filepath

    def generate_all_dashboards(self) -> List[str]:
        """ÂÖ®„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÁîüÊàê"""
        generated_files = []

        # HFT„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ
        hft_dashboard = self.create_hft_dashboard()
        hft_path = self.save_dashboard(hft_dashboard, "hft_trading_performance")
        generated_files.append(hft_path)

        # SLO„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ
        slo_dashboard = self.create_slo_dashboard()
        slo_path = self.save_dashboard(slo_dashboard, "slo_monitoring")
        generated_files.append(slo_path)

        # „Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ
        security_dashboard = self.create_security_dashboard()
        security_path = self.save_dashboard(security_dashboard, "security_monitoring")
        generated_files.append(security_path)

        return generated_files


# ‰æøÂà©Èñ¢Êï∞
def generate_dashboards(output_dir: str = None) -> List[str]:
    """„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ‰∏ÄÊã¨ÁîüÊàê"""
    if output_dir is None:
        output_dir = os.path.join(
            os.path.dirname(__file__),
            "..",
            "..",
            "..",
            "config",
            "grafana",
            "dashboards",
        )

    generator = DashboardGenerator(output_dir)
    return generator.generate_all_dashboards()


if __name__ == "__main__":
    # ÂÆüË°å‰æã
    generated = generate_dashboards()
    print(f"Generated {len(generated)} dashboards:")
    for path in generated:
        print(f"  - {path}")
