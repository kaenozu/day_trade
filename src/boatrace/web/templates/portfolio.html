{% extends "base.html" %}

{% block title %}ポートフォリオ - Boatrace予想システム{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="fas fa-chart-line"></i> ポートフォリオダッシュボード</h1>
        <p class="text-muted">投資成績・リスク分析・パフォーマンス追跡</p>
    </div>
</div>

<!-- 収支サマリー -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title text-muted">初期資金</h6>
                <h4>¥{{ "{:,.0f}".format(balance.initial_capital) }}</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title text-muted">現在残高</h6>
                <h4 class="{% if balance.current_balance >= balance.initial_capital %}text-success{% else %}text-danger{% endif %}">
                    ¥{{ "{:,.0f}".format(balance.current_balance) }}
                </h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title text-muted">累計損益</h6>
                <h4 class="{% if balance.net_profit >= 0 %}text-success{% else %}text-danger{% endif %}">
                    ¥{{ "{:+,.0f}".format(balance.net_profit) }}
                </h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <h6 class="card-title text-muted">ROI</h6>
                <h4 class="{% if balance.roi >= 0 %}text-success{% else %}text-danger{% endif %}">
                    {{ "{:+.2f}".format(balance.roi) }}%
                </h4>
            </div>
        </div>
    </div>
</div>

<!-- パフォーマンス指標 -->
{% if performance and 'error' not in performance %}
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-area"></i> パフォーマンス指標 ({{ performance.period }})</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center p-3 border rounded">
                            <h6 class="text-muted">平均日次リターン</h6>
                            <h4 class="{% if performance.average_daily_return >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {{ "{:+.3f}".format(performance.average_daily_return) }}%
                            </h4>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3 border rounded">
                            <h6 class="text-muted">シャープレシオ</h6>
                            <h4 class="{% if performance.sharpe_ratio >= 0 %}text-success{% else %}text-danger{% endif %}">
                                {{ "{:.3f}".format(performance.sharpe_ratio) }}
                            </h4>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center p-3 border rounded">
                            <h6 class="text-muted">最大ドローダウン</h6>
                            <h4 class="text-danger">
                                -{{ "{:.2f}".format(performance.max_drawdown) }}%
                            </h4>
                        </div>
                    </div>
                </div>
                
                <hr>
                
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <small class="text-muted">勝率</small>
                            <div><strong>{{ "{:.2f}".format(performance.win_rate) }}%</strong></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <small class="text-muted">ボラティリティ</small>
                            <div><strong>{{ "{:.3f}".format(performance.volatility) }}%</strong></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <small class="text-muted">最高日</small>
                            <div><strong class="text-success">+{{ "{:.2f}".format(performance.best_day) }}%</strong></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <small class="text-muted">最悪日</small>
                            <div><strong class="text-danger">{{ "{:.2f}".format(performance.worst_day) }}%</strong></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- リスク分析 -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-shield-alt"></i> リスク分析</h6>
            </div>
            <div class="card-body">
                {% if risk_analysis and 'error' not in risk_analysis %}
                    <div class="mb-3">
                        <label class="form-label">総合リスクレベル</label>
                        <div>
                            <span class="badge 
                                {% if risk_analysis.overall_risk_level == '低' %}bg-success
                                {% elif risk_analysis.overall_risk_level == '中' %}bg-warning
                                {% else %}bg-danger{% endif %} fs-6">
                                {{ risk_analysis.overall_risk_level }}
                            </span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">資金使用率</label>
                        <div class="progress">
                            <div class="progress-bar 
                                {% if risk_analysis.capital_utilization <= 50 %}bg-success
                                {% elif risk_analysis.capital_utilization <= 80 %}bg-warning
                                {% else %}bg-danger{% endif %}"
                                 style="width: {{ risk_analysis.capital_utilization }}%">
                                {{ "{:.1f}".format(risk_analysis.capital_utilization) }}%
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">VaR (5%)</label>
                        <div><strong class="text-danger">{{ "{:.3f}".format(performance.var_5_percent) }}%</strong></div>
                    </div>
                    
                    <!-- 推奨事項 -->
                    <div class="mt-3">
                        <h6>推奨事項</h6>
                        <ul class="list-unstyled">
                            {% for rec in risk_analysis.recommendations %}
                            <li class="mb-1">
                                <i class="fas fa-arrow-right text-primary me-1"></i>
                                <small>{{ rec }}</small>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% else %}
                    <p class="text-muted">リスク分析データが不足しています</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 戦略別成績 -->
{% if strategy_performance %}
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chess"></i> 戦略別成績</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>戦略</th>
                                <th>投票数</th>
                                <th>ROI</th>
                                <th>勝率</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for strategy in strategy_performance[:10] %}
                            <tr>
                                <td>{{ strategy.strategy }}</td>
                                <td>{{ strategy.bets }}</td>
                                <td class="{% if strategy.roi >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    {{ "{:+.2f}".format(strategy.roi) }}%
                                </td>
                                <td>{{ "{:.1f}".format(strategy.hit_rate) }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 最近の投票履歴 -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> 最近の投票履歴</h5>
            </div>
            <div class="card-body">
                {% if recent_tickets %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>日時</th>
                                <th>種別</th>
                                <th>金額</th>
                                <th>結果</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ticket in recent_tickets %}
                            <tr>
                                <td>
                                    <small>{{ ticket.purchased_at.strftime('%m/%d %H:%M') if ticket.purchased_at else '-' }}</small>
                                </td>
                                <td>{{ ticket.bet_type }}</td>
                                <td>¥{{ "{:,.0f}".format(ticket.amount) }}</td>
                                <td>
                                    {% if ticket.is_hit is none %}
                                        <span class="badge bg-warning">未確定</span>
                                    {% elif ticket.is_hit %}
                                        <span class="badge bg-success">的中</span>
                                    {% else %}
                                        <span class="badge bg-danger">不的中</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center">投票履歴がありません</p>
                {% endif %}
                
                <div class="text-center mt-3">
                    <a href="{{ url_for('betting_interface') }}" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i> 新規投票
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- パフォーマンスチャート -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> パフォーマンス推移</h5>
            </div>
            <div class="card-body">
                <canvas id="performanceChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- 詳細レポート -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-file-alt"></i> 詳細レポート</h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="generateMonthlyReport()">
                        <i class="fas fa-download"></i> 月次レポート
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="exportCSV()">
                        <i class="fas fa-file-csv"></i> CSV出力
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6>投資サマリー</h6>
                        <ul class="list-unstyled">
                            <li>総投資額: ¥{{ "{:,.0f}".format(balance.total_invested) }}</li>
                            <li>総回収額: ¥{{ "{:,.0f}".format(balance.total_return) }}</li>
                            <li>回収率: {{ "{:.2f}".format((balance.total_return / balance.total_invested * 100) if balance.total_invested > 0 else 0) }}%</li>
                            <li>確定投票: {{ balance.confirmed_bets }}件</li>
                            <li>未確定投票: {{ balance.pending_bets }}件</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6>リスク指標</h6>
                        {% if performance and 'error' not in performance %}
                        <ul class="list-unstyled">
                            <li>取引日数: {{ performance.trading_days }}日</li>
                            <li>ボラティリティ: {{ "{:.3f}".format(performance.volatility) }}%</li>
                            <li>最大ドローダウン: -{{ "{:.2f}".format(performance.max_drawdown) }}%</li>
                            <li>VaR (5%): {{ "{:.3f}".format(performance.var_5_percent) }}%</li>
                        </ul>
                        {% else %}
                        <p class="text-muted">データ不足</p>
                        {% endif %}
                    </div>
                    <div class="col-md-4">
                        <h6>ベンチマーク比較</h6>
                        <ul class="list-unstyled">
                            <li>シャープレシオ: 
                                {% if performance and 'error' not in performance %}
                                    {{ "{:.3f}".format(performance.sharpe_ratio) }}
                                {% else %}
                                    -
                                {% endif %}
                            </li>
                            <li>勝率: 
                                {% if performance and 'error' not in performance %}
                                    {{ "{:.2f}".format(performance.win_rate) }}%
                                {% else %}
                                    -
                                {% endif %}
                            </li>
                            <li>平均リターン: 
                                {% if performance and 'error' not in performance %}
                                    {{ "{:+.3f}".format(performance.average_daily_return) }}%
                                {% else %}
                                    -
                                {% endif %}
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// パフォーマンスチャート
const ctx = document.getElementById('performanceChart').getContext('2d');
const chart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [], // 日付データ
        datasets: [{
            label: '累積収益率',
            data: [], // 収益率データ
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.1)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value + '%';
                    }
                }
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return '収益率: ' + context.parsed.y.toFixed(2) + '%';
                    }
                }
            }
        }
    }
});

// 仮データでチャート初期化（実際は動的にデータ取得）
updatePerformanceChart();

function updatePerformanceChart() {
    // 過去30日のダミーデータ
    const dates = [];
    const returns = [];
    let cumulative = 0;
    
    for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        dates.push(date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }));
        
        // ランダムな日次リターン（デモ用）
        const dailyReturn = (Math.random() - 0.5) * 4; // -2% to +2%
        cumulative += dailyReturn;
        returns.push(cumulative);
    }
    
    chart.data.labels = dates;
    chart.data.datasets[0].data = returns;
    chart.update();
}

// 月次レポート生成
function generateMonthlyReport() {
    const year = new Date().getFullYear();
    const month = new Date().getMonth() + 1;
    
    // 将来実装: サーバーサイドでレポート生成
    alert(`${year}年${month}月の月次レポートを生成します\n（今後実装予定）`);
}

// CSV出力
function exportCSV() {
    // 将来実装: 投票履歴のCSV出力
    alert('CSV出力機能は今後実装予定です');
}

// 定期的なデータ更新（10分毎）
setInterval(() => {
    // 将来実装: リアルタイムデータ更新
    console.log('Updating portfolio data...');
}, 600000);
</script>
{% endblock %}