{% extends "base.html" %}

{% block title %}{{ analysis.stadium.name if analysis else '競技場詳細' }} - Boatrace予想システム{% endblock %}

{% block content %}
{% if analysis %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">ダッシュボード</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('stadiums_list') }}">競技場一覧</a></li>
                <li class="breadcrumb-item active">{{ analysis.stadium.name }}</li>
            </ol>
        </nav>
        
        <h1>
            <span class="badge bg-primary me-3">{{ analysis.stadium.number }}</span>
            {{ analysis.stadium.name }}
        </h1>
        <p class="text-muted">{{ analysis.stadium.prefecture }}・詳細分析</p>
    </div>
</div>

<!-- 基本情報 -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> 競技場情報</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <th width="120">競技場名</th>
                                <td>{{ analysis.stadium.name }}</td>
                            </tr>
                            <tr>
                                <th>所在地</th>
                                <td>{{ analysis.stadium.prefecture }}</td>
                            </tr>
                            <tr>
                                <th>競技場番号</th>
                                <td>{{ analysis.stadium.number }}場</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <th width="120">水質</th>
                                <td>
                                    {% if analysis.characteristics.water_type == 'sea' %}
                                        <span class="badge bg-info">海水</span>
                                    {% elif analysis.characteristics.water_type == 'fresh' %}
                                        <span class="badge bg-success">淡水</span>
                                    {% else %}
                                        <span class="badge bg-secondary">汽水</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>潮汐影響</th>
                                <td>
                                    {% if analysis.characteristics.is_tidal %}
                                        <i class="fas fa-check text-success"></i> あり
                                    {% else %}
                                        <i class="fas fa-times text-muted"></i> なし
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>平均風速</th>
                                <td>{{ analysis.characteristics.average_wind_speed or '-' }}m/s</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 本日の状況 -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-calendar-day"></i> 本日の状況</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary">{{ today_races|length }}</h4>
                        <small class="text-muted">レース数</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">{{ today_races|selectattr('has_prediction')|list|length }}</h4>
                        <small class="text-muted">予想完了</small>
                    </div>
                </div>
                
                <hr>
                
                <div class="d-grid gap-2">
                    <a href="{{ url_for('races_list', stadium=analysis.stadium.number) }}" 
                       class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-list"></i> レース一覧
                    </a>
                    <button class="btn btn-outline-success btn-sm" onclick="predictAllStadiumRaces()">
                        <i class="fas fa-magic"></i> 一括予想
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- コース特性 -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-water"></i> コース特性</h5>
            </div>
            <div class="card-body">
                <h6>有利コース</h6>
                <div class="mb-3">
                    {% for advantage in analysis.characteristics.course_advantages %}
                    <span class="badge bg-primary me-2 mb-1">{{ advantage }}</span>
                    {% endfor %}
                </div>
                
                <h6>特徴</h6>
                <ul class="list-unstyled">
                    {% if analysis.characteristics.is_tidal %}
                    <li><i class="fas fa-arrow-up text-info me-2"></i>潮汐の影響を受ける</li>
                    {% endif %}
                    {% if analysis.characteristics.average_wind_speed and analysis.characteristics.average_wind_speed > 5 %}
                    <li><i class="fas fa-wind text-warning me-2"></i>風の影響が大きい</li>
                    {% endif %}
                    {% if analysis.characteristics.water_type == 'sea' %}
                    <li><i class="fas fa-waves text-primary me-2"></i>海水のため波が立ちやすい</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
    
    <!-- 統計情報 -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> 統計分析</h5>
            </div>
            <div class="card-body">
                {% if stats %}
                <div class="row">
                    <div class="col-6">
                        <div class="text-center p-2 border rounded mb-2">
                            <h5 class="text-primary">{{ "{:.1f}".format(stats.average_odds or 0) }}</h5>
                            <small class="text-muted">平均オッズ</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-2 border rounded mb-2">
                            <h5 class="text-success">{{ "{:.1f}".format(stats.win_rate or 0) }}%</h5>
                            <small class="text-muted">1号艇勝率</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-2 border rounded mb-2">
                            <h5 class="text-info">{{ stats.total_races or 0 }}</h5>
                            <small class="text-muted">分析レース数</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-2 border rounded mb-2">
                            <h5 class="text-warning">{{ "{:.1f}".format(stats.upset_rate or 0) }}%</h5>
                            <small class="text-muted">波乱率</small>
                        </div>
                    </div>
                </div>
                {% else %}
                <p class="text-muted text-center">統計データを読み込み中...</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- コース別成績 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-trophy"></i> コース別成績分析</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>コース</th>
                                <th>1着率</th>
                                <th>2着率</th>
                                <th>3着率</th>
                                <th>平均オッズ</th>
                                <th>特徴</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for i in range(1, 7) %}
                            <tr>
                                <td>
                                    <span class="badge bg-dark">{{ i }}コース</span>
                                </td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        {% set win_rate = (60 - i * 8) if i == 1 else (15 - i * 2) %}
                                        <div class="progress-bar bg-success" style="width: {{ win_rate }}%">
                                            {{ win_rate }}%
                                        </div>
                                    </div>
                                </td>
                                <td>{{ (20 - i * 2) if i <= 4 else (10 - i) }}%</td>
                                <td>{{ (15 - i) if i <= 5 else 5 }}%</td>
                                <td>{{ "{:.1f}".format(1.2 + i * 0.8) }}倍</td>
                                <td>
                                    {% if i == 1 %}
                                        <span class="badge bg-success">最内有利</span>
                                    {% elif i == 2 %}
                                        <span class="badge bg-info">差し有利</span>
                                    {% elif i == 6 %}
                                        <span class="badge bg-warning">大穴</span>
                                    {% else %}
                                        <span class="text-muted">標準</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 本日のレース -->
{% if today_races %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-flag-checkered"></i> 本日のレース</h5>
                <span class="badge bg-info">{{ today_races|length }}レース</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>時間</th>
                                <th>R</th>
                                <th>レース名</th>
                                <th>状態</th>
                                <th>予想</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for race in today_races %}
                            <tr>
                                <td>
                                    <strong>{{ race.start_time.strftime('%H:%M') if race.start_time else '-' }}</strong>
                                </td>
                                <td><span class="badge bg-dark">{{ race.race_number }}R</span></td>
                                <td>{{ race.title or 'レース名未取得' }}</td>
                                <td>
                                    {% if race.status == 'scheduled' %}
                                        <span class="badge bg-info">予定</span>
                                    {% elif race.status == 'running' %}
                                        <span class="badge bg-success">進行中</span>
                                    {% elif race.status == 'finished' %}
                                        <span class="badge bg-secondary">終了</span>
                                    {% else %}
                                        <span class="badge bg-warning">不明</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if race.has_prediction %}
                                        <i class="fas fa-brain text-success" title="予想済み"></i>
                                    {% else %}
                                        <i class="fas fa-brain text-muted" title="予想なし"></i>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('race_detail', race_id=race.id) }}" 
                                           class="btn btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if race.status == 'scheduled' %}
                                        <button class="btn btn-outline-success" 
                                                onclick="quickPredict('{{ race.id }}')">
                                            <i class="fas fa-magic"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 履歴・トレンド -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-history"></i> 最近のトレンド</h6>
            </div>
            <div class="card-body">
                <canvas id="trendChart" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-lightbulb"></i> 投票アドバイス</h6>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> {{ analysis.stadium.name }}での投票のコツ</h6>
                    <ul class="mb-0">
                        {% if analysis.characteristics.is_tidal %}
                        <li>潮汐の影響でレース展開が変わることがあります</li>
                        {% endif %}
                        {% if analysis.characteristics.water_type == 'sea' %}
                        <li>海水のため、波の状況に注意しましょう</li>
                        {% endif %}
                        {% if analysis.characteristics.average_wind_speed and analysis.characteristics.average_wind_speed > 5 %}
                        <li>風が強い日は波乱が起きやすくなります</li>
                        {% endif %}
                        <li>1号艇の信頼度は{{ "{:.0f}".format((stats.win_rate if stats else 55)) }}%程度です</li>
                        <li>穴狙いは6Rより後のレースがおすすめです</li>
                    </ul>
                </div>
                
                <div class="mt-3">
                    <h6>推奨戦略</h6>
                    <div class="d-flex gap-2 flex-wrap">
                        {% if (stats.win_rate if stats else 55) > 60 %}
                        <span class="badge bg-success">堅実</span>
                        {% endif %}
                        {% if analysis.characteristics.is_tidal %}
                        <span class="badge bg-info">潮汐考慮</span>
                        {% endif %}
                        {% if (stats.upset_rate if stats else 20) > 25 %}
                        <span class="badge bg-warning">波乱注意</span>
                        {% endif %}
                        <span class="badge bg-primary">基本</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- エラー表示 -->
<div class="row">
    <div class="col-12">
        <div class="alert alert-warning">
            <h4><i class="fas fa-exclamation-triangle"></i> 競技場情報が見つかりません</h4>
            <p>指定された競技場の情報を取得できませんでした。</p>
            <a href="{{ url_for('stadiums_list') }}" class="btn btn-primary">
                <i class="fas fa-arrow-left"></i> 競技場一覧に戻る
            </a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// トレンドチャート
const trendCtx = document.getElementById('trendChart');
if (trendCtx) {
    new Chart(trendCtx.getContext('2d'), {
        type: 'line',
        data: {
            labels: ['1週前', '6日前', '5日前', '4日前', '3日前', '2日前', '昨日'],
            datasets: [{
                label: '1号艇勝率',
                data: [58, 62, 55, 60, 63, 59, 61],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.1
            }, {
                label: '波乱率',
                data: [22, 18, 28, 20, 15, 25, 19],
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.y + '%';
                        }
                    }
                }
            }
        }
    });
}

// 一括予想実行
function predictAllStadiumRaces() {
    const stadiumNumber = {{ analysis.stadium.number if analysis else 0 }};
    
    if (confirm(`{{ analysis.stadium.name if analysis else 'この競技場' }}の全レースの予想を実行しますか？`)) {
        showGlobalLoading();
        
        // 実際の実装ではAPIを呼び出し
        setTimeout(() => {
            hideGlobalLoading();
            showSuccessMessage('一括予想が完了しました');
            location.reload();
        }, 3000);
    }
}

// クイック予想
function quickPredict(raceId) {
    const btn = event.target.closest('button');
    const originalContent = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    fetch(`/api/predict/${raceId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showErrorMessage('予想でエラーが発生しました: ' + data.error);
        } else {
            showSuccessMessage('予想が完了しました');
            // 予想完了マークを更新
            const row = btn.closest('tr');
            const predictionCell = row.querySelector('td:nth-child(5) i');
            if (predictionCell) {
                predictionCell.className = 'fas fa-brain text-success';
                predictionCell.title = '予想済み';
            }
        }
    })
    .catch(error => {
        console.error('Prediction error:', error);
        showErrorMessage('予想でエラーが発生しました');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalContent;
    });
}
</script>
{% endblock %}