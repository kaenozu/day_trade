{% extends "base.html" %}

{% block title %}投票インターフェース - Boatrace予想システム{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="fas fa-ticket-alt"></i> 投票インターフェース</h1>
        <p class="text-muted">舟券購入・戦略実行</p>
    </div>
</div>

<!-- 残高・予算情報 -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <h6 class="text-muted">現在残高</h6>
                        <h4 class="text-success">¥{{ "{:,.0f}".format(current_balance) }}</h4>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted">推奨予算</h6>
                        <h4 class="text-info">¥{{ "{:,.0f}".format(suggested_budget) }}</h4>
                        <small class="text-muted">残高の5%以内</small>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted">本日の投資</h6>
                        <h4 id="todayInvestment">¥0</h4>
                    </div>
                    <div class="col-md-3">
                        <h6 class="text-muted">本日の収支</h6>
                        <h4 id="todayPnL" class="text-muted">¥0</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-cog"></i> 投票設定</h6>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <label for="defaultStrategy" class="form-label">デフォルト戦略</label>
                    <select class="form-select form-select-sm" id="defaultStrategy">
                        {% for strategy in strategies %}
                        <option value="{{ strategy }}">{{ strategy }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-2">
                    <label for="defaultBudget" class="form-label">デフォルト予算</label>
                    <input type="number" class="form-control form-control-sm" id="defaultBudget" 
                           value="{{ suggested_budget | int }}" min="100" step="100">
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="autoExecute">
                    <label class="form-check-label" for="autoExecute">
                        自動実行
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- レース選択・投票 -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-flag-checkered"></i> 投票対象レース</h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshRaces()">
                        <i class="fas fa-sync"></i> 更新
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="predictAllRaces()">
                        <i class="fas fa-magic"></i> 一括予想
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if races %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th width="50">
                                    <input type="checkbox" id="selectAllRaces" onchange="toggleAllRaces()">
                                </th>
                                <th>時間</th>
                                <th>競技場</th>
                                <th>R</th>
                                <th>レース名</th>
                                <th>予想</th>
                                <th>推奨戦略</th>
                                <th>アクション</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for race in races %}
                            <tr class="race-item" data-race-id="{{ race.id }}">
                                <td>
                                    <input type="checkbox" class="race-checkbox" value="{{ race.id }}">
                                </td>
                                <td>
                                    <strong>{{ race.start_time.strftime('%H:%M') if race.start_time else '-' }}</strong>
                                    <br>
                                    <small class="text-muted">{{ race.start_time.strftime('%m/%d') if race.start_time else '-' }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{ race.stadium_name or race.stadium_number }}</span>
                                </td>
                                <td><span class="badge bg-dark">{{ race.race_number }}R</span></td>
                                <td>
                                    <strong>{{ race.title or 'レース名未取得' }}</strong>
                                    {% if race.grade %}
                                        <br><span class="badge bg-warning">{{ race.grade }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <div id="prediction-{{ race.id }}">
                                        {% if race.has_prediction %}
                                            <i class="fas fa-brain text-success" title="予想済み"></i>
                                            <br><small class="text-success">完了</small>
                                        {% else %}
                                            <i class="fas fa-brain text-muted" title="予想未実行"></i>
                                            <br><small class="text-muted">未実行</small>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <span id="strategy-{{ race.id }}" class="badge bg-info">
                                        {{ race.recommended_strategy or 'Balanced' }}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-info" onclick="showRaceDetail('{{ race.id }}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-outline-success" onclick="showBettingModal('{{ race.id }}')">
                                            <i class="fas fa-ticket-alt"></i>
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="executePrediction('{{ race.id }}')">
                                            <i class="fas fa-magic"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- 一括操作 -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <span class="me-2">選択中:</span>
                            <span id="selectedCount" class="badge bg-primary">0</span>
                            <span class="ms-2">レース</span>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="btn-group">
                            <button class="btn btn-outline-info" onclick="batchPredict()" disabled id="batchPredictBtn">
                                <i class="fas fa-magic"></i> 選択分を予想
                            </button>
                            <button class="btn btn-outline-success" onclick="batchBetting()" disabled id="batchBettingBtn">
                                <i class="fas fa-ticket-alt"></i> 選択分に投票
                            </button>
                        </div>
                    </div>
                </div>
                
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">投票可能なレースがありません</h5>
                    <p class="text-muted">今日のレース情報を確認してください</p>
                    <a href="{{ url_for('races_list') }}" class="btn btn-primary">
                        <i class="fas fa-search"></i> レース一覧
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- 投票履歴・統計 -->
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header">
                <h6><i class="fas fa-history"></i> 本日の投票履歴</h6>
            </div>
            <div class="card-body">
                <div id="todayBettingHistory">
                    <p class="text-muted text-center">まだ投票がありません</p>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-chart-bar"></i> 戦略統計</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>戦略</th>
                                <th>勝率</th>
                                <th>ROI</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for strategy in strategies %}
                            <tr>
                                <td>{{ strategy }}</td>
                                <td><small class="text-muted">-</small></td>
                                <td><small class="text-muted">-</small></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 投票モーダル -->
<div class="modal fade" id="bettingModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-ticket-alt"></i> 舟券購入
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="bettingForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>レース情報</h6>
                            <div id="raceInfoDisplay">
                                <!-- レース情報がここに表示される -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>投票設定</h6>
                            <div class="mb-3">
                                <label for="betStrategy" class="form-label">戦略</label>
                                <select class="form-select" id="betStrategy" required>
                                    {% for strategy in strategies %}
                                    <option value="{{ strategy }}">{{ strategy }}</option>
                                    {% endfor %}
                                    <option value="Manual">手動</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="betBudget" class="form-label">予算</label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    <input type="number" class="form-control" id="betBudget" 
                                           min="100" step="100" value="{{ suggested_budget | int }}" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 手動モードの舟券入力 -->
                    <div id="manualBettingSection" style="display: none;">
                        <hr>
                        <h6>手動投票</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <label for="betType" class="form-label">舟券種別</label>
                                <select class="form-select" id="betType">
                                    <option value="win">単勝</option>
                                    <option value="place_show">複勝</option>
                                    <option value="exacta">2連単</option>
                                    <option value="quinella">2連複</option>
                                    <option value="trifecta">3連単</option>
                                    <option value="trio">3連複</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="betNumbers" class="form-label">買い目</label>
                                <input type="text" class="form-control" id="betNumbers" 
                                       placeholder="例: 1-2-3">
                            </div>
                            <div class="col-md-4">
                                <label for="betAmount" class="form-label">金額</label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    <input type="number" class="form-control" id="betAmount" 
                                           min="100" step="100" value="1000">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 推奨投票表示エリア -->
                    <div id="recommendedBetsDisplay">
                        <!-- 戦略による推奨投票がここに表示される -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        キャンセル
                    </button>
                    <button type="button" class="btn btn-info me-auto" onclick="generateRecommendations()">
                        <i class="fas fa-magic"></i> 推奨生成
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-shopping-cart"></i> 投票実行
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedRaceId = null;

// レース選択機能
function toggleAllRaces() {
    const selectAll = document.getElementById('selectAllRaces');
    const checkboxes = document.querySelectorAll('.race-checkbox');
    
    checkboxes.forEach(cb => {
        cb.checked = selectAll.checked;
    });
    
    updateSelectedCount();
}

function updateSelectedCount() {
    const selected = document.querySelectorAll('.race-checkbox:checked');
    const count = selected.length;
    
    document.getElementById('selectedCount').textContent = count;
    document.getElementById('batchPredictBtn').disabled = count === 0;
    document.getElementById('batchBettingBtn').disabled = count === 0;
}

// チェックボックス変更イベント
document.querySelectorAll('.race-checkbox').forEach(cb => {
    cb.addEventListener('change', updateSelectedCount);
});

// 戦略変更で手動モード切り替え
document.getElementById('betStrategy').addEventListener('change', function() {
    const isManual = this.value === 'Manual';
    document.getElementById('manualBettingSection').style.display = isManual ? 'block' : 'none';
});

// 投票モーダル表示
function showBettingModal(raceId) {
    selectedRaceId = raceId;
    
    // レース情報表示
    const raceRow = document.querySelector(`[data-race-id="${raceId}"]`);
    const raceName = raceRow.querySelector('strong').textContent;
    const stadium = raceRow.querySelector('.badge').textContent;
    
    document.getElementById('raceInfoDisplay').innerHTML = `
        <div class="card">
            <div class="card-body">
                <h6>${raceName}</h6>
                <p class="mb-0">${stadium}</p>
            </div>
        </div>
    `;
    
    // モーダル表示
    const modal = new bootstrap.Modal(document.getElementById('bettingModal'));
    modal.show();
}

// レース詳細表示
function showRaceDetail(raceId) {
    window.open(`/race/${raceId}`, '_blank');
}

// 予想実行
function executePrediction(raceId) {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    fetch(`/api/predict/${raceId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('予想でエラーが発生しました: ' + data.error);
        } else {
            // 予想完了表示更新
            document.getElementById(`prediction-${raceId}`).innerHTML = `
                <i class="fas fa-brain text-success"></i>
                <br><small class="text-success">完了</small>
            `;
            alert('予想が完了しました');
        }
    })
    .catch(error => {
        console.error('Prediction error:', error);
        alert('予想でエラーが発生しました');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

// 推奨投票生成
function generateRecommendations() {
    if (!selectedRaceId) return;
    
    const strategy = document.getElementById('betStrategy').value;
    const budget = document.getElementById('betBudget').value;
    
    if (strategy === 'Manual') {
        alert('手動モードでは推奨生成は利用できません');
        return;
    }
    
    // 将来実装: 戦略に基づく推奨投票生成
    document.getElementById('recommendedBetsDisplay').innerHTML = `
        <hr>
        <h6>推奨投票 (${strategy}戦略)</h6>
        <div class="alert alert-info">
            推奨投票生成機能は今後実装予定です
        </div>
    `;
}

// 投票フォーム送信
document.getElementById('bettingForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const strategy = document.getElementById('betStrategy').value;
    
    if (strategy === 'Manual') {
        // 手動投票
        const formData = {
            race_id: selectedRaceId,
            bet_type: document.getElementById('betType').value,
            numbers: document.getElementById('betNumbers').value,
            amount: parseFloat(document.getElementById('betAmount').value),
            strategy_name: 'Manual'
        };
        
        purchaseTicket(formData);
    } else {
        // 戦略投票（将来実装）
        alert('戦略投票機能は今後実装予定です');
    }
});

// 舟券購入API
function purchaseTicket(formData) {
    fetch('/api/purchase_ticket', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('エラー: ' + data.error);
        } else {
            alert('舟券購入を記録しました');
            bootstrap.Modal.getInstance(document.getElementById('bettingModal')).hide();
            updateTodayBettingHistory();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('購入記録でエラーが発生しました');
    });
}

// 本日の投票履歴更新
function updateTodayBettingHistory() {
    // 将来実装: リアルタイムで本日の投票履歴を更新
    console.log('Updating today betting history...');
}

// 一括予想
function predictAllRaces() {
    const races = document.querySelectorAll('.race-item');
    alert(`${races.length}レースの一括予想を開始します\n（今後実装予定）`);
}

// レース情報更新
function refreshRaces() {
    location.reload();
}

// 一括投票
function batchBetting() {
    const selected = document.querySelectorAll('.race-checkbox:checked');
    alert(`${selected.length}レースの一括投票を実行します\n（今後実装予定）`);
}

// 一括予想
function batchPredict() {
    const selected = document.querySelectorAll('.race-checkbox:checked');
    alert(`${selected.length}レースの一括予想を実行します\n（今後実装予定）`);
}

// 定期更新（3分毎）
setInterval(() => {
    updateTodayBettingHistory();
    console.log('Auto refreshing betting data...');
}, 180000);
</script>
{% endblock %}