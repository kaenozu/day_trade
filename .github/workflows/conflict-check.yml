name: ğŸ” Conflict Detection & Resolution

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  # âš¡ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæ¤œå‡º
  detect-conflicts:
    runs-on: ubuntu-latest
    name: ğŸ” Detect Conflicts
    outputs:
      has-conflicts: ${{ steps.conflict-check.outputs.has-conflicts }}
      conflict-files: ${{ steps.conflict-check.outputs.conflict-files }}

    steps:
      - name: ğŸ“¥ Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ğŸ” Advanced conflict detection
        id: conflict-check
        run: |
          echo "ğŸ” Checking for merge conflicts..."

          # ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–°ã‚’å–å¾—
          git fetch origin ${{ github.event.pull_request.base.ref }}
          base_branch="origin/${{ github.event.pull_request.base.ref }}"

          # ãƒãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆï¼ˆdry-runï¼‰
          echo "Testing merge with $base_branch..."
          if git merge-tree $(git merge-base HEAD $base_branch) HEAD $base_branch | grep -q "<<<<<<< "; then
            echo "âŒ Merge conflicts detected!"

            # ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç‰¹å®š
            conflict_files=$(git merge-tree $(git merge-base HEAD $base_branch) HEAD $base_branch | grep -E "<<<<<<< |======= |>>>>>>> " -B5 -A5 | grep "^\+\+\+ " | sed 's/^\+\+\+ b\///' | sort -u | tr '\n' ',' | sed 's/,$//')

            echo "has-conflicts=true" >> $GITHUB_OUTPUT
            echo "conflict-files=$conflict_files" >> $GITHUB_OUTPUT

            echo "ğŸ“‹ Conflicted files: $conflict_files"
          else
            echo "âœ… No merge conflicts detected"
            echo "has-conflicts=false" >> $GITHUB_OUTPUT
            echo "conflict-files=" >> $GITHUB_OUTPUT
          fi

  # ğŸ”§ è‡ªå‹•ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºã®ææ¡ˆ
  suggest-resolution:
    runs-on: ubuntu-latest
    needs: detect-conflicts
    if: needs.detect-conflicts.outputs.has-conflicts == 'true'
    name: ğŸ”§ Suggest Resolution

    steps:
      - name: ğŸ“¥ Checkout with full history
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ğŸ”§ Generate resolution suggestions
        id: suggestions
        run: |
          echo "ğŸ”§ Generating conflict resolution suggestions..."

          git fetch origin ${{ github.event.pull_request.base.ref }}
          base_branch="origin/${{ github.event.pull_request.base.ref }}"

          # ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã®è©³ç´°åˆ†æ
          echo "## ğŸ” Conflict Analysis" > conflict-report.md
          echo "" >> conflict-report.md
          echo "**Base branch:** ${{ github.event.pull_request.base.ref }}" >> conflict-report.md
          echo "**Head branch:** ${{ github.event.pull_request.head.ref }}" >> conflict-report.md
          echo "**Conflicted files:** ${{ needs.detect-conflicts.outputs.conflict-files }}" >> conflict-report.md
          echo "" >> conflict-report.md

          # è§£æ±ºæ‰‹é †ã®ç”Ÿæˆ
          echo "## ğŸ› ï¸ Resolution Steps" >> conflict-report.md
          echo "" >> conflict-report.md
          echo '```bash' >> conflict-report.md
          echo "# Step 1: Update your local branch" >> conflict-report.md
          echo "git checkout ${{ github.event.pull_request.head.ref }}" >> conflict-report.md
          echo "git pull origin ${{ github.event.pull_request.head.ref }}" >> conflict-report.md
          echo "" >> conflict-report.md
          echo "# Step 2: Merge the latest base branch" >> conflict-report.md
          echo "git pull origin ${{ github.event.pull_request.base.ref }}" >> conflict-report.md
          echo "git merge origin/${{ github.event.pull_request.base.ref }}" >> conflict-report.md
          echo "" >> conflict-report.md
          echo "# Step 3: Resolve conflicts in the following files:" >> conflict-report.md

          IFS=',' read -ra files <<< "${{ needs.detect-conflicts.outputs.conflict-files }}"
          for file in "${files[@]}"; do
            if [[ -n "$file" ]]; then
              echo "# - $file" >> conflict-report.md
            fi
          done

          echo "" >> conflict-report.md
          echo "# Step 4: After resolving conflicts" >> conflict-report.md
          echo "git add ." >> conflict-report.md
          echo 'git commit -m "resolve: merge conflicts with ${{ github.event.pull_request.base.ref }}"' >> conflict-report.md
          echo "git push origin ${{ github.event.pull_request.head.ref }}" >> conflict-report.md
          echo '```' >> conflict-report.md
          echo "" >> conflict-report.md

          # è‡ªå‹•è§£æ±ºã®å¯èƒ½æ€§ã‚’ãƒã‚§ãƒƒã‚¯
          echo "## ğŸ¤– Auto-Resolution Analysis" >> conflict-report.md
          echo "" >> conflict-report.md

          auto_resolvable=true
          IFS=',' read -ra files <<< "${{ needs.detect-conflicts.outputs.conflict-files }}"
          for file in "${files[@]}"; do
            if [[ -n "$file" && "$file" == *.py ]]; then
              echo "- \`$file\`: Python file - manual review recommended" >> conflict-report.md
              auto_resolvable=false
            elif [[ -n "$file" && "$file" == *.md ]]; then
              echo "- \`$file\`: Documentation - potential auto-resolution" >> conflict-report.md
            elif [[ -n "$file" && "$file" == *.json ]] || [[ -n "$file" && "$file" == *.yml ]] || [[ -n "$file" && "$file" == *.yaml ]]; then
              echo "- \`$file\`: Configuration file - manual review required" >> conflict-report.md
              auto_resolvable=false
            fi
          done

          if [ "$auto_resolvable" == "true" ]; then
            echo "" >> conflict-report.md
            echo "âœ… **These conflicts may be auto-resolvable**" >> conflict-report.md
          else
            echo "" >> conflict-report.md
            echo "âš ï¸ **Manual conflict resolution required**" >> conflict-report.md
          fi

          echo "auto_resolvable=$auto_resolvable" >> $GITHUB_OUTPUT

      - name: ğŸ“ Comment conflict analysis
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const conflictReport = fs.readFileSync('conflict-report.md', 'utf8');

            // æ—¢å­˜ã®ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸ” Conflict Analysis')
            );

            const body = `${conflictReport}

            ---
            ğŸ¤– This analysis was generated automatically. Last updated: ${new Date().toISOString()}`;

            if (botComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  # âœ… ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºç¢ºèª
  verify-resolution:
    runs-on: ubuntu-latest
    needs: [detect-conflicts, suggest-resolution]
    if: always()
    name: âœ… Verify Status

    steps:
      - name: ğŸ“Š Final conflict status
        run: |
          if [ "${{ needs.detect-conflicts.outputs.has-conflicts }}" == "true" ]; then
            echo "âŒ PR has merge conflicts that need resolution"
            echo "ğŸ”§ Resolution suggestions have been posted as a comment"
            exit 1
          else
            echo "âœ… No merge conflicts detected - PR is ready for review"
            exit 0
          fi

  # ğŸ”„ ç¶™ç¶šçš„ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆç›£è¦–
  monitor-conflicts:
    runs-on: ubuntu-latest
    if: github.event.action == 'synchronize'
    name: ğŸ”„ Monitor Changes

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ” Check for new conflicts
        run: |
          echo "ğŸ”„ Monitoring PR for new conflicts after push..."

          # æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆã§è¿½åŠ ã•ã‚ŒãŸå¤‰æ›´ã‚’ç¢ºèª
          echo "ğŸ“‹ Recent changes:"
          git diff HEAD~1 HEAD --name-only | head -20

          echo "âœ… Conflict monitoring completed"

  # ğŸ“ˆ ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆçµ±è¨ˆ
  conflict-stats:
    runs-on: ubuntu-latest
    needs: detect-conflicts
    if: always()
    name: ğŸ“ˆ Statistics

    steps:
      - name: ğŸ“ˆ Update conflict statistics
        run: |
          echo "ğŸ“ˆ Conflict Detection Statistics"
          echo "==============================="
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "Has Conflicts: ${{ needs.detect-conflicts.outputs.has-conflicts }}"
          echo "Conflicted Files: ${{ needs.detect-conflicts.outputs.conflict-files }}"
          echo "Detection Time: $(date -u)"

          # çµ±è¨ˆæƒ…å ±ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
          cat > conflict-stats.json << EOF
          {
            "pr_number": ${{ github.event.pull_request.number }},
            "has_conflicts": "${{ needs.detect-conflicts.outputs.has-conflicts }}",
            "conflict_files": "${{ needs.detect-conflicts.outputs.conflict-files }}",
            "detection_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "base_branch": "${{ github.event.pull_request.base.ref }}",
            "head_branch": "${{ github.event.pull_request.head.ref }}"
          }
          EOF

      - name: ğŸ“¤ Upload statistics
        uses: actions/upload-artifact@v4
        with:
          name: conflict-stats-${{ github.event.pull_request.number }}
          path: conflict-stats.json
          retention-days: 30
