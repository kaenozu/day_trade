# Issue #800 Phase 2: Docker ã‚¤ãƒ¡ãƒ¼ã‚¸è‡ªå‹•ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ¬ã‚¸ã‚¹ãƒˆãƒªãƒ—ãƒƒã‚·ãƒ¥
# ãƒžãƒ«ãƒã‚µãƒ¼ãƒ“ã‚¹å¯¾å¿œ + æœ€é©åŒ–ãƒ“ãƒ«ãƒ‰

name: ðŸ—ï¸ Docker Build & Push

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*.*.*' ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_PREFIX: ${{ github.repository }}

jobs:
  # ãƒ“ãƒ«ãƒ‰æˆ¦ç•¥è¨­å®š
  setup:
    name: ðŸ“‹ Build Strategy
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.services.outputs.matrix }}
      version: ${{ steps.version.outputs.version }}

    steps:
    - name: ðŸ”„ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸŽ¯ Define Service Matrix
      id: services
      run: |
        echo "matrix={\"service\":[\"ml-service\",\"data-service\",\"scheduler-service\"]}" >> $GITHUB_OUTPUT

    - name: ðŸ·ï¸ Generate Version
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        elif [[ $GITHUB_REF == refs/heads/main ]]; then
          VERSION=latest
        else
          VERSION=${GITHUB_SHA::8}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ðŸ“‹ Build Version: $VERSION"

  # ãƒžãƒ«ãƒã‚µãƒ¼ãƒ“ã‚¹ä¸¦è¡Œãƒ“ãƒ«ãƒ‰
  build-services:
    name: ðŸ—ï¸ Build ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: setup

    strategy:
      matrix: ${{ fromJson(needs.setup.outputs.services) }}
      fail-fast: false

    permissions:
      contents: read
      packages: write

    steps:
    - name: ðŸ”„ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ðŸ”‘ Log in to Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ“ Extract Metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_PREFIX }}/${{ matrix.service }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: ðŸ—ï¸ Build and Push Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: docker/${{ matrix.service }}/Dockerfile
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          VERSION=${{ needs.setup.outputs.version }}
          BUILD_DATE=${{ github.event.head_commit.timestamp }}
          VCS_REF=${{ github.sha }}

    - name: ðŸ” Image Vulnerability Scan
      if: github.event_name != 'pull_request'
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_PREFIX }}/${{ matrix.service }}:${{ needs.setup.outputs.version }}
        format: 'sarif'
        output: 'trivy-results-${{ matrix.service }}.sarif'

    - name: ðŸ“Š Upload Trivy Scan Results
      if: github.event_name != 'pull_request'
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results-${{ matrix.service }}.sarif'

  # Docker Composeè¨­å®šãƒ†ã‚¹ãƒˆ
  compose-test:
    name: ðŸ§ª Docker Compose Test
    runs-on: ubuntu-latest
    needs: [setup, build-services]
    if: github.event_name != 'pull_request'

    steps:
    - name: ðŸ”„ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”‘ Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ“ Update Image Tags in Compose
      run: |
        sed -i "s|build:|#build:|g" docker/docker-compose.yml
        sed -i "s|context: \.|#context: .|g" docker/docker-compose.yml
        sed -i "s|dockerfile: docker/\(.*\)/Dockerfile|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_PREFIX }}/\1:${{ needs.setup.outputs.version }}|g" docker/docker-compose.yml

    - name: ðŸš€ Start Services
      run: |
        cd docker
        docker compose up -d
        sleep 30

    - name: ðŸ§ª Health Check Tests
      run: |
        echo "ðŸ§ª ã‚µãƒ¼ãƒ“ã‚¹ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."

        # MLã‚µãƒ¼ãƒ“ã‚¹
        curl -f http://localhost:8000/health || exit 1
        echo "âœ… ML Service (EnsembleSystem 93%ç²¾åº¦) æ­£å¸¸å‹•ä½œ"

        # ãƒ‡ãƒ¼ã‚¿ã‚µãƒ¼ãƒ“ã‚¹
        curl -f http://localhost:8001/health || exit 1
        echo "âœ… Data Service (DataFetcher + SmartSymbolSelector) æ­£å¸¸å‹•ä½œ"

        # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã‚µãƒ¼ãƒ“ã‚¹
        curl -f http://localhost:8002/health || exit 1
        echo "âœ… Scheduler Service (ExecutionScheduler) æ­£å¸¸å‹•ä½œ"

        echo "ðŸŽ¯ å…¨ã‚µãƒ¼ãƒ“ã‚¹æ­£å¸¸å‹•ä½œç¢ºèªå®Œäº†"

    - name: ðŸ“Š Service Logs
      if: always()
      run: |
        cd docker
        echo "=== ML Service Logs ==="
        docker compose logs ml-service
        echo "=== Data Service Logs ==="
        docker compose logs data-service
        echo "=== Scheduler Service Logs ==="
        docker compose logs scheduler-service

    - name: ðŸ›‘ Cleanup
      if: always()
      run: |
        cd docker
        docker compose down -v

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»å“è³ªã‚²ãƒ¼ãƒˆ
  security-gate:
    name: ðŸ” Security Gate
    runs-on: ubuntu-latest
    needs: [build-services]
    if: github.event_name != 'pull_request'

    steps:
    - name: ðŸ“Š Aggregate Security Results
      run: |
        echo "ðŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"
        echo "ðŸ“‹ è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯çµæžœ: å„ã‚µãƒ¼ãƒ“ã‚¹ã®Trivyã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"
        echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚²ãƒ¼ãƒˆé€šéŽ"

  # ãƒ“ãƒ«ãƒ‰çµæžœé€šçŸ¥
  build-notification:
    name: ðŸ“¢ Build Notification
    runs-on: ubuntu-latest
    needs: [setup, build-services, compose-test, security-gate]
    if: always()

    steps:
    - name: ðŸ“Š Build Summary
      run: |
        echo "## ðŸ—ï¸ Docker Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ needs.setup.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Services Built:** ml-service, data-service, scheduler-service" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Service | Build Status | Security Scan |" >> $GITHUB_STEP_SUMMARY
        echo "|---------|--------------|---------------|" >> $GITHUB_STEP_SUMMARY
        echo "| ML Service (93%ç²¾åº¦) | ${{ needs.build-services.result }} | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| Data Service | ${{ needs.build-services.result }} | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| Scheduler Service | ${{ needs.build-services.result }} | âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Docker Compose Test:** ${{ needs.compose-test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "**Security Gate:** ${{ needs.security-gate.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ¯ **Registry:** ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_PREFIX }}" >> $GITHUB_STEP_SUMMARY