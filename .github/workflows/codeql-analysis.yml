name: 📊 CodeQL Security Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # 毎週日曜日の深夜2時（UTC）に実行
    - cron: '0 2 * * 0'
  workflow_dispatch:

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  analyze:
    name: 🔍 CodeQL Analysis
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        language: [ 'python' ]
        # CodeQLがサポートする言語: 'cpp', 'csharp', 'go', 'java', 'javascript', 'python', 'ruby'

    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v4
      with:
        # CodeQL分析のため完全な履歴を取得
        fetch-depth: 0

    - name: 🔧 Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        # カスタムクエリを使用する場合（オプション）
        # queries: security-extended,security-and-quality

        # CodeQL設定ファイルを使用（カスタム設定がある場合）
        # config-file: ./.github/codeql/codeql-config.yml

    - name: 🐍 Setup Python environment
      if: matrix.language == 'python'
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: 📦 Install Python dependencies
      if: matrix.language == 'python'
      run: |
        python -m pip install --upgrade pip wheel setuptools
        # CodeQL分析用に軽量な依存関係のみインストール
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
        if [ -f pyproject.toml ]; then
          pip install -e .
        fi

    # コンパイル型言語の場合のビルドステップ
    # - name: 🔨 Autobuild
    #   uses: github/codeql-action/autobuild@v3

    # 手動ビルドが必要な場合
    # - name: 🔨 Manual build
    #   run: |
    #     echo "Manual build commands here"

    - name: 🔍 Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        # 分析結果のカテゴリ（複数言語の場合の識別用）
        category: "/language:${{matrix.language}}"

        # SARIF結果をアップロード（セキュリティタブで確認可能）
        upload: true

        # 分析結果の詳細度を設定
        # error-on-scan-failure: true (本番環境では有効にすることを推奨)

    - name: 📋 Upload CodeQL results to artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: codeql-results-${{ matrix.language }}-${{ github.run_number }}
        path: |
          /home/runner/work/_temp/codeql_databases
          ${{ github.workspace }}/**/*.sarif
        retention-days: 30
        if-no-files-found: ignore

    - name: 📊 Summary report
      if: always()
      run: |
        echo "## 🔍 CodeQL Analysis Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Language:** ${{ matrix.language }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Analysis Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "🔗 **View Results:** Check the Security tab for detailed findings" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # 結果ファイルの存在確認
        if ls *.sarif 1> /dev/null 2>&1; then
          echo "✅ **SARIF Results:** Available for upload" >> $GITHUB_STEP_SUMMARY
        else
          echo "ℹ️ **SARIF Results:** No files found (may be expected for clean code)" >> $GITHUB_STEP_SUMMARY
        fi
