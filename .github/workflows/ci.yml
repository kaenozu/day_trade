name: Optimized CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  statuses: write
  checks: write

env:
  PYTHON_VERSION: '3.11'
  CACHE_VERSION: v3

jobs:
  # å¤‰æ›´æ¤œå‡ºã‚¸ãƒ§ãƒ– - å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã«åŸºã¥ã„ã¦ã‚¸ãƒ§ãƒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—
  changes:
    runs-on: ubuntu-latest
    outputs:
      python: ${{ steps.changes.outputs.python }}
      docs: ${{ steps.changes.outputs.docs }}
      config: ${{ steps.changes.outputs.config }}
      tests: ${{ steps.changes.outputs.tests }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            python:
              - 'src/**/*.py'
              - 'tests/**/*.py'
              - '*.py'
              - 'pyproject.toml'
              - 'requirements*.txt'
            docs:
              - '**/*.md'
              - 'docs/**'
            config:
              - '.github/**'
              - '.pre-commit-config.yaml'
              - '*.toml'
              - '*.yml'
              - '*.yaml'
            tests:
              - 'tests/**'

  # é«˜é€Ÿã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
  code-quality:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.python == 'true' || needs.changes.outputs.config == 'true'
    name: ğŸ” Code Quality (Fast)

    steps:
      - name: Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python (cached)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Cache pre-commit
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ env.CACHE_VERSION }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ env.CACHE_VERSION }}-

      - name: Install dependencies (minimal)
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Run pre-commit (changed files only)
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "ğŸ” Running pre-commit on changed files only..."
            # Fetch base branch for comparison
            git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}
            pre-commit run --from-ref ${{ github.base_ref }} --to-ref HEAD
          else
            echo "ğŸ” Running pre-commit on all files..."
            pre-commit run --all-files
          fi

  # ä¸¦åˆ—ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ (ãƒãƒˆãƒªãƒƒã‚¯ã‚¹æœ€é©åŒ–)
  test:
    runs-on: ubuntu-latest
    needs: [changes, code-quality]
    if: needs.changes.outputs.python == 'true' || needs.changes.outputs.tests == 'true'
    name: ğŸ§ª Tests
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11']  # åŠ¹ç‡åŒ–ï¼šãƒ¡ã‚¤ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã¿
        test-group: ['unit', 'integration']  # ãƒ†ã‚¹ãƒˆã‚’åˆ†å‰²å®Ÿè¡Œ

    steps:
      - name: Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies (cached)
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Run tests (${{ matrix.test-group }})
        run: |
          if [ "${{ matrix.test-group }}" = "unit" ]; then
            echo "ğŸ§ª Running unit tests..."
            pytest tests/ -v --tb=short --disable-warnings \
                   --ignore=tests/integration/ \
                   --cov=src/day_trade \
                   --cov-report=xml \
                   --cov-report=html \
                   --cov-report=term-missing \
                   --cov-report=json \
                   --cov-fail-under=20
          else
            echo "ğŸ”— Running integration tests..."
            pytest tests/integration/ -v --tb=short -x --disable-warnings || echo "Integration tests not yet implemented"
          fi

      - name: Upload coverage to Codecov
        if: matrix.test-group == 'unit'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: py${{ matrix.python-version }}
        continue-on-error: true

      - name: Upload coverage reports as artifacts
        if: matrix.test-group == 'unit'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-py${{ matrix.python-version }}
          path: |
            coverage.xml
            coverage.json
            htmlcov/
          retention-days: 30
        continue-on-error: true

  # é«˜é€Ÿã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
  security:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.python == 'true'
    name: ğŸ”’ Security Scan

    steps:
      - name: Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit[toml]

      - name: Run security checks (parallel)
        run: |
          echo "ğŸ”’ Running security scans..."
          # ä¸¦åˆ—å®Ÿè¡Œã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
          safety check --json > safety-report.json &
          bandit -r src/ -f json -o bandit-report.json &
          wait

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: "*-report.json"
          retention-days: 30

  # æ¡ä»¶ä»˜ããƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–
  build:
    runs-on: ubuntu-latest
    needs: [test, security]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped') && (needs.security.result == 'success' || needs.security.result == 'skipped')
    name: ğŸ“¦ Build

    steps:
      - name: Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Build package
        run: |
          echo "ğŸ“¦ Building package..."
          python -m build

      - name: Check package
        run: |
          echo "âœ… Checking package..."
          python -m twine check dist/*

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ github.sha }}
          path: dist/
          retention-days: 90

  # çµ±åˆãƒã‚§ãƒƒã‚¯ (PRã®ã¿)
  integration:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    name: ğŸ”— Integration Check

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-${{ github.sha }}
          path: dist/

      - name: Test installation
        run: |
          echo "ğŸ”— Testing package installation..."
          pip install dist/*.whl
          python -c "import day_trade; print('Package installed successfully')"

  # ã¾ã¨ã‚ã‚¸ãƒ§ãƒ– (åŠ¹ç‡åŒ–)
  ci-success:
    runs-on: ubuntu-latest
    needs: [changes, code-quality, test, security, build]
    if: always()
    name: âœ… CI Status

    steps:
      - name: Check results
        run: |
          echo "ğŸ“Š CI Results Summary:"
          echo "Changes detected: python=${{ needs.changes.outputs.python }}, tests=${{ needs.changes.outputs.tests }}"
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Tests: ${{ needs.test.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Build: ${{ needs.build.result }}"

          # æˆåŠŸæ¡ä»¶ã®åˆ¤å®š
          if [[
            ("${{ needs.code-quality.result }}" == "success" || "${{ needs.code-quality.result }}" == "skipped") &&
            ("${{ needs.test.result }}" == "success" || "${{ needs.test.result }}" == "skipped") &&
            ("${{ needs.security.result }}" == "success" || "${{ needs.security.result }}" == "skipped") &&
            ("${{ needs.build.result }}" == "success" || "${{ needs.build.result }}" == "skipped")
          ]]; then
            echo "âœ… All CI checks passed!"
            exit 0
          else
            echo "âŒ Some CI checks failed"
            exit 1
          fi

  # è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ (mainãƒ–ãƒ©ãƒ³ãƒã®ã¿)
  deploy:
    runs-on: ubuntu-latest
    needs: [ci-success, integration]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    name: ğŸš€ Deploy

    steps:
      - name: Deploy placeholder
        run: |
          echo "ğŸš€ Deployment ready"
          echo "TODO: Implement actual deployment logic"
