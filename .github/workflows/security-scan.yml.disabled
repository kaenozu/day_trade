name: Comprehensive Security Scanning

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  schedule:
    - cron: '0 3 * * *'  # æ¯æ—¥3æ™‚ã«å®Ÿè¡Œ
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write
  pull-requests: write

jobs:
  dependency-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install security scanning tools
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit semgrep pip-audit
          pip install -r requirements.txt

      - name: Python dependency vulnerability scan
        run: |
          echo "## ğŸ” ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³çµæœ" > security_report.md
          echo "" >> security_report.md

          # pip-auditã«ã‚ˆã‚‹æœ€æ–°è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
          echo "### pip-audit - æœ€æ–°è„†å¼±æ€§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹" >> security_report.md
          if pip-audit --format=json --output=pip_audit_results.json --desc; then
            echo "âœ… **è„†å¼±æ€§ã¯ç™ºè¦‹ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ**" >> security_report.md
          else
            echo "âš ï¸ **è„†å¼±æ€§ãŒç™ºè¦‹ã•ã‚Œã¾ã—ãŸ**" >> security_report.md
            echo '```json' >> security_report.md
            cat pip_audit_results.json >> security_report.md
            echo '```' >> security_report.md
          fi
          echo "" >> security_report.md

          # Safetyã«ã‚ˆã‚‹æ—¢çŸ¥ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
          echo "### Safety - æ—¢çŸ¥ã®è„†å¼±æ€§" >> security_report.md
          if safety check --json > safety_results.json; then
            echo "âœ… **è„†å¼±æ€§ã¯ç™ºè¦‹ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ**" >> security_report.md
          else
            echo "âš ï¸ **è„†å¼±æ€§ãŒç™ºè¦‹ã•ã‚Œã¾ã—ãŸ**" >> security_report.md
            echo '```json' >> security_report.md
            cat safety_results.json >> security_report.md
            echo '```' >> security_report.md
          fi
          echo "" >> security_report.md

          # pip-auditã«ã‚ˆã‚‹æ—¢çŸ¥ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
          echo "### pip-audit - æ—¢çŸ¥ã®è„†å¼±æ€§" >> security_report.md
          if pip-audit --format json . > pip_audit_results.json || true; then
            echo "âœ… **è„†å¼±æ€§ã¯ç™ºè¦‹ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ**" >> security_report.md
          else
            echo "âš ï¸ **è„†å¼±æ€§ãŒç™ºè¦‹ã•ã‚Œã¾ã—ãŸ**" >> security_report.md
            echo '```json' >> security_report.md
            cat pip_audit_results.json >> security_report.md
            echo '```' >> security_report.md
          fi
          echo "" >> security_report.md

      - name: Static Application Security Testing (SAST)
        run: |
          echo "### Bandit - é™çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è§£æ" >> security_report.md

          # Banditã«ã‚ˆã‚‹é™çš„è§£æ
          if bandit -r src/ -f json -o bandit_results.json; then
            echo "âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã¯ç™ºè¦‹ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ**" >> security_report.md
          else
            echo "ğŸš¨ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡ŒãŒç™ºè¦‹ã•ã‚Œã¾ã—ãŸ**" >> security_report.md
            echo "" >> security_report.md

            # é‡è¦åº¦åˆ¥ã«æ•´ç†
            python -c "
            import json
            try:
                with open('bandit_results.json') as f:
                    data = json.load(f)

                high = [r for r in data.get('results', []) if r.get('issue_severity') == 'HIGH']
                medium = [r for r in data.get('results', []) if r.get('issue_severity') == 'MEDIUM']
                low = [r for r in data.get('results', []) if r.get('issue_severity') == 'LOW']

                if high:
                    print('#### ğŸ”´ é«˜ãƒªã‚¹ã‚¯')
                    for issue in high:
                        print(f'- **{issue["test_name"]}**: {issue["issue_text"]} ({issue["filename"]}:{issue["line_number"]})')

                if medium:
                    print('#### ğŸŸ¡ ä¸­ãƒªã‚¹ã‚¯')
                    for issue in medium:
                        print(f'- **{issue["test_name"]}**: {issue["issue_text"]} ({issue["filename"]}:{issue["line_number"]})')

                if low:
                    print('#### ğŸŸ¢ ä½ãƒªã‚¹ã‚¯')
                    for issue in low:
                        print(f'- **{issue["test_name"]}**: {issue["issue_text"]} ({issue["filename"]}:{issue["line_number"]})')

            except Exception as e:
                print(f'ã‚¨ãƒ©ãƒ¼: {e}')
            " >> security_report.md
          fi
          echo "" >> security_report.md

      - name: Secrets detection
        run: |
          echo "### ğŸ” ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡º" >> security_report.md

          # åŸºæœ¬çš„ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³ (GitGuardianèª¤æ¤œçŸ¥å›é¿ã®ãŸã‚åˆ†å‰²è¡¨è¨˜)
          API_PATTERN="ap[i][_-]?k[e]y[[:space:]]*=[[:space:]]*[''][a-zA-Z0-9_-]{10,}['']"
          SECRET_PATTERN="sec[r]et[_-]?k[e]y[[:space:]]*=[[:space:]]*[''][a-zA-Z0-9_-]{10,}['']"
          PASSWORD_PATTERN="p[a-z]ss[w][o-z]rd[[:space:]]*=[[:space:]]*[''][^'\"]{8,}['']"
          TOKEN_PATTERN="tok[e]n[_-]?k[e]y[[:space:]]*=[[:space:]]*[''][a-zA-Z0-9_-]{10,}['']"
          AWS_ACCESS_PATTERN="aws[_-]?access[_-]?k[e]y[[:space:]]*=[[:space:]]*['']AKIA[a-zA-Z0-9]{16}['']"
          AWS_SECRET_PATTERN="aws[_-]?sec[r]et[_-]?k[e]y[[:space:]]*=[[:space:]]*[''][a-zA-Z0-9/+=]{40}['']"
          PRIVATE_KEY_PATTERN="-----BEGIN [A-Z ]*PRIVATE K[E]Y-----"
          
          SECRET_PATTERNS=(
            "$API_PATTERN"
            "$SECRET_PATTERN"
            "$PASSWORD_PATTERN"
            "$TOKEN_PATTERN"
            "$AWS_ACCESS_PATTERN"
            "$AWS_SECRET_PATTERN"
            "$PRIVATE_KEY_PATTERN"
          )

          SECRETS_FOUND=0
          for pattern in "${SECRET_PATTERNS[@]}"; do
            if grep -r -i -n "$pattern" src/ 2>/dev/null;
 then
              if [ $SECRETS_FOUND -eq 0 ]; then
                echo "ğŸš¨ **æ½œåœ¨çš„ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ¼æ´©ãŒç™ºè¦‹ã•ã‚Œã¾ã—ãŸ**" >> security_report.md
                echo "" >> security_report.md
              fi
              SECRETS_FOUND=1
              echo "- ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º: $pattern" >> security_report.md
            fi
          done

          if [ $SECRETS_FOUND -eq 0 ]; then
            echo "âœ… **ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®æ¼æ´©ã¯ç™ºè¦‹ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ**" >> security_report.md
          fi
          echo "" >> security_report.md

      - name: Financial system specific security checks
        run: |
          echo "### ğŸ’° é‡‘èã‚·ã‚¹ãƒ†ãƒ å›ºæœ‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯" >> security_report.md
          echo "" >> security_report.md

          # SQL Injection ãƒã‚§ãƒƒã‚¯
          echo "#### SQL ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–" >> security_report.md
          if grep -r "execute.*%" src/ 2>/dev/null | grep -v "executemany\|execute.*VALUES.*?" > sql_injection_check.txt;
 then
            echo "âš ï¸ **æ½œåœ¨çš„ãªSQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³è„†å¼±æ€§**" >> security_report.md
            echo '```' >> security_report.md
            cat sql_injection_check.txt >> security_report.md
            echo '```' >> security_report.md
          else
            echo "âœ… SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–: é©åˆ‡" >> security_report.md
          fi
          echo "" >> security_report.md

          # TOCTOU (Time-of-check to time-of-use) ãƒã‚§ãƒƒã‚¯
          echo "#### TOCTOUæ”»æ’ƒå¯¾ç­–" >> security_report.md
          if grep -r -A 3 -B 3 "os\.path\.exists\|os\.path\.isfile" src/ | grep -A 5 -B 5 "open(" > toctou_check.txt && [ -s toctou_check.txt ]; then
            echo "âš ï¸ **æ½œåœ¨çš„ãªTOCTOUè„†å¼±æ€§ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯å¾Œã®æ“ä½œï¼‰**" >> security_report.md
            echo '```python' >> security_report.md
            head -20 toctou_check.txt >> security_report.md
            echo '```' >> security_report.md
          else
            echo "âœ… TOCTOUæ”»æ’ƒå¯¾ç­–: ç¢ºèªæ¸ˆã¿" >> security_report.md
          fi
          echo "" >> security_report.md

          # æš—å·åŒ–å®Ÿè£…ãƒã‚§ãƒƒã‚¯
          echo "#### æš—å·åŒ–å®Ÿè£…" >> security_report.md
          if grep -r -i "crypto\|encrypt\|decrypt\|hash" src/ > crypto_check.txt && [ -s crypto_check.txt ]; then
            if grep -r "hashlib\.md5\|hashlib\.sha1" src/ > weak_crypto.txt && [ -s weak_crypto.txt ]; then
              echo "âš ï¸ **å¼±ã„æš—å·åŒ–ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ä½¿ç”¨**" >> security_report.md
              echo '```' >> security_report.md
              cat weak_crypto.txt >> security_report.md
              echo '```' >> security_report.md
            else
              echo "âœ… æš—å·åŒ–å®Ÿè£…: é©åˆ‡" >> security_report.md
            fi
          else
            echo "â„¹ï¸ æš—å·åŒ–æ©Ÿèƒ½: æœªæ¤œå‡º" >> security_report.md
          fi
          echo "" >> security_report.md

          # å€‹äººæƒ…å ±ä¿è­·ãƒã‚§ãƒƒã‚¯
          echo "#### å€‹äººæƒ…å ±ä¿è­·" >> security_report.md
          PII_PATTERNS=("email" "phone" "address" "ssn" "credit.*card" "å€‹äººæƒ…å ±" "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" "é›»è©±ç•ªå·")
          PII_FOUND=0

          for pattern in "${PII_PATTERNS[@]}"; do
            if grep -r -i "$pattern.*log\|print.*$pattern" src/ 2>/dev/null > pii_check.txt && [ -s pii_check.txt ]; then
              if [ $PII_FOUND -eq 0 ]; then
                echo "ğŸš¨ **å€‹äººæƒ…å ±ã®ãƒ­ã‚°å‡ºåŠ›ã®å¯èƒ½æ€§**" >> security_report.md
                echo "" >> security_report.md
              fi
              SECRETS_FOUND=1
              echo "- ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º: $pattern" >> security_report.md
            fi
          done

          if [ $PII_FOUND -eq 0 ]; then
            echo "âœ… **å€‹äººæƒ…å ±ä¿è­·: é©åˆ‡**" >> security_report.md
          fi

      - name: Run Custom Vulnerability Management System
        run: |
          echo "### ğŸ¯ çµ±åˆè„†å¼±æ€§ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ " >> security_report.md
          echo "" >> security_report.md

          # ã‚«ã‚¹ã‚¿ãƒ è„†å¼±æ€§ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ å®Ÿè¡Œ
          python -c '
import asyncio
import sys
import os
sys.path.insert(0, "src")

async def run_vulnerability_scan():
    try:
        from day_trade.security.vulnerability_manager import create_vulnerability_manager

        # è„†å¼±æ€§ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
        manager = create_vulnerability_manager("security/vulnerabilities")

        # åŒ…æ‹¬çš„ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ
        scan_results = await manager.run_comprehensive_scan(".")

        # ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        report = await manager.generate_security_report()

        # çµæœå‡ºåŠ›
        print("#### ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚µãƒãƒªãƒ¼")
        summary = manager.get_vulnerability_summary()
        print(f"- **ç·è„†å¼±æ€§æ•°**: {summary[\"total_vulnerabilities\"]}")
        print(f"- **æœŸé™è¶…é**: {summary[\"overdue_count\"]}")
        print(f"- **é‡è¦ãªæœªè§£æ±º**: {summary[\"critical_open\"]}")
        print("")

        if summary["by_severity"]:
            print("#### é‡è¦åº¦åˆ¥å†…è¨³")
            for severity, count in summary["by_severity"].items():
                if count > 0:
                    emoji = {"CRITICAL": "ğŸ”´", "HIGH": "ğŸŸ ", "MEDIUM": "ğŸŸ¡", "LOW": "ğŸŸ¢"}.get(severity, "âš«")
                    print(f"- {emoji} **{severity}**: {count}ä»¶")

        print("")

        # æ¨å¥¨äº‹é …
        if report["recommendations"]:
            print("#### æ¨å¥¨äº‹é …")
            for rec in report["recommendations"][:3]:  # ä¸Šä½3ä»¶
                print(f"- {rec}")

        print("")
        print(f"ğŸ“Š **ãƒ¬ãƒãƒ¼ãƒˆID**: {report[\"report_id\"]}")

        # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        await manager.cleanup()

        return True

    except Exception as e:
        print(f"âŒ **ã‚¨ãƒ©ãƒ¼**: {str(e)}")
        return False

success = asyncio.run(run_vulnerability_scan())
' >> security_report.md || echo "âš ï¸ ã‚«ã‚¹ã‚¿ãƒ è„†å¼±æ€§ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ" >> security_report.md

      - name: Upload security scan results
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: |
            security_report.md
            safety_results.json
            bandit_results.json

      - name: Comment security report on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
              const report = fs.readFileSync('security_report.md', 'utf8');

              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³çµæœ\n\n${report}\n\n---\n*è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆ - ${new Date().toISOString()}*`
              });
            } catch (error) {
              console.error('Error creating security issue:', error);

            }

      - name: Fail on critical security issues
        run: |
          # é«˜ãƒªã‚¹ã‚¯ã®è„†å¼±æ€§ã‚„é‡è¦ãªå•é¡ŒãŒã‚ã‚‹å ´åˆã¯å¤±æ•—
          if grep -q "ğŸš¨" security_report.md || grep -q "ğŸ”´ é«˜ãƒªã‚¹ã‚¯" security_report.md;
 then
            echo "Critical security issues found. Failing the workflow."
            exit 1
          fi

  license-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install pip-licenses
        run: |
          pip install pip-licenses
          pip install -r requirements.txt

      - name: Generate license report
        run: |
          echo "## ğŸ“„ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ç›£æŸ»ãƒ¬ãƒãƒ¼ãƒˆ" > license_report.md
          echo "" >> license_report.md
          echo "### ä½¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ãƒ©ã‚¤ã‚»ãƒ³ã‚¹" >> license_report.md
          echo "" >> license_report.md

          pip-licenses --format=markdown --output-file=licenses.md
          cat licenses.md >> license_report.md

          echo "" >> license_report.md
          echo "### ãƒ©ã‚¤ã‚»ãƒ³ã‚¹é©åˆæ€§ãƒã‚§ãƒƒã‚¯" >> license_report.md

          # å•é¡Œã®ã‚ã‚‹ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯
          PROBLEMATIC_LICENSES=("GPL" "LGPL" "AGPL" "SSPL")
          ISSUES_FOUND=0

          for license in "${PROBLEMATIC_LICENSES[@]}"; do
            if pip-licenses | grep -i "$license" > problematic.txt && [ -s problematic.txt ]; then
              if [ $ISSUES_FOUND -eq 0 ]; then
                echo "âš ï¸ **æ³¨æ„ãŒå¿…è¦ãªãƒ©ã‚¤ã‚»ãƒ³ã‚¹**" >> license_report.md
                echo "" >> license_report.md
                ISSUES_FOUND=1
              fi
              echo "- $license ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ:" >> license_report.md
              cat problematic.txt >> license_report.md
            fi
          done

          if [ $ISSUES_FOUND -eq 0 ]; then
            echo "âœ… **ãƒ©ã‚¤ã‚»ãƒ³ã‚¹é©åˆæ€§: å•é¡Œãªã—**" >> license_report.md
          fi

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-audit-report
          path: license_report.md

  container-security:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image for scanning
        run: |
          cat > Dockerfile.security << 'EOF'
          FROM python:3.12-slim

          WORKDIR /app
          COPY requirements.txt .
          RUN pip install --no-cache-dir -r requirements.txt

          COPY src/ ./src/

          EXPOSE 8000
          CMD ["python", "-m", "src.day_trade.main"]
          EOF

          docker build -t day-trade-security-scan -f Dockerfile.security .

      - name: Run container security scan
        run: |
          # Trivy for container vulnerability scanning
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

          echo "## ğŸ³ ã‚³ãƒ³ãƒ†ãƒŠã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³" > container_security_report.md
          echo "" >> container_security_report.md

          trivy image --format json --output trivy_results.json day-trade-security-scan

          # çµæœã‚’è§£æã—ã¦ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          python -c "
            import json
            try:
                with open('trivy_results.json') as f:
                    data = json.load(f)

                total_vulns = 0
                critical = 0
                high = 0
                medium = 0
                low = 0

                for result in data.get('Results', []):
                    for vuln in result.get('Vulnerabilities', []):
                        total_vulns += 1
                        severity = vuln.get('Severity', '')
                        if severity == 'CRITICAL':
                            critical += 1
                        elif severity == 'HIGH':
                            high += 1
                        elif severity == 'MEDIUM':
                            medium += 1
                        elif severity == 'LOW':
                            low += 1

                print('### è„†å¼±æ€§ã‚µãƒãƒªãƒ¼')
                print(f'- **ç·è„†å¼±æ€§æ•°**: {total_vulns}')
                print(f'- ğŸ”´ **Critical**: {critical}')
                print(f'- ğŸŸ  **High**: {high}')
                print(f'- ğŸŸ¡ **Medium**: {medium}')
                print(f'- ğŸŸ¢ **Low**: {low}')
                print('')

                if critical > 0:
                    print('ğŸš¨ **é‡å¤§ãªè„†å¼±æ€§ãŒç™ºè¦‹ã•ã‚Œã¾ã—ãŸã€‚å³åº§ã®å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚**')
                elif high > 0:
                    print('âš ï¸ **é«˜ãƒªã‚¹ã‚¯ã®è„†å¼±æ€§ãŒç™ºè¦‹ã•ã‚Œã¾ã—ãŸã€‚å¯¾å¿œã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚**')
                else:
                    print('âœ… **é‡å¤§ãªè„†å¼±æ€§ã¯ç™ºè¦‹ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚**')

            except Exception as e:
                print(f'ã‚¨ãƒ©ãƒ¼: {e}')
" >> container_security_report.md

      - name: Upload container scan results
        uses: actions/upload-artifact@v4
        with:
          name: container-security-scan
          path: |
            container_security_report.md
            trivy_results.json

  security-summary:
    runs-on: ubuntu-latest
    needs: [dependency-scan, license-audit, container-security]
    if: always()
    steps:
      - name: Download all security artifacts
        uses: actions/download-artifact@v4

      - name: Create comprehensive security summary
        run: |
          echo "# ğŸ”’ åŒ…æ‹¬çš„ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ãƒ¬ãƒãƒ¼ãƒˆ" > security_summary.md
          echo "" >> security_summary.md
          echo "**å®Ÿè¡Œæ—¥æ™‚**: $(date -u)" >> security_summary.md
          echo "**ã‚³ãƒŸãƒƒãƒˆ**: ${GITHUB_SHA:0:7}" >> security_summary.md
          echo "**ãƒ–ãƒ©ãƒ³ãƒ**: ${GITHUB_REF}" >> security_summary.md
          echo "" >> security_summary.md

          # å„ãƒ¬ãƒãƒ¼ãƒˆã‚’çµ±åˆ
          for report_dir in */; do
            if [ -d "$report_dir" ]; then
              echo "## ğŸ“‹ $(basename "$report_dir")" >> security_summary.md
              echo "" >> security_summary.md

              for file in "$report_dir"/*.md; do
                if [ -f "$file" ]; then
                  cat "$file" >> security_summary.md

                fi
              done
            fi
          done

          echo "---" >> security_summary.md
          echo "*ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*" >> security_summary.md

      - name: Create security issue if problems found
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
              const summary = fs.readFileSync('security_summary.md', 'utf8');

              // é‡è¦ãªå•é¡ŒãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
              const hasCriticalIssues = summary.includes('ğŸš¨') ||
                                       summary.includes('ğŸ”´ é«˜ãƒªã‚¹ã‚¯') ||
                                       summary.includes('Critical');

              if (hasCriticalIssues) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã§é‡è¦ãªå•é¡Œã‚’æ¤œå‡º - ${new Date().toISOString().split('T')[0]}`,
                  body: summary,
                  labels: ['security', 'high-priority', 'automated'],
                  assignees: ['kaenozu']
                });
              }

            } catch (error) {

              console.error('Error creating security issue:', error);

            }

      - name: Upload comprehensive security report
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-security-report
          path: security_summary.md
