name: Pre-commit Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    name: Run pre-commit hooks

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pre-commit
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-v5-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-v5-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Install project dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          if [ -f pyproject.toml ]; then
            pip install -e .
          fi

      - name: Run pre-commit hooks
        run: |
          echo "ğŸ” Running pre-commit hooks..."
          pre-commit run --all-files --show-diff-on-failure
          # è‡ªå‹•ä¿®æ­£ã•ã‚ŒãŸå¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
          if [[ $(git status --porcelain) ]]; then
            git config user.name github-actions
            git config user.email github-actions@github.com
            git add .
            git commit --amend --no-edit
            git push
          fi

      - name: Comment PR with pre-commit results
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## âŒ Pre-commit Checks Failed

            ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§pre-commitãƒ•ãƒƒã‚¯ã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

            ### ğŸ”§ è§£æ±ºæ–¹æ³•:

            1. **ãƒ­ãƒ¼ã‚«ãƒ«ã§pre-commitã‚’å®Ÿè¡Œã—ã¦ä¿®æ­£:**
               \`\`\`bash
               # pre-commitãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆ
               pip install pre-commit
               pre-commit install

               # ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦pre-commitã‚’å®Ÿè¡Œ
               pre-commit run --all-files
               \`\`\`

            2. **è‡ªå‹•ä¿®æ­£å¯èƒ½ãªå•é¡Œã‚’ä¿®æ­£:**
               \`\`\`bash
               # Ruffã«ã‚ˆã‚‹è‡ªå‹•ä¿®æ­£
               ruff check --fix .
               ruff format .
               \`\`\`

            3. **å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥:**
               \`\`\`bash
               git add .
               git commit -m "Fix pre-commit issues"
               git push
               \`\`\`

            ### ğŸ“Š å«ã¾ã‚Œã‚‹ãƒã‚§ãƒƒã‚¯:
            - **Ruff**: ã‚³ãƒ¼ãƒ‰å“è³ªã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            - **MyPy**: å‹ãƒã‚§ãƒƒã‚¯
            - **Bandit**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
            - **ä¸€èˆ¬çš„ãªãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯**: æœ«å°¾ã®ç©ºç™½ã€æ”¹è¡Œã€YAMLå½¢å¼ãªã©

            ä¿®æ­£å¾Œã€ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯è‡ªå‹•çš„ã«å†å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Success notification
        if: success()
        run: |
          echo "âœ… All pre-commit hooks passed successfully!"
