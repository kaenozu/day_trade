name: Pre-commit Checks

on:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    name: Run pre-commit hooks

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache pre-commit
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-v5-${{ hashFiles('config/.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-v5-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Install project dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          if [ -f pyproject.toml ]; then
            pip install -e .
          fi

      - name: Run pre-commit hooks
        run: |
          echo "ğŸ” Running pre-commit hooks..."
          pre-commit run --all-files --show-diff-on-failure --config config/.pre-commit-config.yaml

          # ä¿®æ­£ã•ã‚ŒãŸå¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if [[ $(git status --porcelain) ]]; then
            echo "âš ï¸ Pre-commit hooks made changes to files"
            echo "Changes detected:"
            git status --porcelain
            git diff --name-only

            # GitHub Actionsã§ã¯ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã‚’ç›´æ¥ãƒ—ãƒƒã‚·ãƒ¥ã—ãªã„
            # ä»£ã‚ã‚Šã«ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦å¤‰æ›´ã‚’ä¿å­˜
            echo "Saving changes as artifact for manual review..."
            git add .
            git diff --cached > pre-commit-changes.patch

            # PRã®å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã§é€šçŸ¥
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              echo "pre_commit_changes=true" >> $GITHUB_ENV
            fi
          else
            echo "âœ… No changes made by pre-commit hooks"
            echo "pre_commit_changes=false" >> $GITHUB_ENV
          fi

      - name: Upload pre-commit changes artifact
        if: env.pre_commit_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: pre-commit-changes-${{ github.run_number }}
          path: |
            pre-commit-changes.patch
            config/.pre-commit-config.yaml
          retention-days: 7

      - name: Comment PR with pre-commit changes
        if: env.pre_commit_changes == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## âš ï¸ Pre-commit Hooks Made Changes

            Pre-commitãƒ•ãƒƒã‚¯ãŒãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•ä¿®æ­£ã—ã¾ã—ãŸã€‚å¤‰æ›´å†…å®¹ã‚’ç¢ºèªã—ã¦ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚

            ### ğŸ“¥ å¤‰æ›´å†…å®¹ã®é©ç”¨:

            1. **ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‹ã‚‰å¤‰æ›´ã‚’é©ç”¨:**
               ```bash
               # GitHubã‹ã‚‰ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
               gh run download ${{ github.run_id }} --name pre-commit-changes-${{ github.run_number }}

               # ãƒ‘ãƒƒãƒã‚’é©ç”¨
               git apply pre-commit-changes.patch
               git add .
               git commit -m "Apply pre-commit fixes"
               git push
               ```

            2. **ã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§pre-commitã‚’å®Ÿè¡Œ:**
               ```bash
               # pre-commitãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆ
               pip install pre-commit
               pre-commit install

               # ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦pre-commitã‚’å®Ÿè¡Œ
               pre-commit run --all-files --config config/.pre-commit-config.yaml

               # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
               git add .
               git commit -m "Fix pre-commit issues"
               git push
               ```

            ### ğŸ“Š å«ã¾ã‚Œã‚‹ãƒã‚§ãƒƒã‚¯:
            - **Ruff**: ã‚³ãƒ¼ãƒ‰å“è³ªã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            - **MyPy**: å‹ãƒã‚§ãƒƒã‚¯
            - **Bandit**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
            - **ä¸€èˆ¬çš„ãªãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯**: æœ«å°¾ã®ç©ºç™½ã€æ”¹è¡Œã€YAMLå½¢å¼ãªã©

            å¤‰æ›´ã‚’é©ç”¨å¾Œã€ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯è‡ªå‹•çš„ã«å†å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Comment PR with pre-commit results
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## âŒ Pre-commit Checks Failed

            ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§pre-commitãƒ•ãƒƒã‚¯ã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

            ### ğŸ”§ è§£æ±ºæ–¹æ³•:

            1. **ãƒ­ãƒ¼ã‚«ãƒ«ã§pre-commitã‚’å®Ÿè¡Œã—ã¦ä¿®æ­£:**
               ```bash
               # pre-commitãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆ
               pip install pre-commit
               pre-commit install

               # ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦pre-commitã‚’å®Ÿè¡Œ
               pre-commit run --all-files --config config/.pre-commit-config.yaml
               ```

            2. **è‡ªå‹•ä¿®æ­£å¯èƒ½ãªå•é¡Œã‚’ä¿®æ­£:**
               ```bash
               # Ruffã«ã‚ˆã‚‹è‡ªå‹•ä¿®æ­£
               ruff check --fix .
               ruff format .
               ```

            3. **å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥:**
               ```bash
               git add .
               git commit -m "Fix pre-commit issues"
               git push
               ```

            ### ğŸ“Š å«ã¾ã‚Œã‚‹ãƒã‚§ãƒƒã‚¯:
            - **Ruff**: ã‚³ãƒ¼ãƒ‰å“è³ªã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            - **MyPy**: å‹ãƒã‚§ãƒƒã‚¯
            - **Bandit**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
            - **ä¸€èˆ¬çš„ãªãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯**: æœ«å°¾ã®ç©ºç™½ã€æ”¹è¡Œã€YAMLå½¢å¼ãªã©

            ä¿®æ­£å¾Œã€ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯è‡ªå‹•çš„ã«å†å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Success notification
        if: success()
        run: |
          echo "âœ… All pre-commit hooks passed successfully!"