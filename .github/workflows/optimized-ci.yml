name: Optimized CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  statuses: write
  checks: write

env:
  PYTHON_VERSION: '3.11'
  CACHE_VERSION: v4
  PYTHONDONTWRITEBYTECODE: 1
  PYTHONUNBUFFERED: 1

jobs:
  # æœ€é©åŒ–ã•ã‚ŒãŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨å¤‰æ›´æ¤œå‡º
  setup:
    runs-on: ubuntu-latest
    outputs:
      python: ${{ steps.changes.outputs.python }}
      docs: ${{ steps.changes.outputs.docs }}
      config: ${{ steps.changes.outputs.config }}
      tests: ${{ steps.changes.outputs.tests }}
      cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}
    steps:
      - name: ğŸ“¥ Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ” Detect changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            python:
              - 'src/**/*.py'
              - 'tests/**/*.py'
              - '*.py'
              - 'pyproject.toml'
              - 'requirements*.txt'
            docs:
              - '**/*.md'
              - 'docs/**'
            config:
              - '.github/**'
              - '.pre-commit-config.yaml'
              - '*.toml'
              - '*.yml'
              - '*.yaml'
            tests:
              - 'tests/**'

      - name: ğŸ Setup Python (with cache)
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Cache dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pre-commit
            .venv
          key: deps-${{ env.CACHE_VERSION }}-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('**/pyproject.toml', '**/requirements*.txt', '.pre-commit-config.yaml') }}
          restore-keys: |
            deps-${{ env.CACHE_VERSION }}-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-

      - name: ğŸ’¡ Install dependencies (if cache miss)
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          python -m pip install --upgrade pip wheel
          pip install -e .[dev]
          pre-commit install-hooks

  # æœ€é©åŒ–ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰å“è³ªã¨é™çš„è§£æ
  quality:
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.python == 'true' || needs.setup.outputs.config == 'true'
    name: ğŸ” Quality Check
    steps:
      - name: ğŸ“¥ Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Restore cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pre-commit
            .venv
          key: deps-${{ env.CACHE_VERSION }}-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('**/pyproject.toml', '**/requirements*.txt', '.pre-commit-config.yaml') }}

      - name: ğŸ’¡ Install dependencies (if needed)
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: ğŸš€ Fast linting (changed files only)
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "ğŸ” Linting changed files only..."
            # Fetch base branch for comparison
            git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}
            # å¤‰æ›´ã•ã‚ŒãŸPythonãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯
            changed_files=$(git diff --name-only --diff-filter=AM ${{ github.base_ref }}..HEAD | grep '\.py$' || true)
            if [ -n "$changed_files" ]; then
              echo "$changed_files" | xargs ruff check --fix
              echo "$changed_files" | xargs ruff format
            else
              echo "No Python files changed"
            fi
            # è‡ªå‹•ä¿®æ­£ã•ã‚ŒãŸå¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
            if [[ $(git status --porcelain) ]]; then
              git config user.name github-actions
              git config user.email github-actions@github.com
              git add .
              git commit --amend --no-edit
              git push
            fi
          else
            echo "ğŸ” Linting all files..."
            ruff check --fix src/ tests/ || true
            ruff format --check src/ tests/ || true
          fi

      - name: ğŸ’¡ Pre-commit (incremental)
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}
            pre-commit run --from-ref ${{ github.base_ref }} --to-ref HEAD
            # è‡ªå‹•ä¿®æ­£ã•ã‚ŒãŸå¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
            if [[ $(git status --porcelain) ]]; then
              git config user.name github-actions
              git config user.email github-actions@github.com
              git add .
              git commit --amend --no-edit
              git push
            fi
          else
            pre-commit run --all-files --show-diff-on-failure
          fi

  # æœ€é©åŒ–ã•ã‚ŒãŸãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  test:
    runs-on: ubuntu-latest
    needs: [setup, quality]
    if: needs.setup.outputs.python == 'true' || needs.setup.outputs.tests == 'true'
    name: ğŸ§ª Tests
    strategy:
      fail-fast: false
      matrix:
        test-type: ['unit-fast', 'unit-slow', 'integration']
    steps:
      - name: ğŸ“¥ Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Restore cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pre-commit
            .venv
          key: deps-${{ env.CACHE_VERSION }}-${{ runner.os }}-py${{ env.PYTHON_VERSION }}-${{ hashFiles('**/pyproject.toml', '**/requirements*.txt', '.pre-commit-config.yaml') }}

      - name: ğŸ’¡ Install dependencies (if needed)
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: ğŸš€ Run tests (${{ matrix.test-type }})
        run: |
          case "${{ matrix.test-type }}" in
            "unit-fast")
              echo "ğŸš€ Running fast unit tests..."
              pytest tests/ -v --tb=short --disable-warnings \
                     --ignore=tests/integration/ \
                     -m "not slow" \
                     --maxfail=10 \
                     --cov=src/day_trade \
                     --cov-report=xml \
                     --cov-report=html \
                     --cov-report=term-missing \
                     --cov-report=json \
                     --cov-fail-under=20
              ;;
            "unit-slow")
              echo "ğŸŒ Running slow unit tests..."
              pytest tests/ -v --tb=short \
                           --ignore=tests/integration/ \
                           -m "slow" \
                           --disable-warnings || echo "No slow tests found"
              ;;
            "integration")
              echo "ğŸ”— Running integration tests..."
              pytest tests/integration/ -v --tb=short \
                                       --disable-warnings \
                                       --integration \
                                       --cov=src/day_trade \
                                       --cov-append \
                                       --slow
              ;;
          esac

      - name: ğŸ“Š Upload coverage to Codecov
        if: matrix.test-type == 'unit-fast'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: coverage-${{ matrix.test-type }}
        continue-on-error: true

      - name: ğŸ“‚ Upload coverage reports as artifacts
        if: matrix.test-type == 'unit-fast'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports-optimized
          path: |
            coverage.xml
            coverage.json
            htmlcov/
          retention-days: 30
        continue-on-error: true

  # ğŸ”’ æœ€é©åŒ–ã•ã‚ŒãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  security:
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.python == 'true'
    name: ğŸ”’ Security
    steps:
      - name: ğŸ“¥ Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ’¡ Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit[toml] semgrep

      - name: ğŸš€ Parallel security scan
        run: |
          echo "ğŸš€ Running parallel security scans..."
          (
            echo "ğŸ•µï¸ Safety check..."
            safety check --json > safety-report.json 2>/dev/null || echo "Safety check completed with warnings"
          ) &
          (
            echo "ğŸ•µï¸ Bandit scan..."
            bandit -r src/ -f json -o bandit-report.json -l 2>/dev/null || echo "Bandit scan completed"
          ) &
          (
            echo "ğŸ•µï¸ Semgrep scan..."
            semgrep --config=auto --json --output=semgrep-report.json src/ 2>/dev/null || echo "Semgrep scan completed"
          ) &
          wait
          echo "âœ… All security scans completed"

      - name: ğŸ“¤ Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports-${{ github.sha }}
          path: "*.json"
          retention-days: 30

  # ğŸ“¦ æœ€é©åŒ–ã•ã‚ŒãŸãƒ“ãƒ«ãƒ‰ã¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°
  build:
    runs-on: ubuntu-latest
    needs: [test, security]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped') && (needs.security.result == 'success' || needs.security.result == 'skipped')
    name: ğŸ“¦ Build
    steps:
      - name: ğŸ“¥ Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: ğŸš€ Fast build
        run: |
          echo "ğŸ“¦ Building package..."
          python -m build --wheel

      - name: âœ… Quick package check
        run: |
          echo "âœ… Checking package..."
          python -m twine check dist/*

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ github.sha }}
          path: dist/
          retention-days: 90

  # æœ€é©åŒ–ã•ã‚ŒãŸçµ±åˆãƒã‚§ãƒƒã‚¯
  status:
    runs-on: ubuntu-latest
    needs: [setup, quality, test, security, build]
    if: always()
    name: ğŸ“Š Status
    steps:
      - name: â±ï¸ Calculate CI duration
        id: duration
        run: |
          start_time="${{ github.event.head_commit.timestamp }}"
          current_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "CI started at: $start_time"
          echo "CI finished at: $current_time"

      - name: ğŸ“Š Final status check
        run: |
          echo "ğŸ“Š Final CI Status Report:"
          echo "==============================="
          echo "Setup: ${{ needs.setup.result }}"
          echo "Quality: ${{ needs.quality.result }}"
          echo "Tests: ${{ needs.test.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Build: ${{ needs.build.result }}"

          # å…¨ã¦ã®å¿…é ˆã‚¸ãƒ§ãƒ–ãŒæˆåŠŸã¾ãŸã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸã‚‰æˆåŠŸ
          if [[ \
            "${{ needs.setup.result }}" == "success" && \
            ("${{ needs.quality.result }}" == "success" || "${{ needs.quality.result }}" == "skipped") && \
            ("${{ needs.test.result }}" == "success" || "${{ needs.test.result }}" == "skipped") && \
            ("${{ needs.security.result }}" == "success" || "${{ needs.security.result }}" == "skipped") && \
            ("${{ needs.build.result }}" == "success" || "${{ needs.build.result }}" == "skipped") \
          ]]; then
            echo "ğŸ‰ CI Pipeline completed successfully!"
            echo "ğŸš€ Optimized execution with smart caching and parallel processing"
            exit 0
          else
            echo "âŒ CI Pipeline failed"
            exit 1
          fi

  # è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy:
    runs-on: ubuntu-latest
    needs: [status]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && needs.status.result == 'success'
    environment: production
    name: ğŸš€ Deploy
    steps:
      - name: ğŸš€ Deployment preparation
        run: |
          echo "ğŸš€ Ready for deployment"
          echo "Branch: ${{ github.ref }}"
          echo "Event: ${{ github.event.name }}"
          echo "TODO: Implement deployment logic here"
