name: Merge Conflict Detection

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  conflict-detection:
    runs-on: ubuntu-latest
    name: Detect merge conflicts

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch all branches
        run: |
          git fetch --all
          echo "ğŸ” Available branches:"
          git branch -r

      - name: Check for merge conflicts with main
        id: conflict_check
        run: |
          set -e

          echo "ğŸ¯ Checking merge conflicts for branch: ${{ github.head_ref || github.ref_name }}"
          echo "ğŸ“‹ Base branch: ${{ github.base_ref || 'main' }}"

          # Get the correct branch names
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CURRENT_BRANCH="${{ github.head_ref }}"
            BASE_BRANCH="${{ github.base_ref }}"
          else
            CURRENT_BRANCH="${{ github.ref_name }}"
            BASE_BRANCH="main"
          fi

          echo "current_branch=$CURRENT_BRANCH" >> $GITHUB_ENV
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_ENV

          # Skip conflict check if we're on the base branch
          if [ "$CURRENT_BRANCH" = "$BASE_BRANCH" ]; then
            echo "â­ï¸ Skipping conflict check - currently on base branch"
            echo "conflict_detected=false" >> $GITHUB_ENV
            echo "skip_check=true" >> $GITHUB_ENV
            exit 0
          fi

          # Ensure we have the latest changes
          git fetch origin $BASE_BRANCH:$BASE_BRANCH || git fetch origin $BASE_BRANCH
          git fetch origin $CURRENT_BRANCH:$CURRENT_BRANCH || git checkout $CURRENT_BRANCH

          # Create a temporary branch for merge test
          TEMP_BRANCH="temp-merge-test-$(date +%s)"
          git checkout -b $TEMP_BRANCH "origin/$CURRENT_BRANCH"

          echo "ğŸ”„ Attempting merge of $BASE_BRANCH into $CURRENT_BRANCH..."

          # Try to merge - capture both stdout and stderr
          if git merge origin/$BASE_BRANCH --no-commit --no-ff 2>&1 | tee merge_output.log; then
            echo "âœ… No merge conflicts detected"
            echo "conflict_detected=false" >> $GITHUB_ENV
            git merge --abort 2>/dev/null || true
          else
            echo "âš ï¸ Merge conflicts detected!"
            echo "conflict_detected=true" >> $GITHUB_ENV

            # Get list of conflicted files
            CONFLICTED_FILES=$(git diff --name-only --diff-filter=U 2>/dev/null || echo "Could not determine conflicted files")
            echo "conflicted_files<<EOF" >> $GITHUB_ENV
            echo "$CONFLICTED_FILES" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV

            # Save merge output for later use
            echo "merge_output<<EOF" >> $GITHUB_ENV
            cat merge_output.log >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV

            # Show conflict details
            echo "ğŸ“‹ Conflicted files:"
            echo "$CONFLICTED_FILES"

            git merge --abort 2>/dev/null || true
          fi

          # Cleanup
          git checkout $CURRENT_BRANCH 2>/dev/null || git checkout -
          git branch -D $TEMP_BRANCH 2>/dev/null || true

      - name: Check for potential conflicts in common areas
        if: env.skip_check != 'true'
        id: pattern_check
        run: |
          echo "ğŸ” Checking for potential conflict patterns..."

          # Check for common conflict markers that might have been committed
          CONFLICT_MARKERS=$(grep -r '<<<<<<< ' . --exclude-dir=.git --exclude-dir=node_modules --exclude-dir=scripts --exclude-dir=.github --exclude="*.log" || echo "")

          if [ -n "$CONFLICT_MARKERS" ]; then
            echo "âš ï¸ Found potential conflict markers in files:"
            echo "$CONFLICT_MARKERS"
            echo "conflict_markers_found=true" >> $GITHUB_ENV
            echo "conflict_markers<<EOF" >> $GITHUB_ENV
            echo "$CONFLICT_MARKERS" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "âœ… No conflict markers found"
            echo "conflict_markers_found=false" >> $GITHUB_ENV
          fi

      - name: Analyze file change patterns
        if: env.skip_check != 'true' && github.event_name == 'pull_request'
        id: change_analysis
        run: |
          echo "ğŸ“Š Analyzing change patterns..."

          # Get changed files in this PR
          CHANGED_FILES=$(git diff --name-only origin/${{ env.base_branch }}..HEAD || echo "")

          # Check for changes in sensitive areas
          HIGH_RISK_CHANGES=""

          # Configuration files
          if echo "$CHANGED_FILES" | grep -E "\.(yml|yaml|json|ini|cfg|conf)$"; then
            HIGH_RISK_CHANGES="$HIGH_RISK_CHANGES\nğŸ“ Configuration files"
          fi

          # Database migration files
          if echo "$CHANGED_FILES" | grep -E "migration|schema|database"; then
            HIGH_RISK_CHANGES="$HIGH_RISK_CHANGES\nğŸ—„ï¸ Database-related files"
          fi

          # CI/CD files
          if echo "$CHANGED_FILES" | grep -E "\.github|\.gitlab|\.circleci|Dockerfile|docker-compose"; then
            HIGH_RISK_CHANGES="$HIGH_RISK_CHANGES\nğŸ”§ CI/CD configuration"
          fi

          # Core system files
          if echo "$CHANGED_FILES" | grep -E "(main|core|base|foundation)\.(py|js|ts)$"; then
            HIGH_RISK_CHANGES="$HIGH_RISK_CHANGES\nâš¡ Core system files"
          fi

          if [ -n "$HIGH_RISK_CHANGES" ]; then
            echo "high_risk_changes=true" >> $GITHUB_ENV
            echo "high_risk_areas<<EOF" >> $GITHUB_ENV
            echo "$HIGH_RISK_CHANGES" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "high_risk_changes=false"
          fi

          echo "changed_files<<EOF" >> $GITHUB_ENV
          echo "$CHANGED_FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Comment on PR - Conflicts Detected
        if: env.conflict_detected == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const conflictedFiles = process.env.conflicted_files || 'Unknown files';
            const mergeOutput = process.env.merge_output || 'No detailed output available';

            const body = `## âš ï¸ ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ

            ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ 
${{ env.base_branch }}
 ãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸ã™ã‚‹éš›ã«ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒç™ºç”Ÿã—ã¾ã™ã€‚

            ### ğŸ”§ ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã®è§£æ±ºæ‰‹é †:

            1. **ãƒ­ãƒ¼ã‚«ãƒ«ã§æœ€æ–°ã®å¤‰æ›´ã‚’å–å¾—:**
               ```bash
               git checkout ${{ env.current_branch }}
               git fetch origin
               git pull origin ${{ env.current_branch }}
               ```

            2. **ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã®æœ€æ–°å¤‰æ›´ã‚’ãƒãƒ¼ã‚¸:**
               ```bash
               git merge origin/${{ env.base_branch }}
               ```

            3. **ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’æ‰‹å‹•ã§è§£æ±º:**
               ```bash
               # ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã§ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†
               # <<<<<<< HEAD, =======, >>>>>>> ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
               git add <è§£æ±ºã—ãŸãƒ•ã‚¡ã‚¤ãƒ«å>
               ```

            4. **ãƒãƒ¼ã‚¸ã‚’ã‚³ãƒŸãƒƒãƒˆ:**
               ```bash
               git commit -m "Resolve merge conflicts with ${{ env.base_branch }}"
               git push origin ${{ env.current_branch }}
               ```

            ### ğŸ“‹ ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«:
            ```
            ${conflictedFiles}
            ```

            ### ğŸ” è©³ç´°å‡ºåŠ›:
            <details>
            <summary>ãƒãƒ¼ã‚¸è©¦è¡Œã®è©³ç´°ãƒ­ã‚°</summary>

            ```
            ${mergeOutput}
            ```
            </details>

            ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒè§£æ±ºã•ã‚Œã‚‹ã¨ã€ã“ã®ãƒã‚§ãƒƒã‚¯ã¯è‡ªå‹•çš„ã«å†å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

            ---
            ğŸ¤– **è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆ** - ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Comment on PR - Conflict Markers Found
        if: env.conflict_markers_found == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const conflictMarkers = process.env.conflict_markers || 'No details available';

            const body = `## âš ï¸ ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒãƒ¼ã‚«ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ

            ã‚³ãƒ¼ãƒ‰å†…ã«ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒãƒ¼ã‚«ãƒ¼ (\`<<<<<<<
, \`=======
, \`>>>>>>>\`) ãŒæ®‹ã£ã¦ã„ã¾ã™ã€‚

            ### ğŸ” æ¤œå‡ºã•ã‚ŒãŸç®‡æ‰€:
            ```
            ${conflictMarkers}
            ```

            ### ğŸ”§ ä¿®æ­£æ–¹æ³•:
            1. ä¸Šè¨˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦ã€ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒãƒ¼ã‚«ãƒ¼ã‚’æ¢ã—ã¦ãã ã•ã„
            2. é©åˆ‡ãªã‚³ãƒ¼ãƒ‰ã‚’é¸æŠã—ã€ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„
            3. å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„

            ---
            ğŸ¤– **è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆ** - ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Comment on PR - High Risk Changes
        if: env.high_risk_changes == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const highRiskAreas = process.env.high_risk_areas || 'No details available';
            const changedFiles = process.env.changed_files || 'No files listed';

            const body = `## ğŸš¨ é«˜ãƒªã‚¹ã‚¯é ˜åŸŸã®å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ

            ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ä»¥ä¸‹ã®é‡è¦ãªé ˜åŸŸã«å¤‰æ›´ã‚’å«ã‚“ã§ã„ã¾ã™ï¼š

            ${highRiskAreas}

            ### ğŸ“‹ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:
            <details>
            <summary>å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</summary>

            ```
            ${changedFiles}
            ```
            </details>

            ### âš ï¸ æ³¨æ„äº‹é …:
            - ã‚ˆã‚Šè©³ç´°ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒæ¨å¥¨ã•ã‚Œã¾ã™
            - å¯èƒ½ã§ã‚ã‚Œã°æ®µéšçš„ãªãƒãƒ¼ã‚¸ã‚’æ¤œè¨ã—ã¦ãã ã•ã„
            - ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã®ååˆ†ãªæ¤œè¨¼ã‚’è¡Œã£ã¦ãã ã•ã„

            ---
            ğŸ¤– **è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆ** - ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Set status check result
        if: env.skip_check != 'true'
        run: |
          if [ "${{ env.conflict_detected }}" = "true" ]; then
            echo "âŒ Merge conflicts detected - failing check"
            exit 1
          elif [ "${{ env.conflict_markers_found }}" = "true" ]; then
            echo "âŒ Conflict markers found in code - failing check"
            exit 1
          else
            echo "âœ… No merge conflicts detected"
            echo "âœ… No conflict markers found in code"
          fi

      - name: Success notification
        if: success()
        run: |
          if [ "${{ env.skip_check }}" = "true" ]; then
            echo "â­ï¸ Conflict check skipped (base branch)"
          else
            echo "âœ… Merge conflict detection completed successfully!"
            echo "ğŸ‰ ã“ã®ãƒ–ãƒ©ãƒ³ãƒã¯ ${{ env.base_branch }} ã«å®‰å…¨ã«ãƒãƒ¼ã‚¸ã§ãã¾ã™"
          fi