name: Unified CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  checks: write
  actions: read

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # Phase 1: Basic validation
  validation:
    runs-on: ubuntu-latest
    name: Basic Validation
    outputs:
      has-python-changes: ${{ steps.changes.outputs.python }}
      has-config-changes: ${{ steps.changes.outputs.config }}
      has-ci-changes: ${{ steps.changes.outputs.ci }}
      should-run-tests: ${{ steps.changes.outputs.tests }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            python:
              - '**/*.py'
              - 'requirements*.txt'
              - 'pyproject.toml'
              - 'setup.py'
            config:
              - '**/*.yml'
              - '**/*.yaml'
              - '**/*.json'
              - '**/*.toml'
              - '**/*.ini'
            ci:
              - '.github/**'
              - '.pre-commit-config.yaml'
              - 'pytest.ini'

      - name: Validate basic structure
        run: |
          echo "üîç Validating repository structure..."

          # Check for required files
          REQUIRED_FILES=("requirements.txt" "pyproject.toml" "config/.pre-commit-config.yaml")

          for file in "${{ REQUIRED_FILES[@] }}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ Found: $file"
            else
              echo "‚ö†Ô∏è Missing recommended file: $file"
            fi
          done

      - name: Check Python syntax
        if: steps.changes.outputs.python == 'true'
        run: |
          echo "üêç Checking Python syntax..."
          python -m py_compile $(find . -name "*.py" -not -path "./.git/*" -not -path "./__pycache__/*" -not -path "./.pytest_cache/*" -not -path "./.benchmarks/*" -not -path "./.github/*" -not -path "./alembic/*" -not -path "./backend/*" -not -path "./backtest_data/*" -not -path "./backup/*" -not -path "./backups/*" -not -path "./benchmarks/*" -not -path "./cache/*" -not -path "./config/*" -not -path "./config_migration_backup/*" -not -path "./config_unified/*" -not -path "./coverage_reports/*" -not -path "./data/*" -not -path "./data_cache/*" -not -path "./day_trade.egg-info/*" -not -path "./deployment/*" -not -path "./disaster_recovery/*" -not -path "./docker/*" -not -path "./docs/*" -not -path "./examples/*" -not -path "./frontend/*" -not -path "./hyperparameter_optimization/*" -not -path "./integration_tests/*" -not -path "./k8s/*" -not -path "./kubernetes/*" -not -path "./logs/*" -not -path "./migrations/*" -not -path "./ml_models_data/*" -not -path "./mobile/*" -not -path "./monitoring/*" -not -path "./multi_timeframe_data/*" -not -path "./prediction_validation/*" -not -path "./refactoring_backup/*" -not -path "./reports/*" -not -path "./scripts/*" -not -path "./security/*" -not -path "./security_data/*" -not -path "./src/*" -not -path "./static/*" -not -path "./templates/*" -not -path "./test_reports/*" -not -path "./tests/*" -not -path "./trading_system/*" -not -path "./validation_data/*" -not -path "./verification_results/*" -not -path "./web/*" | head -20)" || echo "‚ö†Ô∏è Syntax issues detected"

  # Phase 2: Conflict detection
  conflict-detection:
    runs-on: ubuntu-latest
    name: Merge Conflict Detection
    needs: validation
    if: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run conflict detection
        uses: ./.github/actions/conflict-detector
        with:
          base-branch: ${{ github.base_ref }}
          current-branch: ${{ github.head_ref }}
          enable-auto-comment: 'true'

  # Phase 3: Code quality checks
  code-quality:
    runs-on: ubuntu-latest
    name: Code Quality Checks
    needs: validation
    if: needs.validation.outputs.has-python-changes == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/pre-commit
          key: ${{ runner.os }}-deps-${{ hashFiles('**/requirements*.txt', 'config/.pre-commit-config.yaml') }}
          restore-keys: |
            ${{ runner.os }}-deps-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          if [ -f requirements-dev.txt ]; then
            pip install -r requirements-dev.txt
          fi

      - name: Run pre-commit hooks
        run: |
          echo "üîç Running pre-commit hooks..."
          pre-commit run --all-files --show-diff-on-failure --config config/.pre-commit-config.yaml

      - name: Security scan
        run: |
          echo "üîê Running security scan..."
          pip install bandit safety

          # Bandit security scan
          bandit -r . -f json -o bandit-report.json || true

          # Safety dependency scan
          safety check --json --output safety-report.json || true

          echo "Security scans completed"

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports-${{ github.run_number }}
          path: |
            bandit-report.json
            safety-report.json
          retention-days: 30

  # Phase 4: Testing
  testing:
    runs-on: ubuntu-latest
    name: Testing Suite
    needs: [validation, code-quality]
    if: needs.validation.outputs.should-run-tests == 'true' || needs.validation.outputs.has-python-changes == 'true'

    strategy:
      matrix:
        test-type: [unit, integration]

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          if [ -f requirements-dev.txt ]; then
            pip install -r requirements-dev.txt
          fi
          pip install pytest pytest-cov pytest-xdist

      - name: Run tests
        run: |
          echo "üß™ Running ${{ matrix.test-type }} tests..."

          if [ "${{ matrix.test-type }}" == "unit" ]; then
            pytest tests/ -v --cov=. --cov-report=xml --cov-report=html -x -k "not integration" || true
          elif [ "${{ matrix.test-type }}" == "integration" ]; then
            pytest tests/ -v -k "integration" || true
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.test-type }}-${{ github.run_number }}
          path: |
            htmlcov/
            coverage.xml
            pytest.xml
          retention-days: 14

  # Phase 5: Configuration validation
  config-validation:
    runs-on: ubuntu-latest
    name: Configuration Validation
    needs: validation
    if: needs.validation.outputs.has-config-changes == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate YAML files
        run: | 
          echo "üìÑ Validating YAML files..."
          pip install pyyaml

          find . -name "*.yml" -o -name "*.yaml" | while read file; do
            echo "Checking: $file"
            python -c "import yaml; yaml.safe_load(open('$file'))" || echo "‚ùå Invalid YAML: $file"
          done

      - name: Validate JSON files
        run: |
          echo "üìÑ Validating JSON files..."

          find . -name "*.json" | while read file; do
            echo "Checking: $file"
            python -c "import json; json.load(open('$file'))" || echo "‚ùå Invalid JSON: $file"
          done

      - name: Check configuration consistency
        run: |
          echo "üîç Checking configuration consistency..."

          # Example checks - customize based on your specific configs
          if [ -f "config/settings.json" ] && [ -f "config/production.yaml" ]; then
            echo "‚úÖ Configuration files found"
          fi

  # Phase 6: Build and deployment readiness
  build-check:
    runs-on: ubuntu-latest
    name: Build Readiness Check
    needs: [validation, code-quality, testing, config-validation]
    if: always() && (needs.code-quality.result == 'success' || needs.code-quality.result == 'skipped')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build wheel

      - name: Test package build
        run: |
          echo "üì¶ Testing package build..."
          if [ -f "pyproject.toml" ]; then
            python -m build --wheel --sdist . || echo "‚ö†Ô∏è Build test failed"
          else
            echo "‚ÑπÔ∏è No pyproject.toml found, skipping build test"
          fi

      - name: Check import paths
        run: |
          echo "üîç Checking import paths..."
          python -c "
          import sys
          import importlib.util

          # Test core imports
          core_modules = ['src.day_trade', 'daytrade', 'day_trading_engine']

          for module in core_modules:
              try:
                  spec = importlib.util.find_spec(module)
                  if spec:
                      print(f'‚úÖ Can import: {module}')
                  else:
                      print(f'‚ö†Ô∏è Cannot find: {module}')
              except Exception as e:
                  print(f'‚ùå Import error for {module}: {e}')
          " || true

  # Phase 7: Lighthouse CI Action
  lighthouse:
    runs-on: ubuntu-latest
    name: Lighthouse CI Action
    needs: build-check # Assuming build-check ensures the web server can be started
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Start web server
      run: |
        gunicorn --config gunicorn.conf.py daytrade_web:app &
        sleep 10

    - name: Run Lighthouse CI Action
      uses: treosh/lighthouse-ci-action@v10
      with:
        urls: 'http://localhost:8000/'

  # Phase 8: Build and Deployment
  build-and-deploy:
    needs: [validation, code-quality, testing, config-validation, build-check, lighthouse]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha
          type=raw,value=latest,enable={{is_default_branch}}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Deploy to staging
      if: github.ref == 'refs/heads/develop'
      run: |
        echo "Deploy to staging environment"
        # Add staging deployment commands here

    - name: Deploy to production
      if: github.ref == 'refs/heads/main'
      run: |
        echo "Deploy to production environment"
        # Add production deployment commands here

  # Phase 9: Final status report
  status-report:
    runs-on: ubuntu-latest
    name: CI Status Report
    needs: [validation, conflict-detection, code-quality, testing, config-validation, build-check, lighthouse, build-and-deploy]
    if: always()

    steps:
      - name: Generate status report
        run: |
          echo "üìä CI/CD Pipeline Status Report"
          echo "==============================="
          echo ""
          echo "Phase Results:"
          echo "- Validation: ${{ needs.validation.result }}"
          echo "- Conflict Detection: ${{ needs.conflict-detection.result }}"
          echo "- Code Quality: ${{ needs.code-quality.result }}"
          echo "- Testing: ${{ needs.testing.result }}"
          echo "- Config Validation: ${{ needs.config-validation.result }}"
          echo "- Build Check: ${{ needs.build-check.result }}"
          echo "- Lighthouse: ${{ needs.lighthouse.result }}"
          echo "- Build and Deploy: ${{ needs.build-and-deploy.result }}"
          echo ""

          # Determine overall status
          if [[ "${{ needs.validation.result }}" == "failure" ]]; then
            echo "‚ùå Pipeline failed at validation stage"
            exit 1
          elif [[ "${{ needs.conflict-detection.result }}" == "failure" ]]; then
            echo "‚ö†Ô∏è Merge conflicts detected - resolution required"
            exit 1
          elif [[ "${{ needs.code-quality.result }}" == "failure" ]]; then
            echo "‚ùå Code quality checks failed"
            exit 1
          elif [[ "${{ needs.testing.result }}" == "failure" ]]; then
            echo "‚ùå Tests failed"
            exit 1
          elif [[ "${{ needs.config-validation.result }}" == "failure" ]]; then
            echo "‚ùå Configuration validation failed"
            exit 1
          elif [[ "${{ needs.build-check.result }}" == "failure" ]]; then
            echo "‚ùå Build check failed"
            exit 1
          elif [[ "${{ needs.lighthouse.result }}" == "failure" ]]; then
            echo "‚ùå Lighthouse check failed"
            exit 1
          elif [[ "${{ needs.build-and-deploy.result }}" == "failure" ]]; then
            echo "‚ùå Build and Deploy failed"
            exit 1
          else
            echo "‚úÖ All checks passed successfully!"
          fi

      - name: Comment PR with status
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              validation: '${{ needs.validation.result }}',
              conflicts: '${{ needs.conflict-detection.result }}',
              quality: '${{ needs.code-quality.result }}',
              testing: '${{ needs.testing.result }}',
              config: '${{ needs.config-validation.result }}',
              build: '${{ needs.build-check.result }}',
              lighthouse: '${{ needs.lighthouse.result }}',
              deploy: '${{ needs.build-and-deploy.result }}'
            };

            const getStatusIcon = (status) => {
              switch(status) {
                case 'success': return '‚úÖ';
                case 'failure': return '‚ùå';
                case 'skipped': return '‚è≠Ô∏è';
                default: return '‚ö™';
              }
            };

            const body = `## üîç CI/CD Pipeline Status Report

            | Phase | Status | Result |
            |-------|--------|--------|
            | Validation | ${getStatusIcon(results.validation)} | ${results.validation} |
            | Conflict Detection | ${getStatusIcon(results.conflicts)} | ${results.conflicts} |
            | Code Quality | ${getStatusIcon(results.quality)} | ${results.quality} |
            | Testing | ${getStatusIcon(results.testing)} | ${results.testing} |
            | Config Validation | ${getStatusIcon(results.config)} | ${results.config} |
            | Build Check | ${getStatusIcon(results.build)} | ${results.build} |
            | Lighthouse | ${getStatusIcon(results.lighthouse)} | ${results.lighthouse} |
            | Build and Deploy | ${getStatusIcon(results.deploy)} | ${results.deploy} |

            --- 
            ü§ñ **Ëá™ÂãïÁîüÊàê„É¨„Éù„Éº„Éà** - Unified CI/CD Pipeline
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
