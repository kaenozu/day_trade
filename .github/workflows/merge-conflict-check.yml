# ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
# Issue #883å¯¾å¿œ: CIã§ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæ¤œçŸ¥ã™ã‚‹
name: Merge Conflict Detection

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  conflict-detection:
    runs-on: ubuntu-latest
    name: "ğŸ” ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæ¤œçŸ¥"

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          # PRãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch target branch
        run: |
          echo "ğŸ”„ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã®å–å¾—..."
          git fetch origin ${{ github.event.pull_request.base.ref }}:refs/remotes/origin/${{ github.event.pull_request.base.ref }}

      - name: Check for merge conflicts
        id: conflict-check
        run: |
          echo "ğŸ” ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã®æ¤œçŸ¥ã‚’é–‹å§‹..."

          TARGET_BRANCH="${{ github.event.pull_request.base.ref }}"
          PR_BRANCH="${{ github.event.pull_request.head.ref }}"
          PR_SHA="${{ github.event.pull_request.head.sha }}"

          echo "ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒ: $TARGET_BRANCH"
          echo "PRãƒ–ãƒ©ãƒ³ãƒ: $PR_BRANCH"
          echo "PR SHA: $PR_SHA"

          # ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã¨ã®å·®åˆ†ç¢ºèª
          echo "ğŸ“Š ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã¨ã®å·®åˆ†ç¢ºèª..."
          CHANGED_FILES=$(git diff --name-only origin/$TARGET_BRANCH..HEAD | wc -l)
          echo "å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $CHANGED_FILES"

          # ãƒ†ã‚¹ãƒˆãƒãƒ¼ã‚¸ã‚’å®Ÿè¡Œ
          echo "ğŸ§ª ãƒ†ã‚¹ãƒˆãƒãƒ¼ã‚¸ã®å®Ÿè¡Œ..."

          # ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã‚’ä¿å­˜
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

          # ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
          git checkout origin/$TARGET_BRANCH

          # ãƒ†ã‚¹ãƒˆãƒãƒ¼ã‚¸ã‚’è©¦è¡Œ
          MERGE_SUCCESS=true
          CONFLICT_FILES=""
          MERGE_OUTPUT=""

          if ! MERGE_OUTPUT=$(git merge --no-commit --no-ff $PR_SHA 2>&1); then
            MERGE_SUCCESS=false
            echo "âŒ ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"

            # ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å–å¾—
            CONFLICT_FILES=$(git diff --name-only --diff-filter=U | tr '\n' ' ')

            echo "ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: $CONFLICT_FILES"

            # è©³ç´°ãªã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæƒ…å ±ã®åé›†
            echo "ğŸ“‹ è©³ç´°ãªã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæƒ…å ±:"
            for file in $(git diff --name-only --diff-filter=U); do
              echo "ãƒ•ã‚¡ã‚¤ãƒ«: $file"
              echo "--- ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆå†…å®¹ ---"
              git show ":1:$file" > /tmp/base_file 2>/dev/null || echo "ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ãªã—"
              git show ":2:$file" > /tmp/target_file 2>/dev/null || echo "ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãªã—"
              git show ":3:$file" > /tmp/pr_file 2>/dev/null || echo "PRãƒ•ã‚¡ã‚¤ãƒ«ãªã—"

              # ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒãƒ¼ã‚«ãƒ¼ã®è¡Œæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
              CONFLICT_MARKERS=$(grep -c "^<<<<<<<\|^=======\|^>>>>>>>" "$file" 2>/dev/null || echo "0")
              echo "ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒãƒ¼ã‚«ãƒ¼æ•°: $CONFLICT_MARKERS"
            done

            # ãƒãƒ¼ã‚¸ã‚’ä¸­æ­¢
            git merge --abort
          else
            echo "âœ… ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãªã— - è‡ªå‹•ãƒãƒ¼ã‚¸å¯èƒ½"
            # ãƒ†ã‚¹ãƒˆãƒãƒ¼ã‚¸ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            git reset --hard HEAD
          fi

          # çµæœã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
          echo "merge_success=$MERGE_SUCCESS" >> $GITHUB_OUTPUT
          echo "conflict_files=$CONFLICT_FILES" >> $GITHUB_OUTPUT
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT

          # ãƒãƒ¼ã‚¸å‡ºåŠ›ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆå¾Œã§ã‚³ãƒ¡ãƒ³ãƒˆã«ä½¿ç”¨ï¼‰
          echo "$MERGE_OUTPUT" > merge_output.txt

          # å…ƒã®ãƒ–ãƒ©ãƒ³ãƒã«æˆ»ã‚‹
          git checkout $CURRENT_BRANCH

      - name: Generate conflict analysis report
        if: steps.conflict-check.outputs.merge_success == 'false'
        id: analysis
        run: |
          echo "ğŸ“‹ ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆåˆ†æãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ..."

          CONFLICT_FILES="${{ steps.conflict-check.outputs.conflict_files }}"

          # ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã®ç¨®é¡åˆ†æ
          CONFLICT_TYPES=""

          for file in $CONFLICT_FILES; do
            if [[ "$file" == *.py ]]; then
              CONFLICT_TYPES="$CONFLICT_TYPES Python,"
            elif [[ "$file" == *.yaml ]] || [[ "$file" == *.yml ]]; then
              CONFLICT_TYPES="$CONFLICT_TYPES YAMLè¨­å®š,"
            elif [[ "$file" == *.md ]]; then
              CONFLICT_TYPES="$CONFLICT_TYPES ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ,"
            elif [[ "$file" == *.json ]]; then
              CONFLICT_TYPES="$CONFLICT_TYPES JSONè¨­å®š,"
            else
              CONFLICT_TYPES="$CONFLICT_TYPES ãã®ä»–,"
            fi
          done

          # é‡è¤‡ã‚’å‰Šé™¤
          CONFLICT_TYPES=$(echo "$CONFLICT_TYPES" | tr ',' '\n' | sort -u | tr '\n' ',' | sed 's/,$//')

          echo "conflict_types=$CONFLICT_TYPES" >> $GITHUB_OUTPUT

          # è§£æ±ºæ¨å¥¨æ‰‹é †ã®ç”Ÿæˆ
          RESOLUTION_STEPS=""

          if echo "$CONFLICT_FILES" | grep -q "\.py$"; then
            RESOLUTION_STEPS="$RESOLUTION_STEPS
          - **Pythonãƒ•ã‚¡ã‚¤ãƒ«**: ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–‡ã‚„é–¢æ•°å®šç¾©ã®é‡è¤‡ç¢ºèª"
          fi

          if echo "$CONFLICT_FILES" | grep -q "\.ya?ml$"; then
            RESOLUTION_STEPS="$RESOLUTION_STEPS
          - **YAMLè¨­å®š**: è¨­å®šã‚­ãƒ¼ã®é‡è¤‡ã‚„æ§‹é€ å¤‰æ›´ã®ç¢ºèª"
          fi

          if echo "$CONFLICT_FILES" | grep -q "requirements\.txt\|pyproject\.toml"; then
            RESOLUTION_STEPS="$RESOLUTION_STEPS
          - **ä¾å­˜é–¢ä¿‚**: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ•´åˆæ€§ç¢ºèª"
          fi

          echo "resolution_steps<<EOF" >> $GITHUB_OUTPUT
          echo "$RESOLUTION_STEPS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create check run for conflict detection
        uses: actions/github-script@v7
        with:
          script: |
            const mergeSuccess = '${{ steps.conflict-check.outputs.merge_success }}' === 'true';
            const conflictFiles = '${{ steps.conflict-check.outputs.conflict_files }}';
            const changedFiles = '${{ steps.conflict-check.outputs.changed_files }}';

            const conclusion = mergeSuccess ? 'success' : 'failure';
            const title = mergeSuccess ?
              'âœ… ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãªã—' :
              'âŒ ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’æ¤œå‡º';

            const summary = mergeSuccess ?
              `ã“ã®PRã¯ **${{ github.event.pull_request.base.ref }}** ãƒ–ãƒ©ãƒ³ãƒã¨è‡ªå‹•ãƒãƒ¼ã‚¸å¯èƒ½ã§ã™ã€‚\n\nå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${changedFiles}` :
              `ã“ã®PRã¯ **${{ github.event.pull_request.base.ref }}** ãƒ–ãƒ©ãƒ³ãƒã¨ãƒãƒ¼ã‚¸æ™‚ã«ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒç™ºç”Ÿã—ã¾ã™ã€‚\n\nã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: ${conflictFiles}\nå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${changedFiles}`;

            // Check runã‚’ä½œæˆ
            const checkRun = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Merge Conflict Detection',
              head_sha: '${{ github.event.pull_request.head.sha }}',
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: title,
                summary: summary
              }
            });

            console.log(`Check run created: ${checkRun.data.html_url}`);

      - name: Comment on PR with conflict details
        if: steps.conflict-check.outputs.merge_success == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const conflictFiles = '${{ steps.conflict-check.outputs.conflict_files }}';
            const conflictTypes = '${{ steps.analysis.outputs.conflict_types }}';
            const resolutionSteps = `${{ steps.analysis.outputs.resolution_steps }}`;

            const body = `## âš ï¸ ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ

            ã“ã®PRã¯ \`${{ github.event.pull_request.base.ref }}\` ãƒ–ãƒ©ãƒ³ãƒã¨ãƒãƒ¼ã‚¸æ™‚ã«ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒç™ºç”Ÿã—ã¾ã™ã€‚

            ### ğŸ“ ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
            \`\`\`
            ${conflictFiles.split(' ').join('\n')}
            \`\`\`

            ### ğŸ·ï¸ ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã®ç¨®é¡
            ${conflictTypes}

            ### ğŸ”§ è§£æ±ºæ‰‹é †

            **1. ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’è§£æ±º:**
            \`\`\`bash
            # æœ€æ–°ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
            git fetch origin ${{ github.event.pull_request.base.ref }}

            # PRãƒ–ãƒ©ãƒ³ãƒã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
            git checkout ${{ github.event.pull_request.head.ref }}

            # ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’ãƒãƒ¼ã‚¸
            git merge origin/${{ github.event.pull_request.base.ref }}

            # ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’æ‰‹å‹•è§£æ±ºï¼ˆã‚¨ãƒ‡ã‚£ã‚¿ã§<<<<<<< =======  >>>>>>>ã‚’ä¿®æ­£ï¼‰
            # ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚’è§£æ±º:
            ${conflictFiles.split(' ').map(f => `#   - ${f}`).join('\n')}

            # è§£æ±ºå¾Œã€å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
            git add .

            # ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆ
            git commit -m "Resolve merge conflicts with ${{ github.event.pull_request.base.ref }}"

            # ãƒ—ãƒƒã‚·ãƒ¥
            git push
            \`\`\`

            **2. æ¨å¥¨è§£æ±ºã‚¢ãƒ—ãƒ­ãƒ¼ãƒ:**${resolutionSteps}

            ### ğŸš€ ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆè§£æ±ºå¾Œ
            - ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒè‡ªå‹•çš„ã«å†å®Ÿè¡Œã•ã‚Œã¾ã™
            - ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒè§£æ±ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™
            - ãã®ä»–ã®CIãƒã‚§ãƒƒã‚¯ã‚‚é€šéã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„

            ### ğŸ’¡ ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆäºˆé˜²ã®ãƒ’ãƒ³ãƒˆ
            - å®šæœŸçš„ã« \`${{ github.event.pull_request.base.ref }}\` ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰æœ€æ–°å¤‰æ›´ã‚’å–ã‚Šè¾¼ã‚€
            - æ©Ÿèƒ½ãƒ–ãƒ©ãƒ³ãƒã§ã®ä½œæ¥­æœŸé–“ã‚’çŸ­ãã™ã‚‹
            - å¤§è¦æ¨¡ãªå¤‰æ›´ã¯è¤‡æ•°ã®å°ã•ãªPRã«åˆ†å‰²ã™ã‚‹

            ---
            ğŸ¤– *ã“ã®åˆ†æã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ - [Merge Conflict Detection Workflow]*
            `;

            // æ—¢å­˜ã®ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.data.find(comment =>
              comment.user.login === 'github-actions[bot]' &&
              comment.body.includes('ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ')
            );

            if (existingComment) {
              // æ—¢å­˜ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              // æ–°ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Success notification
        if: steps.conflict-check.outputs.merge_success == 'true'
        run: |
          echo "âœ… ãƒãƒ¼ã‚¸ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆæ¤œçŸ¥ãƒã‚§ãƒƒã‚¯å®Œäº† - ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãªã—"
          echo "ã“ã®PRã¯è‡ªå‹•ãƒãƒ¼ã‚¸å¯èƒ½ã§ã™"

      - name: Upload conflict analysis artifacts
        if: steps.conflict-check.outputs.merge_success == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: conflict-analysis-${{ github.run_number }}
          path: |
            merge_output.txt
          retention-days: 7