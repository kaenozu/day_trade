#==============================================================================
# OpenTelemetry Collector è¨­å®š - Issue #442
# åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ»ãƒ­ã‚°ã®çµ±åˆåé›†
#==============================================================================

# å—ä¿¡å™¨ (Receivers)
receivers:
  # OTLPå—ä¿¡å™¨ (ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ã®ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªãƒ‡ãƒ¼ã‚¿)
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
        max_recv_msg_size: 8388608  # 8MB
      http:
        endpoint: 0.0.0.0:4318
        cors:
          allowed_origins:
            - "http://localhost:3000"
            - "http://localhost:8080"

  # Prometheus ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°
  prometheus:
    config:
      global:
        scrape_interval: 15s
        evaluation_interval: 15s
      scrape_configs:
        # Day Trade ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
        - job_name: 'day-trade-app'
          static_configs:
            - targets: ['app:8000', 'app:8080']
          metrics_path: /metrics
          scrape_interval: 5s
          scrape_timeout: 3s

        # ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹
        - job_name: 'node-exporter'
          static_configs:
            - targets: ['node-exporter:9100']

        # ã‚³ãƒ³ãƒ†ãƒŠãƒ¡ãƒˆãƒªã‚¯ã‚¹
        - job_name: 'cadvisor'
          static_configs:
            - targets: ['cadvisor:8080']

        # OpenTelemetry Collectorè‡ªä½“
        - job_name: 'otel-collector'
          static_configs:
            - targets: ['localhost:8888']

  # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ­ã‚°å—ä¿¡å™¨
  filelog:
    include:
      - /var/log/day-trade/*.log
      - /var/log/containers/*.log
    include_file_name: false
    include_file_path: true
    operators:
      - type: json_parser
        id: parser-json
        parse_from: attributes.log
        parse_to: body
      - type: time_parser
        parse_from: attributes.timestamp
        layout_type: strptime
        layout: '%Y-%m-%dT%H:%M:%S.%fZ'

  # Jaegerå—ä¿¡å™¨ï¼ˆä»–ã®Jaegerã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã®äº’æ›æ€§ï¼‰
  jaeger:
    protocols:
      grpc:
        endpoint: 0.0.0.0:14250
      thrift_http:
        endpoint: 0.0.0.0:14268
      thrift_compact:
        endpoint: 0.0.0.0:6831
      thrift_binary:
        endpoint: 0.0.0.0:6832

  # Zipkinå—ä¿¡å™¨ï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
  zipkin:
    endpoint: 0.0.0.0:9411

# ãƒ—ãƒ­ã‚»ãƒƒã‚µ (Processors)
processors:
  # ãƒãƒƒãƒãƒ—ãƒ­ã‚»ãƒƒã‚µ
  batch:
    timeout: 1s
    send_batch_size: 1024
    send_batch_max_size: 2048

  # ãƒ¡ãƒ¢ãƒªåˆ¶é™ãƒ—ãƒ­ã‚»ãƒƒã‚µ
  memory_limiter:
    limit_mib: 512
    spike_limit_mib: 128
    check_interval: 5s

  # ãƒªã‚½ãƒ¼ã‚¹å±æ€§ãƒ—ãƒ­ã‚»ãƒƒã‚µ
  resource:
    attributes:
      - key: environment
        value: "production"
        action: upsert
      - key: service.namespace
        value: "day-trade"
        action: upsert
      - key: deployment.environment
        value: "docker"
        action: upsert

  # å±æ€§ãƒ—ãƒ­ã‚»ãƒƒã‚µï¼ˆæ©Ÿå¯†æƒ…å ±ãƒã‚¹ã‚­ãƒ³ã‚°ï¼‰
  attributes:
    actions:
      # æ©Ÿå¯†æƒ…å ±ã‚’ãƒã‚¹ã‚¯
      - key: user.password
        action: delete
      - key: auth.token
        action: delete
      - key: credit_card
        action: delete
      # ä¾¿åˆ©ãªå±æ€§ã‚’è¿½åŠ 
      - key: service.instance.id
        value: "${env:HOSTNAME}"
        action: upsert

  # ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ãƒ—ãƒ­ã‚»ãƒƒã‚µï¼ˆæœ¬ç•ªç’°å¢ƒã§ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹èª¿æ•´ï¼‰
  probabilistic_sampler:
    hash_seed: 22
    sampling_percentage: 10  # 10%ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼ˆæœ¬ç•ªç”¨ï¼‰

  # ã‚¹ãƒ‘ãƒ³ãƒ—ãƒ­ã‚»ãƒƒã‚µï¼ˆã‚¹ãƒ‘ãƒ³ã®å¼·åŒ–ï¼‰
  span:
    name:
      # é•·ã„ã‚¹ãƒ‘ãƒ³åã‚’çŸ­ç¸®
      to_attributes:
        rules:
          - "^(.{50}).*$"
      # HTTPãƒ¡ã‚½ãƒƒãƒ‰ã¨ãƒ‘ã‚¹ã‚’çµ„ã¿åˆã‚ã›
      from_attributes: ["http.method", "http.route"]
      separator: " "

# ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ãƒ¼ (Exporters)
exporters:
  # Jaegerã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ãƒ¼
  jaeger:
    endpoint: jaeger-all-in-one:14250
    tls:
      insecure: true

  # Prometheusã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ãƒ¼
  prometheus:
    endpoint: "0.0.0.0:8889"
    namespace: day_trade
    const_labels:
      environment: production
    enable_open_metrics: true
    resource_to_telemetry_conversion:
      enabled: true

  # Elasticsearchã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ãƒ¼ (ãƒ­ã‚°ç”¨)
  elasticsearch:
    endpoints: ["http://elasticsearch:9200"]
    index: "day-trade-logs-%Y.%m.%d"
    pipeline: "day-trade-pipeline"
    timeout: 30s
    retry:
      enabled: true
      max_requests: 3
      initial_interval: 100ms
      max_interval: 1s
    sending_queue:
      enabled: true
      num_consumers: 10
      queue_size: 5000

  # Lokiã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ãƒ¼ (ãƒ­ã‚°ç”¨)
  loki:
    endpoint: "http://loki:3100/loki/api/v1/push"
    tenant_id: "day-trade"
    labels:
      attributes:
        service.name: "service_name"
        service.instance.id: "service_instance_id"
      resource:
        container.name: "container_name"

  # ãƒ­ã‚°å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
  logging:
    loglevel: info
    sampling_initial: 5
    sampling_thereafter: 200

  # ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ã‚¿ãƒ¼ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ï¼‰
  file:
    path: /tmp/otel-collector-traces.json
    rotation:
      max_megabytes: 100
      max_days: 3
      max_backups: 3

# æ‹¡å¼µæ©Ÿèƒ½ (Extensions)
extensions:
  # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
  health_check:
    endpoint: 0.0.0.0:13133
    path: "/health"

  # ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆç›£è¦–ç”¨ï¼‰
  pprof:
    endpoint: 0.0.0.0:1888

  # zPagesï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
  zpages:
    endpoint: 0.0.0.0:55679

  # ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆç”¨ï¼‰
  file_storage:
    directory: /tmp/otel-collector-storage

# ã‚µãƒ¼ãƒ“ã‚¹è¨­å®š
service:
  # æ‹¡å¼µæ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–
  extensions: [health_check, pprof, zpages, file_storage]

  # ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­å®š
  pipelines:
    # ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
    traces:
      receivers: [otlp, jaeger, zipkin]
      processors: [memory_limiter, resource, attributes, probabilistic_sampler, batch]
      exporters: [jaeger, logging]

    # ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
    metrics:
      receivers: [otlp, prometheus]
      processors: [memory_limiter, resource, batch]
      exporters: [prometheus, logging]

    # ãƒ­ã‚°ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
    logs:
      receivers: [otlp, filelog]
      processors: [memory_limiter, resource, attributes, batch]
      exporters: [elasticsearch, loki, logging]

  # ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªè¨­å®š
  telemetry:
    logs:
      level: "info"
      development: false
      sampling:
        initial: 5
        thereafter: 200
    metrics:
      level: detailed
      address: 0.0.0.0:8888
    traces:
      processors: [batch]

#==============================================================================
# OpenTelemetry Collector ã®ç‰¹å¾´:
#
# ğŸ“¡ ãƒãƒ«ãƒãƒ—ãƒ­ãƒˆã‚³ãƒ«å—ä¿¡:
#   - OTLP (gRPC/HTTP)
#   - Jaeger (è¤‡æ•°ãƒ—ãƒ­ãƒˆã‚³ãƒ«)
#   - Zipkinäº’æ›
#   - Prometheus ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°
#
# ğŸ”„ é«˜æ€§èƒ½ãƒ‡ãƒ¼ã‚¿å‡¦ç†:
#   - ãƒãƒƒãƒå‡¦ç†ã«ã‚ˆã‚‹åŠ¹ç‡åŒ–
#   - ãƒ¡ãƒ¢ãƒªåˆ¶é™ã«ã‚ˆã‚‹å®‰å®šæ€§
#   - ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã«ã‚ˆã‚‹è² è·è»½æ¸›
#
# ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾å¿œ:
#   - æ©Ÿå¯†æƒ…å ±ã®è‡ªå‹•ãƒã‚¹ã‚­ãƒ³ã‚°
#   - å±æ€§ãƒ™ãƒ¼ã‚¹ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
#   - TLSè¨­å®šå¯¾å¿œ
#
# ğŸ“Š å¤šæ§˜ãªã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ:
#   - Jaeger (åˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°)
#   - Prometheus (ãƒ¡ãƒˆãƒªã‚¯ã‚¹)
#   - Elasticsearch/Loki (ãƒ­ã‚°)
#   - File (ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—)
#
# âš¡ HFTå¯¾å¿œ:
#   - ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·è¨­è¨ˆ
#   - åŠ¹ç‡çš„ãªãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°
#   - éåŒæœŸå‡¦ç†
#==============================================================================