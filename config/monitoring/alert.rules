#==============================================================================
# Prometheus Alert Rules - Issue #442 Phase 3
# ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆã‚¢ãƒ©ãƒ¼ãƒˆãƒ»SLOç›£è¦–ãƒ»ç•°å¸¸æ¤œçŸ¥
#==============================================================================

groups:
  # === HFT ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¢ãƒ©ãƒ¼ãƒˆ ===
  - name: hft-critical
    interval: 5s  # é«˜é »åº¦è©•ä¾¡
    rules:
      # å–å¼•ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· SLOé•å
      - alert: TradeLatencySLOViolation
        expr: |
          (
            histogram_quantile(0.999,
              rate(day_trade_trade_latency_microseconds_bucket[30s])
            ) > 50
          )
        for: 10s
        labels:
          severity: critical
          service: trading
          slo: trade_latency
        annotations:
          summary: "Trade latency SLO violation detected"
          description: "99.9th percentile trade latency ({{ $value }}Î¼s) exceeds 50Î¼s threshold for {{ $labels.symbol }}"
          runbook_url: "https://docs.daytrade.local/runbooks/trade-latency"

      # å–å¼•æˆåŠŸç‡ SLOé•å
      - alert: TradeSuccessRateSLOViolation
        expr: |
          (
            rate(day_trade_trades_total{status="success"}[5m]) /
            rate(day_trade_trades_total[5m])
          ) * 100 < 99.95
        for: 30s
        labels:
          severity: critical
          service: trading
          slo: trade_success
        annotations:
          summary: "Trade success rate SLO violation"
          description: "Trade success rate ({{ $value }}%) below 99.95% threshold"

      # ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«
      - alert: MemoryUsageCritical
        expr: |
          (
            (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) /
            node_memory_MemTotal_bytes
          ) * 100 > 90
        for: 30s
        labels:
          severity: critical
          service: system
        annotations:
          summary: "Critical memory usage detected"
          description: "Memory usage ({{ $value }}%) exceeds 90% on {{ $labels.instance }}"

      # API ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ SLOé•å
      - alert: APILatencySLOViolation
        expr: |
          histogram_quantile(0.999,
            rate(day_trade_request_duration_seconds_bucket[30s])
          ) * 1000 > 50
        for: 15s
        labels:
          severity: high
          service: api
          slo: api_latency
        annotations:
          summary: "API latency SLO violation"
          description: "99.9th percentile API response time ({{ $value }}ms) exceeds 50ms"

  # === ã‚·ã‚¹ãƒ†ãƒ å¯ç”¨æ€§ç›£è¦– ===
  - name: availability
    interval: 30s
    rules:
      # ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢æ¤œå‡º
      - alert: ServiceDown
        expr: up{job!="prometheus"} == 0
        for: 1m
        labels:
          severity: critical
          service: "{{ $labels.job }}"
        annotations:
          summary: "Service {{ $labels.job }} is down"
          description: "Service {{ $labels.job }} on {{ $labels.instance }} has been down for more than 1 minute"

      # ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒç‡ SLOç›£è¦–
      - alert: SystemAvailabilitySLOViolation
        expr: |
          (
            avg_over_time(up{job="day-trade-app"}[1h]) * 100
          ) < 99.99
        for: 5m
        labels:
          severity: high
          service: system
          slo: availability
        annotations:
          summary: "System availability SLO violation"
          description: "System availability ({{ $value }}%) below 99.99% over the last hour"

      # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼
      - alert: DatabaseConnectionError
        expr: |
          rate(day_trade_errors_total{error_type="DatabaseError"}[5m]) > 0.1
        for: 2m
        labels:
          severity: high
          service: database
        annotations:
          summary: "Database connection errors detected"
          description: "Database connection error rate ({{ $value }}/sec) exceeds threshold"

  # === ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦– ===
  - name: performance
    interval: 15s
    rules:
      # CPUä½¿ç”¨ç‡é«˜
      - alert: HighCPUUsage
        expr: |
          (
            100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
          ) > 80
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage ({{ $value }}%) exceeds 80% on {{ $labels.instance }}"

      # ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡é«˜
      - alert: HighDiskUsage
        expr: |
          (
            (node_filesystem_size_bytes{fstype!="tmpfs"} - node_filesystem_free_bytes{fstype!="tmpfs"}) /
            node_filesystem_size_bytes{fstype!="tmpfs"}
          ) * 100 > 85
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "High disk usage detected"
          description: "Disk usage ({{ $value }}%) exceeds 85% on {{ $labels.instance }}:{{ $labels.mountpoint }}"

      # ã‚¨ãƒ©ãƒ¼ç‡ä¸Šæ˜‡
      - alert: HighErrorRate
        expr: |
          (
            rate(day_trade_errors_total[5m]) /
            rate(day_trade_requests_total[5m])
          ) * 100 > 5
        for: 2m
        labels:
          severity: warning
          service: application
        annotations:
          summary: "High error rate detected"
          description: "Error rate ({{ $value }}%) exceeds 5% threshold"

      # ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆç•°å¸¸
      - alert: LowThroughput
        expr: |
          rate(day_trade_trades_total[5m]) < 10
        for: 5m
        labels:
          severity: warning
          service: trading
        annotations:
          summary: "Low trading throughput"
          description: "Trading throughput ({{ $value }} trades/sec) below expected threshold"

  # === ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç›£è¦– ===
  - name: business-metrics
    interval: 60s
    rules:
      # å¤§ããªæå¤±æ¤œå‡º
      - alert: LargeLoss
        expr: |
          increase(day_trade_pnl_dollars_sum[15m]) < -5000
        for: 1m
        labels:
          severity: critical
          service: risk
        annotations:
          summary: "Large loss detected"
          description: "Cumulative P&L loss (${{ $value }}) exceeds $5000 in 15 minutes"

      # ç•°å¸¸ãªãƒã‚¸ã‚·ãƒ§ãƒ³æ•°
      - alert: AbnormalPositionCount
        expr: |
          day_trade_positions_count > 1000 or day_trade_positions_count < 0
        for: 2m
        labels:
          severity: high
          service: risk
        annotations:
          summary: "Abnormal position count"
          description: "Position count ({{ $value }}) outside normal range"

      # å¸‚å ´ãƒ‡ãƒ¼ã‚¿é…å»¶
      - alert: MarketDataDelay
        expr: |
          time() - day_trade_market_data_timestamp > 5
        for: 30s
        labels:
          severity: high
          service: market-data
        annotations:
          summary: "Market data delay detected"
          description: "Market data is delayed by {{ $value }} seconds"

  # === ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦– ===
  - name: security
    interval: 30s
    rules:
      # èªè¨¼å¤±æ•—ç‡ä¸Šæ˜‡
      - alert: HighAuthFailureRate
        expr: |
          rate(day_trade_auth_failures_total[5m]) > 10
        for: 1m
        labels:
          severity: high
          service: security
        annotations:
          summary: "High authentication failure rate"
          description: "Authentication failure rate ({{ $value }}/min) exceeds threshold"

      # ç•°å¸¸ãªAPIã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³
      - alert: AbnormalAPIAccess
        expr: |
          rate(day_trade_requests_total[1m]) > 1000
        for: 2m
        labels:
          severity: warning
          service: security
        annotations:
          summary: "Abnormal API access pattern"
          description: "API request rate ({{ $value }}/min) unusually high from {{ $labels.client_ip }}"

  # === ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ç›£è¦– ===
  - name: infrastructure
    interval: 60s
    rules:
      # Container ì¬ì‹œì‘
      - alert: ContainerRestarting
        expr: |
          rate(container_start_time_seconds[10m]) > 0
        for: 5m
        labels:
          severity: warning
          service: infrastructure
        annotations:
          summary: "Container {{ $labels.name }} restarting"
          description: "Container {{ $labels.name }} has restarted {{ $value }} times in 10 minutes"

      # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ä¸Šæ˜‡
      - alert: HighNetworkLatency
        expr: |
          histogram_quantile(0.95,
            rate(node_network_receive_bytes_total[5m])
          ) > 100000000  # 100MB/s
        for: 5m
        labels:
          severity: warning
          service: network
        annotations:
          summary: "High network latency detected"
          description: "Network latency on {{ $labels.instance }} exceeds threshold"

  # === Elasticsearch ç›£è¦– ===
  - name: elasticsearch
    interval: 30s
    rules:
      # ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼çŠ¶æ…‹
      - alert: ElasticsearchClusterRed
        expr: |
          elasticsearch_cluster_health_status{color="red"} == 1
        for: 2m
        labels:
          severity: critical
          service: elasticsearch
        annotations:
          summary: "Elasticsearch cluster status is RED"
          description: "Elasticsearch cluster health is RED. Immediate attention required."

      # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆé…å»¶
      - alert: ElasticsearchSlowIndexing
        expr: |
          rate(elasticsearch_index_indexing_index_time_seconds[5m]) > 10
        for: 5m
        labels:
          severity: warning
          service: elasticsearch
        annotations:
          summary: "Elasticsearch slow indexing detected"
          description: "Elasticsearch indexing time ({{ $value }}s) exceeds threshold"

  # === Machine Learning ç•°å¸¸æ¤œçŸ¥ ===
  - name: anomaly-detection
    interval: 60s
    rules:
      # å–å¼•é‡ç•°å¸¸
      - alert: TradingVolumeAnomaly
        expr: |
          abs(
            rate(day_trade_trades_total[5m]) -
            avg_over_time(rate(day_trade_trades_total[5m])[4h:5m])
          ) / avg_over_time(rate(day_trade_trades_total[5m])[4h:5m]) > 0.5
        for: 10m
        labels:
          severity: warning
          service: anomaly-detection
        annotations:
          summary: "Trading volume anomaly detected"
          description: "Current trading volume deviates by {{ $value }}% from 4-hour average"

      # ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ç•°å¸¸
      - alert: LatencyAnomaly
        expr: |
          abs(
            histogram_quantile(0.95, rate(day_trade_trade_latency_microseconds_bucket[5m])) -
            avg_over_time(histogram_quantile(0.95, rate(day_trade_trade_latency_microseconds_bucket[5m]))[2h:5m])
          ) / avg_over_time(histogram_quantile(0.95, rate(day_trade_trade_latency_microseconds_bucket[5m]))[2h:5m]) > 0.3
        for: 5m
        labels:
          severity: warning
          service: anomaly-detection
        annotations:
          summary: "Latency anomaly detected"
          description: "Current 95th percentile latency deviates by {{ $value }}% from 2-hour average"

#==============================================================================
# Alert Rules ç‰¹åŒ–æ©Ÿèƒ½:
#
# ğŸš¨ SLO/SLIç›£è¦–:
#   - å–å¼•ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· SLO (<50Î¼s)
#   - APIå¿œç­”æ™‚é–“ SLO (<50ms)
#   - ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒç‡ SLO (99.99%)
#   - å–å¼•æˆåŠŸç‡ SLO (99.95%)
#
# âš¡ HFTå¯¾å¿œ:
#   - é«˜é »åº¦è©•ä¾¡ (5ç§’é–“éš”)
#   - ä½ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·æ¤œå‡º
#   - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç•°å¸¸æ¤œçŸ¥
#
# ğŸ¤– æ©Ÿæ¢°å­¦ç¿’çµ±åˆ:
#   - çµ±è¨ˆçš„ç•°å¸¸æ¤œçŸ¥
#   - å‹•çš„é–¾å€¤èª¿æ•´
#   - ãƒ‘ã‚¿ãƒ¼ãƒ³èªè­˜
#
# ğŸ“Š å¤šå±¤ç›£è¦–:
#   - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤
#   - ã‚·ã‚¹ãƒ†ãƒ å±¤
#   - ã‚¤ãƒ³ãƒ•ãƒ©å±¤
#   - ãƒ“ã‚¸ãƒã‚¹å±¤
#
# ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–:
#   - èªè¨¼å¤±æ•—ç›£è¦–
#   - ç•°å¸¸ã‚¢ã‚¯ã‚»ã‚¹æ¤œå‡º
#   - è„…å¨ãƒ‘ã‚¿ãƒ¼ãƒ³èªè­˜
#==============================================================================