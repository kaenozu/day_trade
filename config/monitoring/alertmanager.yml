#==============================================================================
# AlertManager è¨­å®š - Issue #442 Phase 4
# æ™ºçš„ã‚¢ãƒ©ãƒ¼ãƒˆç®¡ç†ãƒ»é€šçŸ¥ãƒ»ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
#==============================================================================

# ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š
global:
  # SMTPè¨­å®š
  smtp_smarthost: 'mail.daytrade.local:587'
  smtp_from: 'alerts@daytrade.local'
  smtp_auth_username: 'alerts@daytrade.local'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true

  # å¤–éƒ¨ãƒªãƒ³ã‚¯
  resolve_timeout: 5m
  http_config:
    follow_redirects: true

# ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨­å®š
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# === ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®š ===
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'default-team'

  # ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ«ãƒ¼ãƒ«
  routes:
    # === HFT ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¢ãƒ©ãƒ¼ãƒˆ ===
    - match:
        severity: critical
        service: trading
      group_by: ['alertname']
      group_wait: 0s
      group_interval: 30s
      repeat_interval: 5m
      receiver: 'hft-critical-team'
      continue: false

    # === ã‚·ã‚¹ãƒ†ãƒ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ« ===
    - match:
        severity: critical
      group_by: ['alertname', 'instance']
      group_wait: 30s
      group_interval: 1m
      repeat_interval: 10m
      receiver: 'sre-team'
      routes:
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢é€£
        - match:
            service: database
          receiver: 'database-team'
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£
        - match:
            service: security
          receiver: 'security-team'

    # === ãƒ“ã‚¸ãƒã‚¹ã‚¢ãƒ©ãƒ¼ãƒˆ ===
    - match:
        alert_type: large_loss
      group_by: ['alertname']
      group_wait: 0s
      group_interval: 30s
      repeat_interval: 15m
      receiver: 'risk-management-team'

    # === ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¢ãƒ©ãƒ¼ãƒˆ ===
    - match_re:
        alertname: '.*(Latency|Performance).*'
      group_by: ['alertname', 'service']
      group_wait: 1m
      group_interval: 5m
      repeat_interval: 30m
      receiver: 'performance-team'

    # === ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆ ===
    - match:
        service: security
      group_by: ['alertname', 'source_ip']
      group_wait: 30s
      group_interval: 2m
      repeat_interval: 1h
      receiver: 'security-team'

    # === å¯ç”¨æ€§ã‚¢ãƒ©ãƒ¼ãƒˆ ===
    - match_re:
        alertname: '.*(Down|Unavailable).*'
      group_by: ['alertname', 'instance']
      group_wait: 30s
      group_interval: 1m
      repeat_interval: 15m
      receiver: 'sre-team'

    # === è­¦å‘Šãƒ¬ãƒ™ãƒ« ===
    - match:
        severity: warning
      group_by: ['alertname', 'service']
      group_wait: 5m
      group_interval: 10m
      repeat_interval: 2h
      receiver: 'monitoring-team'

# === é€šçŸ¥æŠ‘åˆ¶è¨­å®š ===
inhibit_rules:
  # ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢æ™‚ã¯ä»–ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶
  - source_match:
      severity: 'critical'
      alertname: 'ServiceDown'
    target_match:
      service: '{{ $sourceLabels.service }}'
    equal: ['service', 'instance']

  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åœæ­¢æ™‚ã¯é–¢é€£ã‚¢ãƒ©ãƒ¼ãƒˆæŠ‘åˆ¶
  - source_match:
      severity: 'critical'
      service: 'database'
    target_match_re:
      alertname: '.*(Connection|Query|Database).*'
    equal: ['instance']

  # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³æ™‚ã¯é–¢é€£ã‚¢ãƒ©ãƒ¼ãƒˆæŠ‘åˆ¶
  - source_match:
      alertname: 'NetworkDown'
    target_match_re:
      alertname: '.*(Latency|Timeout|Connection).*'
    equal: ['instance']

# === å—ä¿¡è€…è¨­å®š ===
receivers:
  # === ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ ===
  - name: 'default-team'
    email_configs:
      - to: 'ops@daytrade.local'
        subject: 'ğŸ”” Day Trade Alert: {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          **Alert:** {{ .Annotations.summary }}
          **Description:** {{ .Annotations.description }}
          **Severity:** {{ .Labels.severity }}
          **Service:** {{ .Labels.service }}
          **Time:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # === HFT ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒãƒ¼ãƒ  ===
  - name: 'hft-critical-team'
    # Slacké€šçŸ¥
    slack_configs:
      - api_url: '${SLACK_HFT_WEBHOOK}'
        channel: '#hft-alerts'
        username: 'AlertManager'
        icon_emoji: ':rotating_light:'
        title: 'ğŸš¨ HFT CRITICAL ALERT'
        text: |
          {{ range .Alerts }}
          **{{ .Annotations.summary }}**
          â€¢ Service: {{ .Labels.service }}
          â€¢ Instance: {{ .Labels.instance }}
          â€¢ Symbol: {{ .Labels.symbol | default "N/A" }}
          â€¢ Severity: {{ .Labels.severity }}
          â€¢ Runbook: {{ .Annotations.runbook_url }}
          {{ end }}
        send_resolved: true

    # PagerDutyé€šçŸ¥
    pagerduty_configs:
      - service_key: '${PAGERDUTY_HFT_KEY}'
        severity: 'critical'
        description: |
          {{ .GroupLabels.alertname }}: {{ .GroupLabels.service }}
        details:
          alert_count: '{{ len .Alerts }}'
          cluster: '{{ .GroupLabels.cluster }}'

    # SMSé€šçŸ¥ï¼ˆç·Šæ€¥æ™‚ï¼‰
    webhook_configs:
      - url: 'https://sms-gateway.daytrade.local/api/alert'
        http_config:
          bearer_token: '${SMS_API_TOKEN}'
        send_resolved: true

    # ãƒ¡ãƒ¼ãƒ«é€šçŸ¥
    email_configs:
      - to: 'hft-team@daytrade.local'
        subject: 'ğŸš¨ HFT CRITICAL: {{ .GroupLabels.alertname }}'
        headers:
          Priority: 'high'
          X-Priority: '1'
        body: |
          <!DOCTYPE html>
          <html>
          <head><title>HFT Critical Alert</title></head>
          <body style="font-family: Arial, sans-serif;">
          <h2 style="color: red;">ğŸš¨ HFT CRITICAL ALERT</h2>
          {{ range .Alerts }}
          <div style="border: 1px solid red; padding: 10px; margin: 10px;">
          <h3>{{ .Annotations.summary }}</h3>
          <p><strong>Description:</strong> {{ .Annotations.description }}</p>
          <p><strong>Service:</strong> {{ .Labels.service }}</p>
          <p><strong>Instance:</strong> {{ .Labels.instance }}</p>
          <p><strong>Time:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05 UTC" }}</p>
          <p><strong>Runbook:</strong> <a href="{{ .Annotations.runbook_url }}">{{ .Annotations.runbook_url }}</a></p>
          </div>
          {{ end }}
          </body>
          </html>

  # === SREãƒãƒ¼ãƒ  ===
  - name: 'sre-team'
    slack_configs:
      - api_url: '${SLACK_SRE_WEBHOOK}'
        channel: '#sre-alerts'
        username: 'AlertManager'
        icon_emoji: ':warning:'
        title: 'âš ï¸ System Alert'
        text: |
          {{ range .Alerts }}
          **{{ .Annotations.summary }}**
          Service: {{ .Labels.service }}
          Instance: {{ .Labels.instance }}
          Severity: {{ .Labels.severity }}
          {{ end }}
        send_resolved: true

    email_configs:
      - to: 'sre@daytrade.local'
        subject: 'âš ï¸ System Alert: {{ .GroupLabels.alertname }}'

  # === ãƒªã‚¹ã‚¯ç®¡ç†ãƒãƒ¼ãƒ  ===
  - name: 'risk-management-team'
    slack_configs:
      - api_url: '${SLACK_RISK_WEBHOOK}'
        channel: '#risk-alerts'
        username: 'AlertManager'
        icon_emoji: ':chart_with_downwards_trend:'
        title: 'ğŸ“‰ Risk Alert'
        text: |
          {{ range .Alerts }}
          **Large Loss Detected**
          {{ .Annotations.description }}
          Time: {{ .StartsAt.Format "15:04:05" }}
          {{ end }}
        send_resolved: true

    # é‡è¦ãƒªã‚¹ã‚¯ã‚¢ãƒ©ãƒ¼ãƒˆã¯å³åº§ã«é›»è©±é€šçŸ¥
    webhook_configs:
      - url: 'https://voice-alert.daytrade.local/api/call'
        http_config:
          bearer_token: '${VOICE_API_TOKEN}'
        send_resolved: false

  # === ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒ¼ãƒ  ===
  - name: 'security-team'
    slack_configs:
      - api_url: '${SLACK_SECURITY_WEBHOOK}'
        channel: '#security-alerts'
        username: 'AlertManager'
        icon_emoji: ':shield:'
        title: 'ğŸ›¡ï¸ Security Alert'
        text: |
          {{ range .Alerts }}
          **{{ .Annotations.summary }}**
          Type: {{ .Labels.alert_type }}
          Source IP: {{ .Labels.source_ip | default "Unknown" }}
          User: {{ .Labels.user_id | default "Anonymous" }}
          {{ end }}
        send_resolved: true

    email_configs:
      - to: 'security@daytrade.local'
        subject: 'ğŸ›¡ï¸ Security Alert: {{ .GroupLabels.alertname }}'

  # === ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒ¼ãƒ  ===
  - name: 'database-team'
    slack_configs:
      - api_url: '${SLACK_DB_WEBHOOK}'
        channel: '#database-alerts'
        username: 'AlertManager'
        icon_emoji: ':database:'
        title: 'ğŸ—„ï¸ Database Alert'
        send_resolved: true

    email_configs:
      - to: 'dba@daytrade.local'
        subject: 'ğŸ—„ï¸ Database Alert: {{ .GroupLabels.alertname }}'

  # === ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¼ãƒ  ===
  - name: 'performance-team'
    slack_configs:
      - api_url: '${SLACK_PERF_WEBHOOK}'
        channel: '#performance-alerts'
        username: 'AlertManager'
        icon_emoji: ':chart_with_upwards_trend:'
        title: 'ğŸ“Š Performance Alert'
        send_resolved: true

  # === ç›£è¦–ãƒãƒ¼ãƒ  ===
  - name: 'monitoring-team'
    email_configs:
      - to: 'monitoring@daytrade.local'
        subject: 'ğŸ“Š Monitoring Alert: {{ .GroupLabels.alertname }}'

  # === Webhookçµ±åˆ ===
  - name: 'webhook-integrations'
    webhook_configs:
      # ServiceNowçµ±åˆ
      - url: 'https://servicenow.daytrade.local/api/incident'
        http_config:
          basic_auth:
            username: 'alertmanager'
            password: '${SERVICENOW_PASSWORD}'
        send_resolved: true

      # JIRAçµ±åˆ
      - url: 'https://jira.daytrade.local/rest/api/2/issue'
        http_config:
          bearer_token: '${JIRA_API_TOKEN}'
        send_resolved: false

      # Grafana annotation
      - url: 'http://grafana-apm:3000/api/annotations'
        http_config:
          bearer_token: '${GRAFANA_API_TOKEN}'

# === æ™‚é–“ãƒ™ãƒ¼ã‚¹ã®æŠ‘åˆ¶è¨­å®š ===
time_intervals:
  - name: business_hours
    time_intervals:
      - times:
        - start_time: '09:00'
          end_time: '18:00'
        weekdays: ['monday:friday']

  - name: trading_hours
    time_intervals:
      - times:
        - start_time: '09:30'
          end_time: '16:00'
        weekdays: ['monday:friday']

# === ã‚¢ã‚¯ãƒ†ã‚£ãƒ–/éã‚¢ã‚¯ãƒ†ã‚£ãƒ–æœŸé–“ ===
mute_time_intervals:
  - name: maintenance_window
    time_intervals:
      - times:
        - start_time: '02:00'
          end_time: '04:00'
        weekdays: ['sunday']

#==============================================================================
# AlertManager ç‰¹åŒ–æ©Ÿèƒ½:
#
# ğŸš¨ éšå±¤åŒ–ã‚¢ãƒ©ãƒ¼ãƒˆç®¡ç†:
#   - HFT: å³åº§é€šçŸ¥ï¼ˆSlack + PagerDuty + SMSï¼‰
#   - Critical: 1åˆ†ä»¥å†…ï¼ˆSlack + Emailï¼‰
#   - Warning: 5åˆ†å¾Œï¼ˆEmailï¼‰
#
# ğŸ¯ æ™ºçš„ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:
#   - ã‚µãƒ¼ãƒ“ã‚¹åˆ¥ãƒãƒ¼ãƒ è‡ªå‹•æŒ¯ã‚Šåˆ†ã‘
#   - é‡è¦åº¦åˆ¥ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
#   - åœ°ç†çš„åˆ†æ•£å¯¾å¿œ
#
# ğŸ”‡ ã‚¢ãƒ©ãƒ¼ãƒˆæŠ‘åˆ¶:
#   - ä¸Šä½éšœå®³æ™‚ã®é–¢é€£ã‚¢ãƒ©ãƒ¼ãƒˆæŠ‘åˆ¶
#   - ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“ã®ãƒŸãƒ¥ãƒ¼ãƒˆ
#   - é‡è¤‡ã‚¢ãƒ©ãƒ¼ãƒˆã®çµ±åˆ
#
# ğŸ“± ãƒãƒ«ãƒãƒãƒ£ãƒãƒ«é€šçŸ¥:
#   - Slack, Email, SMS, é›»è©±
#   - PagerDutyçµ±åˆ
#   - ServiceNow/JIRAé€£æº
#
# â° æ™‚é–“ãƒ™ãƒ¼ã‚¹åˆ¶å¾¡:
#   - å–¶æ¥­æ™‚é–“åˆ¥é€šçŸ¥è¨­å®š
#   - ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹çª“ã®è‡ªå‹•æŠ‘åˆ¶
#   - ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è€ƒæ…®
#==============================================================================