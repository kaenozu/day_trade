# Issue #800 Phase 4: AlertManagerè¨­å®š
# Day Trade ML System ã‚¢ãƒ©ãƒ¼ãƒˆç®¡ç†ãƒ»é€šçŸ¥

global:
  # SMTPè¨­å®š
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'day-trade-alerts@company.com'
  smtp_auth_username: 'day-trade-alerts@company.com'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_auth_secret: '${SMTP_AUTH_SECRET}'

  # Slackè¨­å®š
  slack_api_url: '${SLACK_API_URL}'

  # è§£æ±ºã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
  resolve_timeout: 5m

# ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# ãƒ«ãƒ¼ãƒˆè¨­å®š
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'web.hook'

  routes:
    # Critical ã‚¢ãƒ©ãƒ¼ãƒˆ (å³åº§ã«é€šçŸ¥)
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m
      continue: true

    # 93%ç²¾åº¦ä½ä¸‹ (æœ€å„ªå…ˆ)
    - match:
        alertname: EnsembleAccuracyDegraded
      receiver: 'accuracy-alerts'
      group_wait: 0s
      repeat_interval: 2m
      continue: true

    # MLã‚µãƒ¼ãƒ“ã‚¹é–¢é€£
    - match:
        service: ml-service
      receiver: 'ml-service-alerts'
      group_interval: 5m
      repeat_interval: 15m
      continue: true

    # ãƒ‡ãƒ¼ã‚¿ã‚µãƒ¼ãƒ“ã‚¹é–¢é€£
    - match:
        service: data-service
      receiver: 'data-service-alerts'
      group_interval: 5m
      repeat_interval: 15m
      continue: true

    # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã‚µãƒ¼ãƒ“ã‚¹é–¢é€£
    - match:
        service: scheduler-service
      receiver: 'scheduler-alerts'
      group_interval: 5m
      repeat_interval: 15m
      continue: true

    # ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£é–¢é€£
    - match:
        service: infrastructure
      receiver: 'infrastructure-alerts'
      group_interval: 10m
      repeat_interval: 30m
      continue: true

    # ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹
    - match:
        service: business
      receiver: 'business-alerts'
      group_interval: 15m
      repeat_interval: 1h
      continue: true

    # å–¶æ¥­æ™‚é–“å¤–ã¯ä½é »åº¦é€šçŸ¥
    - match_re:
        severity: warning
      receiver: 'off-hours-alerts'
      active_time_intervals:
        - off-hours
      group_interval: 30m
      repeat_interval: 2h

# å—ä¿¡è€…è¨­å®š
receivers:
  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå—ä¿¡è€…
  - name: 'web.hook'
    webhook_configs:
      - url: 'http://webhook-logger:8080/alerts'
        send_resolved: true

  # Critical ã‚¢ãƒ©ãƒ¼ãƒˆ
  - name: 'critical-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#day-trade-critical'
        username: 'AlertManager'
        icon_emoji: ':fire:'
        title: 'ğŸš¨ CRITICAL: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Service:* {{ .Labels.service }}
          *Severity:* {{ .Labels.severity }}
          *Time:* {{ .StartsAt.Format "2006-01-02 15:04:05 JST" }}
          {{ if .GeneratorURL }}*Source:* <{{ .GeneratorURL }}|Prometheus>{{ end }}
          {{ if .Annotations.runbook_url }}*Runbook:* <{{ .Annotations.runbook_url }}|View>{{ end }}
          {{ end }}
        send_resolved: true

    email_configs:
      - to: 'dev-team@company.com,ops-team@company.com'
        subject: 'ğŸš¨ Day Trade Critical Alert: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        body: |
          Critical alert in Day Trade ML System:

          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Service: {{ .Labels.service }}
          Severity: {{ .Labels.severity }}
          Started: {{ .StartsAt.Format "2006-01-02 15:04:05 JST" }}
          {{ if .Annotations.runbook_url }}
          Runbook: {{ .Annotations.runbook_url }}
          {{ end }}
          {{ end }}
        send_resolved: true

  # 93%ç²¾åº¦ã‚¢ãƒ©ãƒ¼ãƒˆ (æœ€å„ªå…ˆ)
  - name: 'accuracy-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#day-trade-accuracy'
        username: 'AccuracyMonitor'
        icon_emoji: ':chart_with_downwards_trend:'
        title: 'ğŸ“‰ EnsembleSystemç²¾åº¦ä½ä¸‹è­¦å‘Š'
        text: |
          ğŸ¯ *93%ç²¾åº¦ç›®æ¨™æœªé”æˆ*

          {{ range .Alerts }}
          *ç¾åœ¨ç²¾åº¦:* {{ .Annotations.description }}
          *æ™‚åˆ»:* {{ .StartsAt.Format "2006-01-02 15:04:05 JST" }}
          *å¯¾å¿œå¿…è¦:* å³åº§ã«ãƒ¢ãƒ‡ãƒ«ç¢ºèªãƒ»å†è¨“ç·´æ¤œè¨
          {{ if .Annotations.runbook_url }}*å¯¾å¿œæ‰‹é †:* <{{ .Annotations.runbook_url }}|View>{{ end }}
          {{ end }}
        send_resolved: true

    email_configs:
      - to: 'ml-team@company.com,lead-engineer@company.com'
        subject: 'ğŸ“‰ Day Trade: EnsembleSystemç²¾åº¦ä½ä¸‹ - å³åº§å¯¾å¿œå¿…è¦'
        body: |
          Day Trade EnsembleSystemã®ç²¾åº¦ãŒ93%ç›®æ¨™ã‚’ä¸‹å›ã‚Šã¾ã—ãŸã€‚

          {{ range .Alerts }}
          è©³ç´°: {{ .Annotations.description }}
          ç™ºç”Ÿæ™‚åˆ»: {{ .StartsAt.Format "2006-01-02 15:04:05 JST" }}

          å¯¾å¿œã‚¢ã‚¯ã‚·ãƒ§ãƒ³:
          1. ãƒ¢ãƒ‡ãƒ«çŠ¶æ…‹ç¢ºèª
          2. ãƒ‡ãƒ¼ã‚¿å“è³ªæ¤œè¨¼
          3. å¿…è¦ã«å¿œã˜ã¦ãƒ¢ãƒ‡ãƒ«å†è¨“ç·´
          {{ if .Annotations.runbook_url }}

          è©³ç´°æ‰‹é †: {{ .Annotations.runbook_url }}
          {{ end }}
          {{ end }}

  # MLã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ©ãƒ¼ãƒˆ
  - name: 'ml-service-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#day-trade-ml'
        username: 'MLServiceMonitor'
        icon_emoji: ':robot_face:'
        title: 'ğŸ¤– ML Service Alert: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        text: |
          {{ range .Alerts }}
          *Service:* ML Service (EnsembleSystem)
          *Issue:* {{ .Annotations.summary }}
          *Details:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          *Time:* {{ .StartsAt.Format "2006-01-02 15:04:05 JST" }}
          {{ end }}

  # ãƒ‡ãƒ¼ã‚¿ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ©ãƒ¼ãƒˆ
  - name: 'data-service-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#day-trade-data'
        username: 'DataServiceMonitor'
        icon_emoji: ':bar_chart:'
        title: 'ğŸ“Š Data Service Alert: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        text: |
          {{ range .Alerts }}
          *Service:* Data Service (DataFetcher + SmartSymbolSelector)
          *Issue:* {{ .Annotations.summary }}
          *Details:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          *Time:* {{ .StartsAt.Format "2006-01-02 15:04:05 JST" }}
          {{ end }}

  # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã‚¢ãƒ©ãƒ¼ãƒˆ
  - name: 'scheduler-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#day-trade-scheduler'
        username: 'SchedulerMonitor'
        icon_emoji: ':calendar:'
        title: 'â° Scheduler Alert: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        text: |
          {{ range .Alerts }}
          *Service:* Scheduler Service (ExecutionScheduler)
          *Issue:* {{ .Annotations.summary }}
          *Details:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          *Time:* {{ .StartsAt.Format "2006-01-02 15:04:05 JST" }}
          {{ end }}

  # ã‚¤ãƒ³ãƒ•ãƒ©ã‚¢ãƒ©ãƒ¼ãƒˆ
  - name: 'infrastructure-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#day-trade-infra'
        username: 'InfraMonitor'
        icon_emoji: ':warning:'
        title: 'âš ï¸ Infrastructure Alert: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        text: |
          {{ range .Alerts }}
          *Component:* {{ .Labels.service }}
          *Issue:* {{ .Annotations.summary }}
          *Details:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          *Time:* {{ .StartsAt.Format "2006-01-02 15:04:05 JST" }}
          {{ end }}

  # ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚¢ãƒ©ãƒ¼ãƒˆ
  - name: 'business-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#day-trade-business'
        username: 'BusinessMonitor'
        icon_emoji: ':chart_with_upwards_trend:'
        title: 'ğŸ“ˆ Business Metrics Alert: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        text: |
          {{ range .Alerts }}
          *Metric:* {{ .Labels.component }}
          *Issue:* {{ .Annotations.summary }}
          *Details:* {{ .Annotations.description }}
          *Impact:* Business Operations
          *Time:* {{ .StartsAt.Format "2006-01-02 15:04:05 JST" }}
          {{ end }}

  # å–¶æ¥­æ™‚é–“å¤–ã‚¢ãƒ©ãƒ¼ãƒˆ
  - name: 'off-hours-alerts'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#day-trade-off-hours'
        username: 'OffHoursMonitor'
        icon_emoji: ':zzz:'
        title: 'ğŸ’¤ Off-Hours Alert: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        text: |
          å–¶æ¥­æ™‚é–“å¤–ã‚¢ãƒ©ãƒ¼ãƒˆ (ä½å„ªå…ˆåº¦)
          {{ range .Alerts }}
          *Issue:* {{ .Annotations.summary }}
          *Service:* {{ .Labels.service }}
          *Time:* {{ .StartsAt.Format "2006-01-02 15:04:05 JST" }}
          {{ end }}

# æŠ‘åˆ¶ãƒ«ãƒ¼ãƒ«
inhibit_rules:
  # ã‚µãƒ¼ãƒ“ã‚¹ãƒ€ã‚¦ãƒ³æ™‚ã¯ä»–ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶
  - source_match:
      alertname: 'MLServiceDown'
    target_match:
      service: 'ml-service'
    equal: ['instance']

  - source_match:
      alertname: 'DataServiceDown'
    target_match:
      service: 'data-service'
    equal: ['instance']

  - source_match:
      alertname: 'SchedulerServiceDown'
    target_match:
      service: 'scheduler-service'
    equal: ['instance']

  # Critical ã‚¢ãƒ©ãƒ¼ãƒˆç™ºç”Ÿæ™‚ã¯ warning ã‚’æŠ‘åˆ¶
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service', 'instance']

# æ™‚é–“é–“éš”è¨­å®š
time_intervals:
  # å–¶æ¥­æ™‚é–“å¤– (å¹³æ—¥18:00-9:00, åœŸæ—¥å…¨æ—¥)
  - name: off-hours
    time_intervals:
      - times:
          - start_time: '18:00'
            end_time: '23:59'
          - start_time: '00:00'
            end_time: '09:00'
        weekdays: ['monday:friday']
      - weekdays: ['saturday', 'sunday']

  # å¸‚å ´æ™‚é–“ (å¹³æ—¥9:00-15:00)
  - name: market-hours
    time_intervals:
      - times:
          - start_time: '09:00'
            end_time: '15:00'
        weekdays: ['monday:friday']