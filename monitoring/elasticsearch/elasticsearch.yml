# Issue #800 Phase 4: Elasticsearch設定
# Day Trade ML System ログストレージ・検索

cluster.name: day-trade-elasticsearch
node.name: day-trade-es-node

# ネットワーク設定
network.host: 0.0.0.0
http.port: 9200
transport.port: 9300

# パス設定
path.data: /usr/share/elasticsearch/data
path.logs: /usr/share/elasticsearch/logs

# Bootstrap設定
bootstrap.memory_lock: true

# Discovery設定 (単一ノード)
discovery.type: single-node

# セキュリティ設定
xpack.security.enabled: true
xpack.security.enrollment.enabled: false

# Basic認証設定
xpack.security.authc:
  anonymous:
    username: anonymous_user
    roles: monitoring
    authz_exception: true

# HTTP SSL設定 (本番環境)
xpack.security.http.ssl:
  enabled: false
  keystore.path: certs/http.p12

# 転送層SSL設定 (本番環境)
xpack.security.transport.ssl:
  enabled: false
  verification_mode: certificate
  keystore.path: certs/transport.p12
  truststore.path: certs/transport.p12

# 監視設定
xpack.monitoring.collection.enabled: true

# ML機能設定
xpack.ml.enabled: true

# インデックス設定
action.auto_create_index: .monitoring*,.watches,.triggered_watches,.watcher-history*,.ml*,day-trade-*

# ヒープ設定（JVM）
ES_JAVA_OPTS: "-Xms2g -Xmx2g"

# インデックステンプレート
index.number_of_shards: 1
index.number_of_replicas: 0

# ログレベル
logger.level: INFO

# スローログ設定
index.search.slowlog.threshold.query.warn: 10s
index.search.slowlog.threshold.query.info: 5s
index.search.slowlog.threshold.query.debug: 2s
index.search.slowlog.threshold.query.trace: 500ms

index.search.slowlog.threshold.fetch.warn: 1s
index.search.slowlog.threshold.fetch.info: 800ms
index.search.slowlog.threshold.fetch.debug: 500ms
index.search.slowlog.threshold.fetch.trace: 200ms

index.indexing.slowlog.threshold.index.warn: 10s
index.indexing.slowlog.threshold.index.info: 5s
index.indexing.slowlog.threshold.index.debug: 2s
index.indexing.slowlog.threshold.index.trace: 500ms

# キューサイズ
thread_pool.write.queue_size: 1000
thread_pool.search.queue_size: 1000

# リフレッシュ間隔
index.refresh_interval: 30s

# フラッシュ設定
index.translog.flush_threshold_size: 1gb
index.translog.sync_interval: 30s

# マージポリシー
index.merge.policy.max_merge_at_once: 10
index.merge.policy.segments_per_tier: 10

# フィールドデータキャッシュ
indices.fielddata.cache.size: 40%

# リクエストキャッシュ
indices.requests.cache.size: 2%

# 復旧設定
cluster.routing.allocation.enable: all
cluster.routing.allocation.allow_rebalance: indices_all_active
cluster.routing.allocation.cluster_concurrent_rebalance: 2
cluster.routing.allocation.node_concurrent_recoveries: 2
cluster.routing.allocation.node_initial_primaries_recoveries: 4

# タイムアウト設定
cluster.routing.allocation.node_concurrent_incoming_recoveries: 2
cluster.routing.allocation.node_concurrent_outgoing_recoveries: 2
cluster.routing.allocation.same_shard.host: false

# スナップショット設定
snapshot.max_restore_bytes_per_sec: 100mb
snapshot.max_snapshot_bytes_per_sec: 100mb

# サーキットブレーカー
indices.breaker.total.limit: 70%
indices.breaker.fielddata.limit: 40%
indices.breaker.request.limit: 40%

# 検索設定
search.max_buckets: 10000
search.default_search_timeout: 30s